'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = undefined;

var _create = require('babel-runtime/core-js/object/create');

var _create2 = _interopRequireDefault(_create);

var _assign = require('babel-runtime/core-js/object/assign');

var _assign2 = _interopRequireDefault(_assign);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _KnexOperation = require('./operations/KnexOperation');

var _KnexOperation2 = _interopRequireDefault(_KnexOperation);

var _QueryBuilderContextBase = require('./QueryBuilderContextBase');

var _QueryBuilderContextBase2 = _interopRequireDefault(_QueryBuilderContextBase);

var _classUtils = require('../utils/classUtils');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * Base functionality to be able to use query builder operation annotations.
 */

var QueryBuilderOperationSupport = function () {
  function QueryBuilderOperationSupport(knex, QueryBuilderContext) {
    (0, _classCallCheck3.default)(this, QueryBuilderOperationSupport);

    /**
     * @type {knex}
     * @protected
     */
    this._knex = knex;
    /**
     * @type {Array.<QueryBuilderOperation>}
     * @protected
     */
    this._operations = [];
    /**
     * @type {QueryBuilderContextBase}
     * @protected
     */
    this._context = new (QueryBuilderContext || _QueryBuilderContextBase2.default)(this._createUserContextBase());
  }

  /**
   * @param {function=} subclassConstructor
   * @return {Constructor.<QueryBuilderOperationSupport>}
   */


  QueryBuilderOperationSupport.extend = function extend(subclassConstructor) {
    (0, _classUtils.inherits)(subclassConstructor, this);
    return subclassConstructor;
  };

  /**
   * @param {Object=} ctx
   * @returns {Object|QueryBuilderOperationSupport}
   */


  QueryBuilderOperationSupport.prototype.context = function context(ctx) {
    if (arguments.length === 0) {
      return this._context.userContext;
    } else {
      var ctxBase = this._createUserContextBase();
      this._context.userContext = (0, _assign2.default)(ctxBase, ctx);
      return this;
    }
  };

  /**
   * @param {Object=} ctx
   * @returns {QueryBuilderOperationSupport}
   */


  QueryBuilderOperationSupport.prototype.mergeContext = function mergeContext(ctx) {
    var oldCtx = this._context.userContext;
    this._context.userContext = (0, _assign2.default)(oldCtx, ctx);
    return this;
  };

  /**
   * @param {QueryBuilderContextBase=} ctx
   * @returns {QueryBuilderContextBase|QueryBuilderOperationSupport}
   */


  QueryBuilderOperationSupport.prototype.internalContext = function internalContext(ctx) {
    if (arguments.length === 0) {
      return this._context;
    } else {
      this._context = ctx;
      return this;
    }
  };

  /**
   * @param {Object|InternalOptions} opt
   * @returns {InternalOptions|QueryBuilderOperationSupport}
   */


  QueryBuilderOperationSupport.prototype.internalOptions = function internalOptions(opt) {
    if (arguments.length === 0) {
      return this._context.options;
    } else {
      (0, _assign2.default)(this._context.options, opt);
      return this;
    }
  };

  /**
   * @param {knex=} knex
   * @returns {Object|QueryBuilderOperationSupport}
   */


  QueryBuilderOperationSupport.prototype.knex = function knex(_knex) {
    if (arguments.length === 0) {
      var knex = this._context.knex || this._knex;

      if (!knex) {
        throw new Error('no database connection available for a query for table ' + this.modelClass().tableName + '. ' + 'You need to bind the model class or the query to a knex instance.');
      }

      return knex;
    } else {
      this._knex = _knex;
      return this;
    }
  };

  /**
   * @param {RegExp|Constructor.<? extends QueryBuilderOperation>} operationSelector
   * @return {QueryBuilderBase}
   */


  QueryBuilderOperationSupport.prototype.clear = function clear(operationSelector) {
    var operations = [];

    this.forEachOperation(operationSelector, function (op) {
      operations.push(op);
    }, false);

    this._operations = operations;
    return this;
  };

  /**
   * @param {QueryBuilderBase} queryBuilder
   * @param {RegExp|Constructor.<? extends QueryBuilderOperation>} operationSelector
   * @return {QueryBuilderBase}
   */


  QueryBuilderOperationSupport.prototype.copyFrom = function copyFrom(queryBuilder, operationSelector) {
    var _this = this;

    queryBuilder.forEachOperation(operationSelector, function (op) {
      _this._operations.push(op);
    });

    return this;
  };

  /**
   * @param {RegExp|Constructor.<? extends QueryBuilderOperation>} operationSelector
   * @returns {boolean}
   */


  QueryBuilderOperationSupport.prototype.has = function has(operationSelector) {
    var found = false;

    this.forEachOperation(operationSelector, function () {
      found = true;
      return false;
    });

    return found;
  };

  /**
   * @param {RegExp|Constructor.<? extends QueryBuilderOperation>} operationSelector
   * @returns {boolean}
   */


  QueryBuilderOperationSupport.prototype.indexOfOperation = function indexOfOperation(operationSelector) {
    var idx = -1;

    this.forEachOperation(operationSelector, function (op, i) {
      idx = i;
      return false;
    });

    return idx;
  };

  /**
   * @param {RegExp|Constructor.<? extends QueryBuilderOperation>} operationSelector
   * @param {function(QueryBuilderOperation)} callback
   * @param {boolean} match
   * @returns {QueryBuilderBase}
   */


  QueryBuilderOperationSupport.prototype.forEachOperation = function forEachOperation(operationSelector, callback) {
    var match = arguments.length > 2 && arguments[2] !== undefined ? arguments[2] : true;

    if (operationSelector instanceof RegExp) {
      this._forEachOperationRegex(operationSelector, callback, match);
    } else {
      this._forEachOperationInstanceOf(operationSelector, callback, match);
    }

    return this;
  };

  /**
   * @param {QueryBuilderOperation} operation
   * @param {Array.<*>} args
   * @param {Boolean=} pushFront
   * @returns {QueryBuilderOperationSupport}
   */


  QueryBuilderOperationSupport.prototype.callQueryBuilderOperation = function callQueryBuilderOperation(operation, args, pushFront) {
    if (operation.call(this, args || [])) {
      if (pushFront) {
        this._operations.unshift(operation);
      } else {
        this._operations.push(operation);
      }
    }

    return this;
  };

  /**
   * @param {string} methodName
   * @param {Array.<*>} args
   * @param {boolean=} pushFront
   * @returns {QueryBuilderOperationSupport}
   */


  QueryBuilderOperationSupport.prototype.callKnexQueryBuilderOperation = function callKnexQueryBuilderOperation(methodName, args, pushFront) {
    return this.callQueryBuilderOperation(new _KnexOperation2.default(methodName), args, pushFront);
  };

  /**
   * @returns {QueryBuilderOperationSupport}
   */


  QueryBuilderOperationSupport.prototype.clone = function clone() {
    return this.baseCloneInto(new this.constructor(this.knex()));
  };

  /**
   * @protected
   * @returns {QueryBuilderOperationSupport}
   */


  QueryBuilderOperationSupport.prototype.baseCloneInto = function baseCloneInto(builder) {
    builder._knex = this._knex;
    builder._operations = this._operations.slice();
    builder._context = this._context.clone();

    return builder;
  };

  /**
   * @returns {knex.QueryBuilder}
   */


  QueryBuilderOperationSupport.prototype.build = function build() {
    return this.buildInto(this.knex().queryBuilder());
  };

  /**
   * @protected
   */


  QueryBuilderOperationSupport.prototype.buildInto = function buildInto(knexBuilder) {
    var tmp = new Array(10);

    var i = 0;
    while (i < this._operations.length) {
      var op = this._operations[i];
      var ln = this._operations.length;

      op.onBeforeBuild(this);

      var numNew = this._operations.length - ln;

      // onBeforeBuild may call methods that add more operations. If
      // this was the case, move the operations to be executed next.
      if (numNew > 0) {
        while (tmp.length < numNew) {
          tmp.push(null);
        }

        // Copy the new operations to tmp.
        for (var j = 0; j < numNew; ++j) {
          tmp[j] = this._operations[ln + j];
        }

        // Make room for the new operations after the current operation.
        for (var _j = ln + numNew - 1; _j > i + numNew; --_j) {
          this._operations[_j] = this._operations[_j - numNew];
        }

        // Move the new operations after the current operation.
        for (var _j2 = 0; _j2 < numNew; ++_j2) {
          this._operations[i + _j2 + 1] = tmp[_j2];
        }
      }

      ++i;
    }

    // onBuild operations should never add new operations. They should only call
    // methods on the knex query builder.
    for (var _i = 0, l = this._operations.length; _i < l; ++_i) {
      this._operations[_i].onBuild(knexBuilder, this);

      if (this._operations.length !== l) {
        throw new Error('onBuild should only call query building methods on the knex builder');
      }
    }

    return knexBuilder;
  };

  /**
   * @returns {string}
   */


  QueryBuilderOperationSupport.prototype.toString = function toString() {
    return this.build().toString();
  };

  /**
   * @returns {string}
   */


  QueryBuilderOperationSupport.prototype.toSql = function toSql() {
    return this.toString();
  };

  /**
   * @returns {QueryBuilderOperationSupport}
   */


  QueryBuilderOperationSupport.prototype.skipUndefined = function skipUndefined() {
    this._context.options.skipUndefined = true;
    return this;
  };

  /**
   * @private
   */


  QueryBuilderOperationSupport.prototype._createUserContextBase = function _createUserContextBase() {
    var _this2 = this;

    var ctxProto = {};

    Object.defineProperty(ctxProto, 'transaction', {
      enumerable: false,
      get: function get() {
        return _this2.knex();
      }
    });

    return (0, _create2.default)(ctxProto);
  };

  /**
   * @private
   */


  QueryBuilderOperationSupport.prototype._forEachOperationRegex = function _forEachOperationRegex(operationSelector, callback, match) {
    for (var i = 0, l = this._operations.length; i < l; ++i) {
      var op = this._operations[i];

      if (operationSelector.test(op.name) === match) {
        if (callback(op, i) === false) {
          break;
        }
      }
    }
  };

  /**
   * @private
   */


  QueryBuilderOperationSupport.prototype._forEachOperationInstanceOf = function _forEachOperationInstanceOf(operationSelector, callback, match) {
    for (var i = 0, l = this._operations.length; i < l; ++i) {
      var op = this._operations[i];

      if (op instanceof operationSelector === match) {
        if (callback(op, i) === false) {
          break;
        }
      }
    }
  };

  return QueryBuilderOperationSupport;
}();

exports.default = QueryBuilderOperationSupport;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlF1ZXJ5QnVpbGRlck9wZXJhdGlvblN1cHBvcnQuanMiXSwibmFtZXMiOlsiUXVlcnlCdWlsZGVyT3BlcmF0aW9uU3VwcG9ydCIsImtuZXgiLCJRdWVyeUJ1aWxkZXJDb250ZXh0IiwiX2tuZXgiLCJfb3BlcmF0aW9ucyIsIl9jb250ZXh0IiwiX2NyZWF0ZVVzZXJDb250ZXh0QmFzZSIsImV4dGVuZCIsInN1YmNsYXNzQ29uc3RydWN0b3IiLCJjb250ZXh0IiwiY3R4IiwiYXJndW1lbnRzIiwibGVuZ3RoIiwidXNlckNvbnRleHQiLCJjdHhCYXNlIiwibWVyZ2VDb250ZXh0Iiwib2xkQ3R4IiwiaW50ZXJuYWxDb250ZXh0IiwiaW50ZXJuYWxPcHRpb25zIiwib3B0Iiwib3B0aW9ucyIsIkVycm9yIiwibW9kZWxDbGFzcyIsInRhYmxlTmFtZSIsImNsZWFyIiwib3BlcmF0aW9uU2VsZWN0b3IiLCJvcGVyYXRpb25zIiwiZm9yRWFjaE9wZXJhdGlvbiIsIm9wIiwicHVzaCIsImNvcHlGcm9tIiwicXVlcnlCdWlsZGVyIiwiaGFzIiwiZm91bmQiLCJpbmRleE9mT3BlcmF0aW9uIiwiaWR4IiwiaSIsImNhbGxiYWNrIiwibWF0Y2giLCJSZWdFeHAiLCJfZm9yRWFjaE9wZXJhdGlvblJlZ2V4IiwiX2ZvckVhY2hPcGVyYXRpb25JbnN0YW5jZU9mIiwiY2FsbFF1ZXJ5QnVpbGRlck9wZXJhdGlvbiIsIm9wZXJhdGlvbiIsImFyZ3MiLCJwdXNoRnJvbnQiLCJjYWxsIiwidW5zaGlmdCIsImNhbGxLbmV4UXVlcnlCdWlsZGVyT3BlcmF0aW9uIiwibWV0aG9kTmFtZSIsImNsb25lIiwiYmFzZUNsb25lSW50byIsImNvbnN0cnVjdG9yIiwiYnVpbGRlciIsInNsaWNlIiwiYnVpbGQiLCJidWlsZEludG8iLCJrbmV4QnVpbGRlciIsInRtcCIsIkFycmF5IiwibG4iLCJvbkJlZm9yZUJ1aWxkIiwibnVtTmV3IiwiaiIsImwiLCJvbkJ1aWxkIiwidG9TdHJpbmciLCJ0b1NxbCIsInNraXBVbmRlZmluZWQiLCJjdHhQcm90byIsIk9iamVjdCIsImRlZmluZVByb3BlcnR5IiwiZW51bWVyYWJsZSIsImdldCIsInRlc3QiLCJuYW1lIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7Ozs7QUFDQTs7OztBQUNBOzs7O0FBRUE7Ozs7SUFJcUJBLDRCO0FBRW5CLHdDQUFZQyxJQUFaLEVBQWtCQyxtQkFBbEIsRUFBdUM7QUFBQTs7QUFDckM7Ozs7QUFJQSxTQUFLQyxLQUFMLEdBQWFGLElBQWI7QUFDQTs7OztBQUlBLFNBQUtHLFdBQUwsR0FBbUIsRUFBbkI7QUFDQTs7OztBQUlBLFNBQUtDLFFBQUwsR0FBZ0IsS0FBS0gsd0RBQUwsRUFBcUQsS0FBS0ksc0JBQUwsRUFBckQsQ0FBaEI7QUFDRDs7QUFFRDs7Ozs7OytCQUlPQyxNLG1CQUFPQyxtQixFQUFxQjtBQUNqQyw4QkFBU0EsbUJBQVQsRUFBOEIsSUFBOUI7QUFDQSxXQUFPQSxtQkFBUDtBQUNELEc7O0FBRUQ7Ozs7Ozt5Q0FJQUMsTyxvQkFBUUMsRyxFQUFLO0FBQ1gsUUFBSUMsVUFBVUMsTUFBVixLQUFxQixDQUF6QixFQUE0QjtBQUMxQixhQUFPLEtBQUtQLFFBQUwsQ0FBY1EsV0FBckI7QUFDRCxLQUZELE1BRU87QUFDTCxVQUFNQyxVQUFVLEtBQUtSLHNCQUFMLEVBQWhCO0FBQ0EsV0FBS0QsUUFBTCxDQUFjUSxXQUFkLEdBQTRCLHNCQUFjQyxPQUFkLEVBQXVCSixHQUF2QixDQUE1QjtBQUNBLGFBQU8sSUFBUDtBQUNEO0FBQ0YsRzs7QUFFRDs7Ozs7O3lDQUlBSyxZLHlCQUFhTCxHLEVBQUs7QUFDaEIsUUFBTU0sU0FBUyxLQUFLWCxRQUFMLENBQWNRLFdBQTdCO0FBQ0EsU0FBS1IsUUFBTCxDQUFjUSxXQUFkLEdBQTRCLHNCQUFjRyxNQUFkLEVBQXNCTixHQUF0QixDQUE1QjtBQUNBLFdBQU8sSUFBUDtBQUNELEc7O0FBRUQ7Ozs7Ozt5Q0FJQU8sZSw0QkFBZ0JQLEcsRUFBSztBQUNuQixRQUFJ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WUFBSUQsU0FBU1QsRUFBVCxFQUFhUSxDQUFiLE1BQW9CLEtBQXhCLEVBQStCO0FBQzdCO0FBQ0Q7QUFDRjtBQUNGO0FBQ0YsRzs7QUFFRDs7Ozs7eUNBR0FLLDJCLHdDQUE0QmhCLGlCLEVBQW1CWSxRLEVBQVVDLEssRUFBTztBQUM5RCxTQUFLLElBQUlGLElBQUksQ0FBUixFQUFXNEIsSUFBSSxLQUFLNUQsV0FBTCxDQUFpQlEsTUFBckMsRUFBNkN3QixJQUFJNEIsQ0FBakQsRUFBb0QsRUFBRTVCLENBQXRELEVBQXlEO0FBQ3ZELFVBQU1SLEtBQUssS0FBS3hCLFdBQUwsQ0FBaUJnQyxDQUFqQixDQUFYOztBQUVBLFVBQUtSLGNBQWNILGlCQUFmLEtBQXNDYSxLQUExQyxFQUFpRDtBQUMvQyxZQUFJRCxTQUFTVCxFQUFULEVBQWFRLENBQWIsTUFBb0IsS0FBeEIsRUFBK0I7QUFDN0I7QUFDRDtBQUNGO0FBQ0Y7QUFDRixHOzs7OztrQkExVmtCcEMsNEIiLCJmaWxlIjoiUXVlcnlCdWlsZGVyT3BlcmF0aW9uU3VwcG9ydC5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBLbmV4T3BlcmF0aW9uIGZyb20gJy4vb3BlcmF0aW9ucy9LbmV4T3BlcmF0aW9uJztcbmltcG9ydCBRdWVyeUJ1aWxkZXJDb250ZXh0QmFzZSBmcm9tICcuL1F1ZXJ5QnVpbGRlckNvbnRleHRCYXNlJztcbmltcG9ydCB7aW5oZXJpdHN9IGZyb20gJy4uL3V0aWxzL2NsYXNzVXRpbHMnO1xuXG4vKipcbiAqIEJhc2UgZnVuY3Rpb25hbGl0eSB0byBiZSBhYmxlIHRvIHVzZSBxdWVyeSBidWlsZGVyIG9wZXJhdGlvbiBhbm5vdGF0aW9ucy5cbiAqL1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBRdWVyeUJ1aWxkZXJPcGVyYXRpb25TdXBwb3J0IHtcblxuICBjb25zdHJ1Y3RvcihrbmV4LCBRdWVyeUJ1aWxkZXJDb250ZXh0KSB7XG4gICAgLyoqXG4gICAgICogQHR5cGUge2tuZXh9XG4gICAgICogQHByb3RlY3RlZFxuICAgICAqL1xuICAgIHRoaXMuX2tuZXggPSBrbmV4O1xuICAgIC8qKlxuICAgICAqIEB0eXBlIHtBcnJheS48UXVlcnlCdWlsZGVyT3BlcmF0aW9uPn1cbiAgICAgKiBAcHJvdGVjdGVkXG4gICAgICovXG4gICAgdGhpcy5fb3BlcmF0aW9ucyA9IFtdO1xuICAgIC8qKlxuICAgICAqIEB0eXBlIHtRdWVyeUJ1aWxkZXJDb250ZXh0QmFzZX1cbiAgICAgKiBAcHJvdGVjdGVkXG4gICAgICovXG4gICAgdGhpcy5fY29udGV4dCA9IG5ldyAoUXVlcnlCdWlsZGVyQ29udGV4dCB8fCBRdWVyeUJ1aWxkZXJDb250ZXh0QmFzZSkodGhpcy5fY3JlYXRlVXNlckNvbnRleHRCYXNlKCkpO1xuICB9XG5cbiAgLyoqXG4gICAqIEBwYXJhbSB7ZnVuY3Rpb249fSBzdWJjbGFzc0NvbnN0cnVjdG9yXG4gICAqIEByZXR1cm4ge0NvbnN0cnVjdG9yLjxRdWVyeUJ1aWxkZXJPcGVyYXRpb25TdXBwb3J0Pn1cbiAgICovXG4gIHN0YXRpYyBleHRlbmQoc3ViY2xhc3NDb25zdHJ1Y3Rvcikge1xuICAgIGluaGVyaXRzKHN1YmNsYXNzQ29uc3RydWN0b3IsIHRoaXMpO1xuICAgIHJldHVybiBzdWJjbGFzc0NvbnN0cnVjdG9yO1xuICB9XG5cbiAgLyoqXG4gICAqIEBwYXJhbSB7T2JqZWN0PX0gY3R4XG4gICAqIEByZXR1cm5zIHtPYmplY3R8UXVlcnlCdWlsZGVyT3BlcmF0aW9uU3VwcG9ydH1cbiAgICovXG4gIGNvbnRleHQoY3R4KSB7XG4gICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybiB0aGlzLl9jb250ZXh0LnVzZXJDb250ZXh0O1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zdCBjdHhCYXNlID0gdGhpcy5fY3JlYXRlVXNlckNvbnRleHRCYXNlKCk7XG4gICAgICB0aGlzLl9jb250ZXh0LnVzZXJDb250ZXh0ID0gT2JqZWN0LmFzc2lnbihjdHhCYXNlLCBjdHgpO1xuICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEBwYXJhbSB7T2JqZWN0PX0gY3R4XG4gICAqIEByZXR1cm5zIHtRdWVyeUJ1aWxkZXJPcGVyYXRpb25TdXBwb3J0fVxuICAgKi9cbiAgbWVyZ2VDb250ZXh0KGN0eCkge1xuICAgIGNvbnN0IG9sZEN0eCA9IHRoaXMuX2NvbnRleHQudXNlckNvbnRleHQ7XG4gICAgdGhpcy5fY29udGV4dC51c2VyQ29udGV4dCA9IE9iamVjdC5hc3NpZ24ob2xkQ3R4LCBjdHgpO1xuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgLyoqXG4gICAqIEBwYXJhbSB7UXVlcnlCdWlsZGVyQ29udGV4dEJhc2U9fSBjdHhcbiAgICogQHJldHVybnMge1F1ZXJ5QnVpbGRlckNvbnRleHRCYXNlfFF1ZXJ5QnVpbGRlck9wZXJhdGlvblN1cHBvcnR9XG4gICAqL1xuICBpbnRlcm5hbENvbnRleHQoY3R4KSB7XG4gICAgaWYgKGFyZ3VtZW50cy5sZW5ndGggPT09IDApIHtcbiAgICAgIHJldHVybiB0aGlzLl9jb250ZXh0O1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLl9jb250ZXh0ID0gY3R4O1xuICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEBwYXJhbSB7T2JqZWN0fEludGVybmFsT3B0aW9uc30gb3B0XG4gICAqIEByZXR1cm5zIHtJbnRlcm5hbE9wdGlvbnN8UXVlcnlCdWlsZGVyT3BlcmF0aW9uU3VwcG9ydH1cbiAgICovXG4gIGludGVybmFsT3B0aW9ucyhvcHQpIHtcbiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgcmV0dXJuIHRoaXMuX2NvbnRleHQub3B0aW9ucztcbiAgICB9IGVsc2Uge1xuICAgICAgT2JqZWN0LmFzc2lnbih0aGlzLl9jb250ZXh0Lm9wdGlvbnMsIG9wdCk7XG4gICAgICByZXR1cm4gdGhpcztcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQHBhcmFtIHtrbmV4PX0ga25leFxuICAgKiBAcmV0dXJucyB7T2JqZWN0fFF1ZXJ5QnVpbGRlck9wZXJhdGlvblN1cHBvcnR9XG4gICAqL1xuICBrbmV4KGtuZXgpIHtcbiAgICBpZiAoYXJndW1lbnRzLmxlbmd0aCA9PT0gMCkge1xuICAgICAgY29uc3Qga25leCA9IHRoaXMuX2NvbnRleHQua25leCB8fCB0aGlzLl9rbmV4O1xuXG4gICAgICBpZiAoIWtuZXgpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKFxuICAgICAgICAgIGBubyBkYXRhYmFzZSBjb25uZWN0aW9uIGF2YWlsYWJsZSBmb3IgYSBxdWVyeSBmb3IgdGFibGUgJHt0aGlzLm1vZGVsQ2xhc3MoKS50YWJsZU5hbWV9LiBgICtcbiAgICAgICAgICBgWW91IG5lZWQgdG8gYmluZCB0aGUgbW9kZWwgY2xhc3Mgb3IgdGhlIHF1ZXJ5IHRvIGEga25leCBpbnN0YW5jZS5gKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGtuZXg7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMuX2tuZXggPSBrbmV4O1xuICAgICAgcmV0dXJuIHRoaXM7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEBwYXJhbSB7UmVnRXhwfENvbnN0cnVjdG9yLjw/IGV4dGVuZHMgUXVlcnlCdWlsZGVyT3BlcmF0aW9uPn0gb3BlcmF0aW9uU2VsZWN0b3JcbiAgICogQHJldHVybiB7UXVlcnlCdWlsZGVyQmFzZX1cbiAgICovXG4gIGNsZWFyKG9wZXJhdGlvblNlbGVjdG9yKSB7XG4gICAgY29uc3Qgb3BlcmF0aW9ucyA9IFtdO1xuXG4gICAgdGhpcy5mb3JFYWNoT3BlcmF0aW9uKG9wZXJhdGlvblNlbGVjdG9yLCAob3ApID0+IHtcbiAgICAgIG9wZXJhdGlvbnMucHVzaChvcCk7XG4gICAgfSwgZmFsc2UpO1xuXG4gICAgdGhpcy5fb3BlcmF0aW9ucyA9IG9wZXJhdGlvbnM7XG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICAvKipcbiAgICogQHBhcmFtIHtRdWVyeUJ1aWxkZXJCYXNlfSBxdWVyeUJ1aWxkZXJcbiAgICogQHBhcmFtIHtSZWdFeHB8Q29uc3RydWN0b3IuPD8gZXh0ZW5kcyBRdWVyeUJ1aWxkZXJPcGVyYXRpb24+fSBvcGVyYXRpb25TZWxlY3RvclxuICAgKiBAcmV0dXJuIHtRdWVyeUJ1aWxkZXJCYXNlfVxuICAgKi9cbiAgY29weUZyb20ocXVlcnlCdWlsZGVyLCBvcGVyYXRpb25TZWxlY3Rvcikge1xuICAgIHF1ZXJ5QnVpbGRlci5mb3JFYWNoT3BlcmF0aW9uKG9wZXJhdGlvblNlbGVjdG9yLCAob3ApID0+IHtcbiAgICAgIHRoaXMuX29wZXJhdGlvbnMucHVzaChvcCk7XG4gICAgfSk7XG5cbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIC8qKlxuICAgKiBAcGFyYW0ge1JlZ0V4cHxDb25zdHJ1Y3Rvci48PyBleHRlbmRzIFF1ZXJ5QnVpbGRlck9wZXJhdGlvbj59IG9wZXJhdGlvblNlbGVjdG9yXG4gICAqIEByZXR1cm5zIHtib29sZWFufVxuICAgKi9cbiAgaGFzKG9wZXJhdGlvblNlbGVjdG9yKSB7XG4gICAgbGV0IGZvdW5kID0gZmFsc2U7XG5cbiAgICB0aGlzLmZvckVhY2hPcGVyYXRpb24ob3BlcmF0aW9uU2VsZWN0b3IsICgpID0+IHtcbiAgICAgIGZvdW5kID0gdHJ1ZTtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9KTtcblxuICAgIHJldHVybiBmb3VuZDtcbiAgfVxuXG4gIC8qKlxuICAgKiBAcGFyYW0ge1JlZ0V4cHxDb25zdHJ1Y3Rvci48PyBleHRlbmRzIFF1ZXJ5QnVpbGRlck9wZXJhdGlvbj59IG9wZXJhdGlvblNlbGVjdG9yXG4gICAqIEByZXR1cm5zIHtib29sZWFufVxuICAgKi9cbiAgaW5kZXhPZk9wZXJhdGlvbihvcGVyYXRpb25TZWxlY3Rvcikge1xuICAgIGxldCBpZHggPSAtMTtcblxuICAgIHRoaXMuZm9yRWFjaE9wZXJhdGlvbihvcGVyYXRpb25TZWxlY3RvciwgKG9wLCBpKSA9PiB7XG4gICAgICBpZHggPSBpO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH0pO1xuXG4gICAgcmV0dXJuIGlkeDtcbiAgfVxuXG4gIC8qKlxuICAgKiBAcGFyYW0ge1JlZ0V4cHxDb25zdHJ1Y3Rvci48PyBleHRlbmRzIFF1ZXJ5QnVpbGRlck9wZXJhdGlvbj59IG9wZXJhdGlvblNlbGVjdG9yXG4gICAqIEBwYXJhbSB7ZnVuY3Rpb24oUXVlcnlCdWlsZGVyT3BlcmF0aW9uKX0gY2FsbGJhY2tcbiAgICogQHBhcmFtIHtib29sZWFufSBtYXRjaFxuICAgKiBAcmV0dXJucyB7UXVlcnlCdWlsZGVyQmFzZX1cbiAgICovXG4gIGZvckVhY2hPcGVyYXRpb24ob3BlcmF0aW9uU2VsZWN0b3IsIGNhbGxiYWNrLCBtYXRjaCA9IHRydWUpIHtcbiAgICBpZiAob3BlcmF0aW9uU2VsZWN0b3IgaW5zdGFuY2VvZiBSZWdFeHApIHtcbiAgICAgIHRoaXMuX2ZvckVhY2hPcGVyYXRpb25SZWdleChvcGVyYXRpb25TZWxlY3RvciwgY2FsbGJhY2ssIG1hdGNoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5fZm9yRWFjaE9wZXJhdGlvbkluc3RhbmNlT2Yob3BlcmF0aW9uU2VsZWN0b3IsIGNhbGxiYWNrLCBtYXRjaCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXM7XG4gIH1cblxuICAvKipcbiAgICogQHBhcmFtIHtRdWVyeUJ1aWxkZXJPcGVyYXRpb259IG9wZXJhdGlvblxuICAgKiBAcGFyYW0ge0FycmF5LjwqPn0gYXJnc1xuICAgKiBAcGFyYW0ge0Jvb2xlYW49fSBwdXNoRnJvbnRcbiAgICogQHJldHVybnMge1F1ZXJ5QnVpbGRlck9wZXJhdGlvblN1cHBvcnR9XG4gICAqL1xuICAgY2FsbFF1ZXJ5QnVpbGRlck9wZXJhdGlvbihvcGVyYXRpb24sIGFyZ3MsIHB1c2hGcm9udCkge1xuICAgIGlmIChvcGVyYXRpb24uY2FsbCh0aGlzLCBhcmdzIHx8IFtdKSkge1xuICAgICAgaWYgKHB1c2hGcm9udCkge1xuICAgICAgICB0aGlzLl9vcGVyYXRpb25zLnVuc2hpZnQob3BlcmF0aW9uKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMuX29wZXJhdGlvbnMucHVzaChvcGVyYXRpb24pO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiB0aGlzO1xuICB9XG5cbiAgLyoqXG4gICAqIEBwYXJhbSB7c3RyaW5nfSBtZXRob2ROYW1lXG4gICAqIEBwYXJhbSB7QXJyYXkuPCo+fSBhcmdzXG4gICAqIEBwYXJhbSB7Ym9vbGVhbj19IHB1c2hGcm9udFxuICAgKiBAcmV0dXJucyB7UXVlcnlCdWlsZGVyT3BlcmF0aW9uU3VwcG9ydH1cbiAgICovXG4gIGNhbGxLbmV4UXVlcnlCdWlsZGVyT3BlcmF0aW9uKG1ldGhvZE5hbWUsIGFyZ3MsIHB1c2hGcm9udCkge1xuICAgIHJldHVybiB0aGlzLmNhbGxRdWVyeUJ1aWxkZXJPcGVyYXRpb24obmV3IEtuZXhPcGVyYXRpb24obWV0aG9kTmFtZSksIGFyZ3MsIHB1c2hGcm9udCk7XG4gIH1cblxuICAvKipcbiAgICogQHJldHVybnMge1F1ZXJ5QnVpbGRlck9wZXJhdGlvblN1cHBvcnR9XG4gICAqL1xuICBjbG9uZSgpIHtcbiAgICByZXR1cm4gdGhpcy5iYXNlQ2xvbmVJbnRvKG5ldyB0aGlzLmNvbnN0cnVjdG9yKHRoaXMua25leCgpKSk7XG4gIH1cblxuICAvKipcbiAgICogQHByb3RlY3RlZFxuICAgKiBAcmV0dXJucyB7UXVlcnlCdWlsZGVyT3BlcmF0aW9uU3VwcG9ydH1cbiAgICovXG4gIGJhc2VDbG9uZUludG8oYnVpbGRlcikge1xuICAgIGJ1aWxkZXIuX2tuZXggPSB0aGlzLl9rbmV4O1xuICAgIGJ1aWxkZXIuX29wZXJhdGlvbnMgPSB0aGlzLl9vcGVyYXRpb25zLnNsaWNlKCk7XG4gICAgYnVpbGRlci5fY29udGV4dCA9IHRoaXMuX2NvbnRleHQuY2xvbmUoKTtcblxuICAgIHJldHVybiBidWlsZGVyO1xuICB9XG5cbiAgLyoqXG4gICAqIEByZXR1cm5zIHtrbmV4LlF1ZXJ5QnVpbGRlcn1cbiAgICovXG4gIGJ1aWxkKCkge1xuICAgIHJldHVybiB0aGlzLmJ1aWxkSW50byh0aGlzLmtuZXgoKS5xdWVyeUJ1aWxkZXIoKSk7XG4gIH1cblxuICAvKipcbiAgICogQHByb3RlY3RlZFxuICAgKi9cbiAgYnVpbGRJbnRvKGtuZXhCdWlsZGVyKSB7XG4gICAgY29uc3QgdG1wID0gbmV3IEFycmF5KDEwKTtcblxuICAgIGxldCBpID0gMDtcbiAgICB3aGlsZSAoaSA8IHRoaXMuX29wZXJhdGlvbnMubGVuZ3RoKSB7XG4gICAgICBjb25zdCBvcCA9IHRoaXMuX29wZXJhdGlvbnNbaV07XG4gICAgICBjb25zdCBsbiA9IHRoaXMuX29wZXJhdGlvbnMubGVuZ3RoO1xuXG4gICAgICBvcC5vbkJlZm9yZUJ1aWxkKHRoaXMpO1xuXG4gICAgICBjb25zdCBudW1OZXcgPSB0aGlzLl9vcGVyYXRpb25zLmxlbmd0aCAtIGxuO1xuXG4gICAgICAvLyBvbkJlZm9yZUJ1aWxkIG1heSBjYWxsIG1ldGhvZHMgdGhhdCBhZGQgbW9yZSBvcGVyYXRpb25zLiBJZlxuICAgICAgLy8gdGhpcyB3YXMgdGhlIGNhc2UsIG1vdmUgdGhlIG9wZXJhdGlvbnMgdG8gYmUgZXhlY3V0ZWQgbmV4dC5cbiAgICAgIGlmIChudW1OZXcgPiAwKSB7XG4gICAgICAgIHdoaWxlICh0bXAubGVuZ3RoIDwgbnVtTmV3KSB7XG4gICAgICAgICAgdG1wLnB1c2gobnVsbCk7XG4gICAgICAgIH1cblxuICAgICAgICAvLyBDb3B5IHRoZSBuZXcgb3BlcmF0aW9ucyB0byB0bXAuXG4gICAgICAgIGZvciAobGV0IGogPSAwOyBqIDwgbnVtTmV3OyArK2opIHtcbiAgICAgICAgICB0bXBbal0gPSB0aGlzLl9vcGVyYXRpb25zW2xuICsgal07XG4gICAgICAgIH1cblxuICAgICAgICAvLyBNYWtlIHJvb20gZm9yIHRoZSBuZXcgb3BlcmF0aW9ucyBhZnRlciB0aGUgY3VycmVudCBvcGVyYXRpb24uXG4gICAgICAgIGZvciAobGV0IGogPSBsbiArIG51bU5ldyAtIDE7IGogPiBpICsgbnVtTmV3OyAtLWopIHtcbiAgICAgICAgICB0aGlzLl9vcGVyYXRpb25zW2pdID0gdGhpcy5fb3BlcmF0aW9uc1tqIC0gbnVtTmV3XTtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIE1vdmUgdGhlIG5ldyBvcGVyYXRpb25zIGFmdGVyIHRoZSBjdXJyZW50IG9wZXJhdGlvbi5cbiAgICAgICAgZm9yIChsZXQgaiA9IDA7IGogPCBudW1OZXc7ICsraikge1xuICAgICAgICAgIHRoaXMuX29wZXJhdGlvbnNbaSArIGogKyAxXSA9IHRtcFtqXTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICArK2k7XG4gICAgfVxuXG4gICAgLy8gb25CdWlsZCBvcGVyYXRpb25zIHNob3VsZCBuZXZlciBhZGQgbmV3IG9wZXJhdGlvbnMuIFRoZXkgc2hvdWxkIG9ubHkgY2FsbFxuICAgIC8vIG1ldGhvZHMgb24gdGhlIGtuZXggcXVlcnkgYnVpbGRlci5cbiAgICBmb3IgKGxldCBpID0gMCwgbCA9IHRoaXMuX29wZXJhdGlvbnMubGVuZ3RoOyBpIDwgbDsgKytpKSB7XG4gICAgICB0aGlzLl9vcGVyYXRpb25zW2ldLm9uQnVpbGQoa25leEJ1aWxkZXIsIHRoaXMpO1xuXG4gICAgICBpZiAodGhpcy5fb3BlcmF0aW9ucy5sZW5ndGggIT09IGwpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdvbkJ1aWxkIHNob3VsZCBvbmx5IGNhbGwgcXVlcnkgYnVpbGRpbmcgbWV0aG9kcyBvbiB0aGUga25leCBidWlsZGVyJyk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGtuZXhCdWlsZGVyO1xuICB9XG5cbiAgLyoqXG4gICAqIEByZXR1cm5zIHtzdHJpbmd9XG4gICAqL1xuICB0b1N0cmluZygpIHtcbiAgICByZXR1cm4gdGhpcy5idWlsZCgpLnRvU3RyaW5nKCk7XG4gIH1cblxuICAvKipcbiAgICogQHJldHVybnMge3N0cmluZ31cbiAgICovXG4gIHRvU3FsKCkge1xuICAgIHJldHVybiB0aGlzLnRvU3RyaW5nKCk7XG4gIH1cblxuICAvKipcbiAgICogQHJldHVybnMge1F1ZXJ5QnVpbGRlck9wZXJhdGlvblN1cHBvcnR9XG4gICAqL1xuICBza2lwVW5kZWZpbmVkKCkge1xuICAgIHRoaXMuX2NvbnRleHQub3B0aW9ucy5za2lwVW5kZWZpbmVkID0gdHJ1ZTtcbiAgICByZXR1cm4gdGhpcztcbiAgfVxuXG4gIC8qKlxuICAgKiBAcHJpdmF0ZVxuICAgKi9cbiAgX2NyZWF0ZVVzZXJDb250ZXh0QmFzZSgpIHtcbiAgICBjb25zdCBjdHhQcm90byA9IHt9O1xuXG4gICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KGN0eFByb3RvLCAndHJhbnNhY3Rpb24nLCB7XG4gICAgICBlbnVtZXJhYmxlOiBmYWxzZSxcbiAgICAgIGdldDogKCkgPT4gdGhpcy5rbmV4KClcbiAgICB9KTtcblxuICAgIHJldHVybiBPYmplY3QuY3JlYXRlKGN0eFByb3RvKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBAcHJpdmF0ZVxuICAgKi9cbiAgX2ZvckVhY2hPcGVyYXRpb25SZWdleChvcGVyYXRpb25TZWxlY3RvciwgY2FsbGJhY2ssIG1hdGNoKSB7XG4gICAgZm9yIChsZXQgaSA9IDAsIGwgPSB0aGlzLl9vcGVyYXRpb25zLmxlbmd0aDsgaSA8IGw7ICsraSkge1xuICAgICAgY29uc3Qgb3AgPSB0aGlzLl9vcGVyYXRpb25zW2ldO1xuXG4gICAgICBpZiAob3BlcmF0aW9uU2VsZWN0b3IudGVzdChvcC5uYW1lKSA9PT0gbWF0Y2gpIHtcbiAgICAgICAgaWYgKGNhbGxiYWNrKG9wLCBpKSA9PT0gZmFsc2UpIHtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBAcHJpdmF0ZVxuICAgKi9cbiAgX2ZvckVhY2hPcGVyYXRpb25JbnN0YW5jZU9mKG9wZXJhdGlvblNlbGVjdG9yLCBjYWxsYmFjaywgbWF0Y2gpIHtcbiAgICBmb3IgKGxldCBpID0gMCwgbCA9IHRoaXMuX29wZXJhdGlvbnMubGVuZ3RoOyBpIDwgbDsgKytpKSB7XG4gICAgICBjb25zdCBvcCA9IHRoaXMuX29wZXJhdGlvbnNbaV07XG5cbiAgICAgIGlmICgob3AgaW5zdGFuY2VvZiBvcGVyYXRpb25TZWxlY3RvcikgPT09IG1hdGNoKSB7XG4gICAgICAgIGlmIChjYWxsYmFjayhvcCwgaSkgPT09IGZhbHNlKSB7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG4gIH1cbn1cbiJdfQ==