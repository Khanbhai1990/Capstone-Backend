'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = queryBuilderOperation;

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _knexUtils = require('../../utils/knexUtils');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function queryBuilderOperation(input, name) {
  var normalizedInput = normalizeInput(input);

  return function (target, property, descriptor) {
    var operationName = name || property;
    if (_lodash2.default.isFunction(input) || _lodash2.default.isArray(input)) {
      descriptor.value = function decorator$queryBuilderOperation() {
        var args = new Array(arguments.length);

        // Don't turn this into a function. This needs to be inline for V8 to optimize this.
        for (var i = 0, l = arguments.length; i < l; ++i) {
          args[i] = arguments[i];
        }

        var methodDesc = normalizedInput.default;
        var method = new methodDesc.operationClass(operationName, methodDesc.opt);

        return this.callQueryBuilderOperation(method, args);
      };
    } else {
      descriptor.value = function decorator$queryBuilderOperationWithDialect() {
        var args = new Array(arguments.length);

        // Don't turn this into a function. This needs to be inline for V8 to optimize this.
        for (var i = 0, l = arguments.length; i < l; ++i) {
          args[i] = arguments[i];
        }

        var dialect = (0, _knexUtils.getDialect)(this.knex());
        var methodDesc = normalizedInput[dialect] || normalizedInput.default;
        var method = new methodDesc.operationClass(operationName, methodDesc.opt);

        return this.callQueryBuilderOperation(method, args);
      };
    }
  };
}

function normalizeInput(input) {
  if (_lodash2.default.isFunction(input) || _lodash2.default.isArray(input)) {
    return {
      default: normalizeQueryOperationDesc(input)
    };
  } else {
    return _lodash2.default.mapValues(input, normalizeQueryOperationDesc);
  }
}

function normalizeQueryOperationDesc(desc) {
  if (_lodash2.default.isArray(desc)) {
    return {
      operationClass: desc[0],
      opt: desc[1]
    };
  } else {
    return {
      operationClass: desc,
      opt: {}
    };
  }
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbInF1ZXJ5QnVpbGRlck9wZXJhdGlvbi5qcyJdLCJuYW1lcyI6WyJxdWVyeUJ1aWxkZXJPcGVyYXRpb24iLCJpbnB1dCIsIm5hbWUiLCJub3JtYWxpemVkSW5wdXQiLCJub3JtYWxpemVJbnB1dCIsInRhcmdldCIsInByb3BlcnR5IiwiZGVzY3JpcHRvciIsIm9wZXJhdGlvbk5hbWUiLCJpc0Z1bmN0aW9uIiwiaXNBcnJheSIsInZhbHVlIiwiZGVjb3JhdG9yJHF1ZXJ5QnVpbGRlck9wZXJhdGlvbiIsImFyZ3MiLCJBcnJheSIsImFyZ3VtZW50cyIsImxlbmd0aCIsImkiLCJsIiwibWV0aG9kRGVzYyIsImRlZmF1bHQiLCJtZXRob2QiLCJvcGVyYXRpb25DbGFzcyIsIm9wdCIsImNhbGxRdWVyeUJ1aWxkZXJPcGVyYXRpb24iLCJkZWNvcmF0b3IkcXVlcnlCdWlsZGVyT3BlcmF0aW9uV2l0aERpYWxlY3QiLCJkaWFsZWN0Iiwia25leCIsIm5vcm1hbGl6ZVF1ZXJ5T3BlcmF0aW9uRGVzYyIsIm1hcFZhbHVlcyIsImRlc2MiXSwibWFwcGluZ3MiOiI7Ozs7O2tCQUd3QkEscUI7O0FBSHhCOzs7O0FBQ0E7Ozs7QUFFZSxTQUFTQSxxQkFBVCxDQUErQkMsS0FBL0IsRUFBc0NDLElBQXRDLEVBQTRDO0FBQ3pELE1BQU1DLGtCQUFrQkMsZUFBZUgsS0FBZixDQUF4Qjs7QUFFQSxTQUFPLFVBQVVJLE1BQVYsRUFBa0JDLFFBQWxCLEVBQTRCQyxVQUE1QixFQUF3QztBQUM3QyxRQUFNQyxnQkFBZ0JOLFFBQVFJLFFBQTlCO0FBQ0EsUUFBSSxpQkFBRUcsVUFBRixDQUFhUixLQUFiLEtBQXVCLGlCQUFFUyxPQUFGLENBQVVULEtBQVYsQ0FBM0IsRUFBNkM7QUFDM0NNLGlCQUFXSSxLQUFYLEdBQW1CLFNBQVNDLCtCQUFULEdBQTJDO0FBQzVELFlBQU1DLE9BQU8sSUFBSUMsS0FBSixDQUFVQyxVQUFVQyxNQUFwQixDQUFiOztBQUVBO0FBQ0EsYUFBSyxJQUFJQyxJQUFJLENBQVIsRUFBV0MsSUFBSUgsVUFBVUMsTUFBOUIsRUFBc0NDLElBQUlDLENBQTFDLEVBQTZDLEVBQUVELENBQS9DLEVBQWtEO0FBQ2hESixlQUFLSSxDQUFMLElBQVVGLFVBQVVFLENBQVYsQ0FBVjtBQUNEOztBQUVELFlBQU1FLGFBQWFoQixnQkFBZ0JpQixPQUFuQztBQUNBLFlBQU1DLFNBQVMsSUFBSUYsV0FBV0csY0FBZixDQUE4QmQsYUFBOUIsRUFBNkNXLFdBQVdJLEdBQXhELENBQWY7O0FBRUEsZUFBTyxLQUFLQyx5QkFBTCxDQUErQkgsTUFBL0IsRUFBdUNSLElBQXZDLENBQVA7QUFDRCxPQVpEO0FBYUQsS0FkRCxNQWNPO0FBQ0xOLGlCQUFXSSxLQUFYLEdBQW1CLFNBQVNjLDBDQUFULEdBQXNEO0FBQ3ZFLFlBQU1aLE9BQU8sSUFBSUMsS0FBSixDQUFVQyxVQUFVQyxNQUFwQixDQUFiOztBQUVBO0FBQ0EsYUFBSyxJQUFJQyxJQUFJLENBQVIsRUFBV0MsSUFBSUgsVUFBVUMsTUFBOUIsRUFBc0NDLElBQUlDLENBQTFDLEVBQTZDLEVBQUVELENBQS9DLEVBQWtEO0FBQ2hESixlQUFLSSxDQUFMLElBQVVGLFVBQVVFLENBQVYsQ0FBVjtBQUNEOztBQUVELFlBQU1TLFVBQVUsMkJBQVcsS0FBS0MsSUFBTCxFQUFYLENBQWhCO0FBQ0EsWUFBTVIsYUFBYWhCLGdCQUFnQnVCLE9BQWhCLEtBQTRCdkIsZ0JBQWdCaUIsT0FBL0Q7QUFDQSxZQUFNQyxTQUFTLElBQUlGLFdBQVdHLGNBQWYsQ0FBOEJkLGFBQTlCLEVBQTZDVyxXQUFXSSxHQUF4RCxDQUFmOztBQUVBLGVBQU8sS0FBS0MseUJBQUwsQ0FBK0JILE1BQS9CLEVBQXVDUixJQUF2QyxDQUFQO0FBQ0QsT0FiRDtBQWNEO0FBQ0YsR0FoQ0Q7QUFpQ0Q7O0FBRUQsU0FBU1QsY0FBVCxDQUF3QkgsS0FBeEIsRUFBK0I7QUFDN0IsTUFBSSxpQkFBRVEsVUFBRixDQUFhUixLQUFiLEtBQXVCLGlCQUFFUyxPQUFGLENBQVVULEtBQVYsQ0FBM0IsRUFBNkM7QUFDM0MsV0FBTztBQUNMbUIsZUFBU1EsNEJBQTRCM0IsS0FBNUI7QUFESixLQUFQO0FBR0QsR0FKRCxNQUlPO0FBQ0wsV0FBTyxpQkFBRTRCLFNBQUYsQ0FBWTVCLEtBQVosRUFBbUIyQiwyQkFBbkIsQ0FBUDtBQUNEO0FBQ0Y7O0FBRUQsU0FBU0EsMkJBQVQsQ0FBcUNFLElBQXJDLEVBQTJDO0FBQ3pDLE1BQUksaUJBQUVwQixPQUFGLENBQVVvQixJQUFWLENBQUosRUFBcUI7QUFDbkIsV0FBTztBQUNMUixzQkFBZ0JRLEtBQUssQ0FBTCxDQURYO0FBRUxQLFdBQUtPLEtBQUssQ0FBTDtBQUZBLEtBQVA7QUFJRCxHQUxELE1BS087QUFDTCxXQUFPO0FBQ0xSLHNCQUFnQlEsSUFEWDtBQUVMUCxXQUFLO0FBRkEsS0FBUDtBQUlEO0FBQ0YiLCJmaWxlIjoicXVlcnlCdWlsZGVyT3BlcmF0aW9uLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCB7Z2V0RGlhbGVjdH0gZnJvbSAnLi4vLi4vdXRpbHMva25leFV0aWxzJztcblxuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gcXVlcnlCdWlsZGVyT3BlcmF0aW9uKGlucHV0LCBuYW1lKSB7XG4gIGNvbnN0IG5vcm1hbGl6ZWRJbnB1dCA9IG5vcm1hbGl6ZUlucHV0KGlucHV0KTtcblxuICByZXR1cm4gZnVuY3Rpb24gKHRhcmdldCwgcHJvcGVydHksIGRlc2NyaXB0b3IpIHtcbiAgICBjb25zdCBvcGVyYXRpb25OYW1lID0gbmFtZSB8fCBwcm9wZXJ0eTtcbiAgICBpZiAoXy5pc0Z1bmN0aW9uKGlucHV0KSB8fCBfLmlzQXJyYXkoaW5wdXQpKSB7XG4gICAgICBkZXNjcmlwdG9yLnZhbHVlID0gZnVuY3Rpb24gZGVjb3JhdG9yJHF1ZXJ5QnVpbGRlck9wZXJhdGlvbigpIHtcbiAgICAgICAgY29uc3QgYXJncyA9IG5ldyBBcnJheShhcmd1bWVudHMubGVuZ3RoKTtcblxuICAgICAgICAvLyBEb24ndCB0dXJuIHRoaXMgaW50byBhIGZ1bmN0aW9uLiBUaGlzIG5lZWRzIHRvIGJlIGlubGluZSBmb3IgVjggdG8gb3B0aW1pemUgdGhpcy5cbiAgICAgICAgZm9yIChsZXQgaSA9IDAsIGwgPSBhcmd1bWVudHMubGVuZ3RoOyBpIDwgbDsgKytpKSB7XG4gICAgICAgICAgYXJnc1tpXSA9IGFyZ3VtZW50c1tpXTtcbiAgICAgICAgfVxuXG4gICAgICAgIGNvbnN0IG1ldGhvZERlc2MgPSBub3JtYWxpemVkSW5wdXQuZGVmYXVsdDtcbiAgICAgICAgY29uc3QgbWV0aG9kID0gbmV3IG1ldGhvZERlc2Mub3BlcmF0aW9uQ2xhc3Mob3BlcmF0aW9uTmFtZSwgbWV0aG9kRGVzYy5vcHQpO1xuXG4gICAgICAgIHJldHVybiB0aGlzLmNhbGxRdWVyeUJ1aWxkZXJPcGVyYXRpb24obWV0aG9kLCBhcmdzKTtcbiAgICAgIH07XG4gICAgfSBlbHNlIHtcbiAgICAgIGRlc2NyaXB0b3IudmFsdWUgPSBmdW5jdGlvbiBkZWNvcmF0b3IkcXVlcnlCdWlsZGVyT3BlcmF0aW9uV2l0aERpYWxlY3QoKSB7XG4gICAgICAgIGNvbnN0IGFyZ3MgPSBuZXcgQXJyYXkoYXJndW1lbnRzLmxlbmd0aCk7XG5cbiAgICAgICAgLy8gRG9uJ3QgdHVybiB0aGlzIGludG8gYSBmdW5jdGlvbi4gVGhpcyBuZWVkcyB0byBiZSBpbmxpbmUgZm9yIFY4IHRvIG9wdGltaXplIHRoaXMuXG4gICAgICAgIGZvciAobGV0IGkgPSAwLCBsID0gYXJndW1lbnRzLmxlbmd0aDsgaSA8IGw7ICsraSkge1xuICAgICAgICAgIGFyZ3NbaV0gPSBhcmd1bWVudHNbaV07XG4gICAgICAgIH1cblxuICAgICAgICBjb25zdCBkaWFsZWN0ID0gZ2V0RGlhbGVjdCh0aGlzLmtuZXgoKSk7XG4gICAgICAgIGNvbnN0IG1ldGhvZERlc2MgPSBub3JtYWxpemVkSW5wdXRbZGlhbGVjdF0gfHwgbm9ybWFsaXplZElucHV0LmRlZmF1bHQ7XG4gICAgICAgIGNvbnN0IG1ldGhvZCA9IG5ldyBtZXRob2REZXNjLm9wZXJhdGlvbkNsYXNzKG9wZXJhdGlvbk5hbWUsIG1ldGhvZERlc2Mub3B0KTtcblxuICAgICAgICByZXR1cm4gdGhpcy5jYWxsUXVlcnlCdWlsZGVyT3BlcmF0aW9uKG1ldGhvZCwgYXJncyk7XG4gICAgICB9O1xuICAgIH1cbiAgfTtcbn1cblxuZnVuY3Rpb24gbm9ybWFsaXplSW5wdXQoaW5wdXQpIHtcbiAgaWYgKF8uaXNGdW5jdGlvbihpbnB1dCkgfHwgXy5pc0FycmF5KGlucHV0KSkge1xuICAgIHJldHVybiB7XG4gICAgICBkZWZhdWx0OiBub3JtYWxpemVRdWVyeU9wZXJhdGlvbkRlc2MoaW5wdXQpXG4gICAgfTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gXy5tYXBWYWx1ZXMoaW5wdXQsIG5vcm1hbGl6ZVF1ZXJ5T3BlcmF0aW9uRGVzYyk7XG4gIH1cbn1cblxuZnVuY3Rpb24gbm9ybWFsaXplUXVlcnlPcGVyYXRpb25EZXNjKGRlc2MpIHtcbiAgaWYgKF8uaXNBcnJheShkZXNjKSkge1xuICAgIHJldHVybiB7XG4gICAgICBvcGVyYXRpb25DbGFzczogZGVzY1swXSxcbiAgICAgIG9wdDogZGVzY1sxXVxuICAgIH07XG4gIH0gZWxzZSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIG9wZXJhdGlvbkNsYXNzOiBkZXNjLFxuICAgICAgb3B0OiB7fVxuICAgIH07XG4gIH1cbn0iXX0=