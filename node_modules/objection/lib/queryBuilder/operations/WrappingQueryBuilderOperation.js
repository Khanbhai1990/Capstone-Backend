'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = undefined;

var _toConsumableArray2 = require('babel-runtime/helpers/toConsumableArray');

var _toConsumableArray3 = _interopRequireDefault(_toConsumableArray2);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _possibleConstructorReturn2 = require('babel-runtime/helpers/possibleConstructorReturn');

var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);

var _inherits2 = require('babel-runtime/helpers/inherits');

var _inherits3 = _interopRequireDefault(_inherits2);

var _QueryBuilderOperation = require('./QueryBuilderOperation');

var _QueryBuilderOperation2 = _interopRequireDefault(_QueryBuilderOperation);

var _knexUtils = require('../../utils/knexUtils');

var _ReferenceBuilder = require('../ReferenceBuilder');

var _ReferenceBuilder2 = _interopRequireDefault(_ReferenceBuilder);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var QueryBuilderBase = null;
var JoinBuilder = null;

var WrappingQueryBuilderOperation = function (_QueryBuilderOperatio) {
  (0, _inherits3.default)(WrappingQueryBuilderOperation, _QueryBuilderOperatio);

  function WrappingQueryBuilderOperation(name, opt) {
    (0, _classCallCheck3.default)(this, WrappingQueryBuilderOperation);

    var _this = (0, _possibleConstructorReturn3.default)(this, _QueryBuilderOperatio.call(this, name, opt));

    _this.args = null;
    return _this;
  }

  WrappingQueryBuilderOperation.prototype.call = function call(builder, args) {
    var ret = wrapArgs(this, builder, args);
    this.args = args;
    return ret;
  };

  return WrappingQueryBuilderOperation;
}(_QueryBuilderOperation2.default);

exports.default = WrappingQueryBuilderOperation;


function wrapArgs(op, builder, args) {
  // Preventing cyclic deps
  QueryBuilderBase = QueryBuilderBase || requireQueryBuilderBase();

  var skipUndefined = builder.internalOptions().skipUndefined;
  var knex = builder.knex();

  for (var i = 0, l = args.length; i < l; ++i) {
    var arg = args[i];

    if (arg === undefined) {
      if (skipUndefined) {
        return false;
      } else {
        throw new Error('undefined passed as argument #' + l + ' for \'' + op.name + '\' operation. Call skipUndefined() method to ignore the undefined values.');
      }
    } else if (arg instanceof _ReferenceBuilder2.default) {
      args[i] = knex.raw.apply(knex, (0, _toConsumableArray3.default)(args[i].toRawArgs()));
    } else if (arg instanceof QueryBuilderBase) {
      // Convert QueryBuilderBase instances into knex query builders.
      args[i] = arg.build();
    } else if (Array.isArray(arg)) {
      if (skipUndefined) {
        args[i] = withoutUndefined(arg);
      } else if (includesUndefined(arg)) {
        throw new Error('undefined passed as an item in argument #' + l + ' for \'' + op.name + '\' operation. Call skipUndefined() method to ignore the undefined values.');
      }
      // convert reference builders to knex.raw
      args[i] = args[i].map(function (arg) {
        return arg instanceof _ReferenceBuilder2.default ? knex.raw.apply(knex, (0, _toConsumableArray3.default)(arg.toRawArgs())) : arg;
      });
    } else if (typeof arg === 'function') {
      // If an argument is a function, knex calls it with a query builder as
      // first argument (and as `this` context). We wrap the query builder into
      // a QueryBuilderBase instance.
      args[i] = wrapFunctionArg(arg, knex);
    }
  }

  return true;
}

function wrapFunctionArg(func, knex) {
  // Preventing cyclic deps
  QueryBuilderBase = QueryBuilderBase || requireQueryBuilderBase();
  JoinBuilder = JoinBuilder || requireJoinBuilder();

  return function wrappedKnexFunctionArg() {
    if ((0, _knexUtils.isKnexQueryBuilder)(this)) {
      var knexQueryBuilder = this;
      var wrappedQueryBuilder = new QueryBuilderBase(knex);

      func.call(wrappedQueryBuilder, wrappedQueryBuilder);
      wrappedQueryBuilder.buildInto(knexQueryBuilder);
    } else if ((0, _knexUtils.isKnexJoinBuilder)(this)) {
      var _knexQueryBuilder = this;
      var joinClauseBuilder = new JoinBuilder(knex);

      func.call(joinClauseBuilder, joinClauseBuilder);
      joinClauseBuilder.buildInto(_knexQueryBuilder);
    } else {
      return func.apply(this, arguments);
    }
  };
}

function withoutUndefined(arr) {
  var out = [];

  for (var i = 0, l = arr.length; i < l; ++i) {
    if (arr[i] !== undefined) {
      out.push(arr[i]);
    }
  }

  return out;
}

function includesUndefined(arr) {
  for (var i = 0, l = arr.length; i < l; ++i) {
    if (arr[i] === undefined) {
      return true;
    }
  }

  return false;
}

function requireQueryBuilderBase() {
  return require('../QueryBuilderBase').default;
}

function requireJoinBuilder() {
  return require('../JoinBuilder').default;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIldyYXBwaW5nUXVlcnlCdWlsZGVyT3BlcmF0aW9uLmpzIl0sIm5hbWVzIjpbIlF1ZXJ5QnVpbGRlckJhc2UiLCJKb2luQnVpbGRlciIsIldyYXBwaW5nUXVlcnlCdWlsZGVyT3BlcmF0aW9uIiwibmFtZSIsIm9wdCIsImFyZ3MiLCJjYWxsIiwiYnVpbGRlciIsInJldCIsIndyYXBBcmdzIiwib3AiLCJyZXF1aXJlUXVlcnlCdWlsZGVyQmFzZSIsInNraXBVbmRlZmluZWQiLCJpbnRlcm5hbE9wdGlvbnMiLCJrbmV4IiwiaSIsImwiLCJsZW5ndGgiLCJhcmciLCJ1bmRlZmluZWQiLCJFcnJvciIsInJhdyIsInRvUmF3QXJncyIsImJ1aWxkIiwiQXJyYXkiLCJpc0FycmF5Iiwid2l0aG91dFVuZGVmaW5lZCIsImluY2x1ZGVzVW5kZWZpbmVkIiwibWFwIiwid3JhcEZ1bmN0aW9uQXJnIiwiZnVuYyIsInJlcXVpcmVKb2luQnVpbGRlciIsIndyYXBwZWRLbmV4RnVuY3Rpb25BcmciLCJrbmV4UXVlcnlCdWlsZGVyIiwid3JhcHBlZFF1ZXJ5QnVpbGRlciIsImJ1aWxkSW50byIsImpvaW5DbGF1c2VCdWlsZGVyIiwiYXBwbHkiLCJhcmd1bWVudHMiLCJhcnIiLCJvdXQiLCJwdXNoIiwicmVxdWlyZSIsImRlZmF1bHQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7Ozs7QUFDQTs7QUFDQTs7Ozs7O0FBRUEsSUFBSUEsbUJBQW1CLElBQXZCO0FBQ0EsSUFBSUMsY0FBYyxJQUFsQjs7SUFFcUJDLDZCOzs7QUFFbkIseUNBQVlDLElBQVosRUFBa0JDLEdBQWxCLEVBQXVCO0FBQUE7O0FBQUEsK0RBQ3JCLGlDQUFNRCxJQUFOLEVBQVlDLEdBQVosQ0FEcUI7O0FBRXJCLFVBQUtDLElBQUwsR0FBWSxJQUFaO0FBRnFCO0FBR3RCOzswQ0FFREMsSSxpQkFBS0MsTyxFQUFTRixJLEVBQU07QUFDbEIsUUFBTUcsTUFBTUMsU0FBUyxJQUFULEVB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QUNELEtBTk0sTUFNQTtBQUNMLGFBQU9ILEtBQUtPLEtBQUwsQ0FBVyxJQUFYLEVBQWlCQyxTQUFqQixDQUFQO0FBQ0Q7QUFDRixHQWhCRDtBQWlCRDs7QUFFRCxTQUFTWixnQkFBVCxDQUEwQmEsR0FBMUIsRUFBK0I7QUFDN0IsTUFBTUMsTUFBTSxFQUFaOztBQUVBLE9BQUssSUFBSXpCLElBQUksQ0FBUixFQUFXQyxJQUFJdUIsSUFBSXRCLE1BQXhCLEVBQWdDRixJQUFJQyxDQUFwQyxFQUF1QyxFQUFFRCxDQUF6QyxFQUE0QztBQUMxQyxRQUFJd0IsSUFBSXhCLENBQUosTUFBV0ksU0FBZixFQUEwQjtBQUN4QnFCLFVBQUlDLElBQUosQ0FBU0YsSUFBSXhCLENBQUosQ0FBVDtBQUNEO0FBQ0Y7O0FBRUQsU0FBT3lCLEdBQVA7QUFDRDs7QUFFRCxTQUFTYixpQkFBVCxDQUEyQlksR0FBM0IsRUFBZ0M7QUFDOUIsT0FBSyxJQUFJeEIsSUFBSSxDQUFSLEVBQVdDLElBQUl1QixJQUFJdEIsTUFBeEIsRUFBZ0NGLElBQUlDLENBQXBDLEVBQXVDLEVBQUVELENBQXpDLEVBQTRDO0FBQzFDLFFBQUl3QixJQUFJeEIsQ0FBSixNQUFXSSxTQUFmLEVBQTBCO0FBQ3hCLGFBQU8sSUFBUDtBQUNEO0FBQ0Y7O0FBRUQsU0FBTyxLQUFQO0FBQ0Q7O0FBRUQsU0FBU1IsdUJBQVQsR0FBbUM7QUFDakMsU0FBTytCLFFBQVEscUJBQVIsRUFBK0JDLE9BQXRDO0FBQ0Q7O0FBRUQsU0FBU1osa0JBQVQsR0FBOEI7QUFDNUIsU0FBT1csUUFBUSxnQkFBUixFQUEwQkMsT0FBakM7QUFDRCIsImZpbGUiOiJXcmFwcGluZ1F1ZXJ5QnVpbGRlck9wZXJhdGlvbi5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBRdWVyeUJ1aWxkZXJPcGVyYXRpb24gZnJvbSAnLi9RdWVyeUJ1aWxkZXJPcGVyYXRpb24nO1xuaW1wb3J0IHtpc0tuZXhRdWVyeUJ1aWxkZXIsIGlzS25leEpvaW5CdWlsZGVyfSBmcm9tICcuLi8uLi91dGlscy9rbmV4VXRpbHMnO1xuaW1wb3J0IFJlZmVyZW5jZUJ1aWxkZXIgZnJvbSAnLi4vUmVmZXJlbmNlQnVpbGRlcic7XG5cbmxldCBRdWVyeUJ1aWxkZXJCYXNlID0gbnVsbDtcbmxldCBKb2luQnVpbGRlciA9IG51bGw7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFdyYXBwaW5nUXVlcnlCdWlsZGVyT3BlcmF0aW9uIGV4dGVuZHMgUXVlcnlCdWlsZGVyT3BlcmF0aW9uIHtcblxuICBjb25zdHJ1Y3RvcihuYW1lLCBvcHQpIHtcbiAgICBzdXBlcihuYW1lLCBvcHQpO1xuICAgIHRoaXMuYXJncyA9IG51bGw7XG4gIH1cblxuICBjYWxsKGJ1aWxkZXIsIGFyZ3MpIHtcbiAgICBjb25zdCByZXQgPSB3cmFwQXJncyh0aGlzLCBidWlsZGVyLCBhcmdzKTtcbiAgICB0aGlzLmFyZ3MgPSBhcmdzO1xuICAgIHJldHVybiByZXQ7XG4gIH1cbn1cblxuZnVuY3Rpb24gd3JhcEFyZ3Mob3AsIGJ1aWxkZXIsIGFyZ3MpIHtcbiAgLy8gUHJldmVudGluZyBjeWNsaWMgZGVwc1xuICBRdWVyeUJ1aWxkZXJCYXNlID0gUXVlcnlCdWlsZGVyQmFzZSB8fCByZXF1aXJlUXVlcnlCdWlsZGVyQmFzZSgpO1xuXG4gIGNvbnN0IHNraXBVbmRlZmluZWQgPSBidWlsZGVyLmludGVybmFsT3B0aW9ucygpLnNraXBVbmRlZmluZWQ7XG4gIGNvbnN0IGtuZXggPSBidWlsZGVyLmtuZXgoKTtcblxuICBmb3IgKGxldCBpID0gMCwgbCA9IGFyZ3MubGVuZ3RoOyBpIDwgbDsgKytpKSB7XG4gICAgY29uc3QgYXJnID0gYXJnc1tpXTtcblxuICAgIGlmIChhcmcgPT09IHVuZGVmaW5lZCkge1xuICAgICAgaWYgKHNraXBVbmRlZmluZWQpIHtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGB1bmRlZmluZWQgcGFzc2VkIGFzIGFyZ3VtZW50ICMke2x9IGZvciAnJHtvcC5uYW1lfScgb3BlcmF0aW9uLiBDYWxsIHNraXBVbmRlZmluZWQoKSBtZXRob2QgdG8gaWdub3JlIHRoZSB1bmRlZmluZWQgdmFsdWVzLmApO1xuICAgICAgfVxuICAgIH0gZWxzZSBpZiAoYXJnIGluc3RhbmNlb2YgUmVmZXJlbmNlQnVpbGRlcikge1xuICAgICAgYXJnc1tpXSA9IGtuZXgucmF3KC4uLmFyZ3NbaV0udG9SYXdBcmdzKCkpO1xuICAgIH0gZWxzZSBpZiAoYXJnIGluc3RhbmNlb2YgUXVlcnlCdWlsZGVyQmFzZSkge1xuICAgICAgLy8gQ29udmVydCBRdWVyeUJ1aWxkZXJCYXNlIGluc3RhbmNlcyBpbnRvIGtuZXggcXVlcnkgYnVpbGRlcnMuXG4gICAgICBhcmdzW2ldID0gYXJnLmJ1aWxkKCk7XG4gICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KGFyZykpIHtcbiAgICAgIGlmIChza2lwVW5kZWZpbmVkKSB7XG4gICAgICAgIGFyZ3NbaV0gPSB3aXRob3V0VW5kZWZpbmVkKGFyZyk7XG4gICAgICB9IGVsc2UgaWYgKGluY2x1ZGVzVW5kZWZpbmVkKGFyZykpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGB1bmRlZmluZWQgcGFzc2VkIGFzIGFuIGl0ZW0gaW4gYXJndW1lbnQgIyR7bH0gZm9yICcke29wLm5hbWV9JyBvcGVyYXRpb24uIENhbGwgc2tpcFVuZGVmaW5lZCgpIG1ldGhvZCB0byBpZ25vcmUgdGhlIHVuZGVmaW5lZCB2YWx1ZXMuYCk7XG4gICAgICB9XG4gICAgICAvLyBjb252ZXJ0IHJlZmVyZW5jZSBidWlsZGVycyB0byBrbmV4LnJhd1xuICAgICAgYXJnc1tpXSA9IGFyZ3NbaV0ubWFwKGFyZyA9PiB7XG4gICAgICAgIHJldHVybiBhcmcgaW5zdGFuY2VvZiBSZWZlcmVuY2VCdWlsZGVyID8ga25leC5yYXcoLi4uYXJnLnRvUmF3QXJncygpKSA6IGFyZztcbiAgICAgIH0pO1xuICAgIH0gZWxzZSBpZiAodHlwZW9mIGFyZyA9PT0gJ2Z1bmN0aW9uJykge1xuICAgICAgLy8gSWYgYW4gYXJndW1lbnQgaXMgYSBmdW5jdGlvbiwga25leCBjYWxscyBpdCB3aXRoIGEgcXVlcnkgYnVpbGRlciBhc1xuICAgICAgLy8gZmlyc3QgYXJndW1lbnQgKGFuZCBhcyBgdGhpc2AgY29udGV4dCkuIFdlIHdyYXAgdGhlIHF1ZXJ5IGJ1aWxkZXIgaW50b1xuICAgICAgLy8gYSBRdWVyeUJ1aWxkZXJCYXNlIGluc3RhbmNlLlxuICAgICAgYXJnc1tpXSA9IHdyYXBGdW5jdGlvbkFyZyhhcmcsIGtuZXgpO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiB0cnVlO1xufVxuXG5mdW5jdGlvbiB3cmFwRnVuY3Rpb25BcmcoZnVuYywga25leCkge1xuICAvLyBQcmV2ZW50aW5nIGN5Y2xpYyBkZXBzXG4gIFF1ZXJ5QnVpbGRlckJhc2UgPSBRdWVyeUJ1aWxkZXJCYXNlIHx8IHJlcXVpcmVRdWVyeUJ1aWxkZXJCYXNlKCk7XG4gIEpvaW5CdWlsZGVyID0gSm9pbkJ1aWxkZXIgfHwgcmVxdWlyZUpvaW5CdWlsZGVyKCk7XG5cbiAgcmV0dXJuIGZ1bmN0aW9uIHdyYXBwZWRLbmV4RnVuY3Rpb25BcmcoKSB7XG4gICAgaWYgKGlzS25leFF1ZXJ5QnVpbGRlcih0aGlzKSkge1xuICAgICAgY29uc3Qga25leFF1ZXJ5QnVpbGRlciA9IHRoaXM7XG4gICAgICBjb25zdCB3cmFwcGVkUXVlcnlCdWlsZGVyID0gbmV3IFF1ZXJ5QnVpbGRlckJhc2Uoa25leCk7XG5cbiAgICAgIGZ1bmMuY2FsbCh3cmFwcGVkUXVlcnlCdWlsZGVyLCB3cmFwcGVkUXVlcnlCdWlsZGVyKTtcbiAgICAgIHdyYXBwZWRRdWVyeUJ1aWxkZXIuYnVpbGRJbnRvKGtuZXhRdWVyeUJ1aWxkZXIpO1xuICAgIH0gZWxzZSBpZiAoaXNLbmV4Sm9pbkJ1aWxkZXIodGhpcykpIHtcbiAgICAgIGNvbnN0IGtuZXhRdWVyeUJ1aWxkZXIgPSB0aGlzO1xuICAgICAgY29uc3Qgam9pbkNsYXVzZUJ1aWxkZXIgPSBuZXcgSm9pbkJ1aWxkZXIoa25leCk7XG5cbiAgICAgIGZ1bmMuY2FsbChqb2luQ2xhdXNlQnVpbGRlciwgam9pbkNsYXVzZUJ1aWxkZXIpO1xuICAgICAgam9pbkNsYXVzZUJ1aWxkZXIuYnVpbGRJbnRvKGtuZXhRdWVyeUJ1aWxkZXIpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gZnVuYy5hcHBseSh0aGlzLCBhcmd1bWVudHMpO1xuICAgIH1cbiAgfTtcbn1cblxuZnVuY3Rpb24gd2l0aG91dFVuZGVmaW5lZChhcnIpIHtcbiAgY29uc3Qgb3V0ID0gW107XG5cbiAgZm9yIChsZXQgaSA9IDAsIGwgPSBhcnIubGVuZ3RoOyBpIDwgbDsgKytpKSB7XG4gICAgaWYgKGFycltpXSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBvdXQucHVzaChhcnJbaV0pO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBvdXQ7XG59XG5cbmZ1bmN0aW9uIGluY2x1ZGVzVW5kZWZpbmVkKGFycikge1xuICBmb3IgKGxldCBpID0gMCwgbCA9IGFyci5sZW5ndGg7IGkgPCBsOyArK2kpIHtcbiAgICBpZiAoYXJyW2ldID09PSB1bmRlZmluZWQpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBmYWxzZTtcbn1cblxuZnVuY3Rpb24gcmVxdWlyZVF1ZXJ5QnVpbGRlckJhc2UoKSB7XG4gIHJldHVybiByZXF1aXJlKCcuLi9RdWVyeUJ1aWxkZXJCYXNlJykuZGVmYXVsdDtcbn1cblxuZnVuY3Rpb24gcmVxdWlyZUpvaW5CdWlsZGVyKCkge1xuICByZXR1cm4gcmVxdWlyZSgnLi4vSm9pbkJ1aWxkZXInKS5kZWZhdWx0O1xufVxuIl19