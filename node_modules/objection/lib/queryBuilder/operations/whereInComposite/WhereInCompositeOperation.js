'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = undefined;

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _possibleConstructorReturn2 = require('babel-runtime/helpers/possibleConstructorReturn');

var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);

var _inherits2 = require('babel-runtime/helpers/inherits');

var _inherits3 = _interopRequireDefault(_inherits2);

var _WrappingQueryBuilderOperation = require('../WrappingQueryBuilderOperation');

var _WrappingQueryBuilderOperation2 = _interopRequireDefault(_WrappingQueryBuilderOperation);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var WhereInCompositeOperation = function (_WrappingQueryBuilder) {
  (0, _inherits3.default)(WhereInCompositeOperation, _WrappingQueryBuilder);

  function WhereInCompositeOperation() {
    (0, _classCallCheck3.default)(this, WhereInCompositeOperation);
    return (0, _possibleConstructorReturn3.default)(this, _WrappingQueryBuilder.apply(this, arguments));
  }

  WhereInCompositeOperation.prototype.onBuild = function onBuild(knexBuilder) {
    this.build(knexBuilder, this.args[0], this.args[1]);
  };

  WhereInCompositeOperation.prototype.build = function build(knexBuilder, columns, values) {
    var isCompositeKey = Array.isArray(columns) && columns.length > 1;

    if (isCompositeKey) {
      this.buildComposite(knexBuilder, columns, values);
    } else {
      this.buildNonComposite(knexBuilder, columns, values);
    }
  };

  WhereInCompositeOperation.prototype.buildComposite = function buildComposite(knexBuilder, columns, values) {
    if (Array.isArray(values)) {
      this.buildCompositeValue(knexBuilder, columns, values);
    } else {
      this.buildCompositeSubquery(knexBuilder, columns, values);
    }
  };

  WhereInCompositeOperation.prototype.buildCompositeValue = function buildCompositeValue(knexBuilder, columns, values) {
    knexBuilder.whereIn(columns, values);
  };

  WhereInCompositeOperation.prototype.buildCompositeSubquery = function buildCompositeSubquery(knexBuilder, columns, subquery) {
    var formatter = knexBuilder.client.formatter();

    var sql = '(';
    for (var i = 0, l = columns.length; i < l; ++i) {
      sql += formatter.wrap(columns[i]);

      if (i !== columns.length - 1) {
        sql += ',';
      }
    }
    sql += ')';

    knexBuilder.whereIn(knexBuilder.client.raw(sql), subquery);
  };

  WhereInCompositeOperation.prototype.buildNonComposite = function buildNonComposite(knexBuilder, columns, values) {
    var col = typeof columns === 'string' ? columns : columns[0];

    if (Array.isArray(values)) {
      values = pickNonNull(values, []);
    } else {
      values = [values];
    }

    knexBuilder.whereIn(col, values);
  };

  return WhereInCompositeOperation;
}(_WrappingQueryBuilderOperation2.default);

exports.default = WhereInCompositeOperation;


function pickNonNull(values, output) {
  for (var i = 0, l = values.length; i < l; ++i) {
    var val = values[i];

    if (Array.isArray(val)) {
      pickNonNull(val, output);
    } else if (val !== null && val !== undefined) {
      output.push(val);
    }
  }

  return output;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIldoZXJlSW5Db21wb3NpdGVPcGVyYXRpb24uanMiXSwibmFtZXMiOlsiV2hlcmVJbkNvbXBvc2l0ZU9wZXJhdGlvbiIsIm9uQnVpbGQiLCJrbmV4QnVpbGRlciIsImJ1aWxkIiwiYXJncyIsImNvbHVtbnMiLCJ2YWx1ZXMiLCJpc0NvbXBvc2l0ZUtleSIsIkFycmF5IiwiaXNBcnJheSIsImxlbmd0aCIsImJ1aWxkQ29tcG9zaXRlIiwiYnVpbGROb25Db21wb3NpdGUiLCJidWlsZENvbXBvc2l0ZVZhbHVlIiwiYnVpbGRDb21wb3NpdGVTdWJxdWVyeSIsIndoZXJlSW4iLCJzdWJxdWVyeSIsImZvcm1hdHRlciIsImNsaWVudCIsInNxbCIsImkiLCJsIiwid3JhcCIsInJhdyIsImNvbCIsInBpY2tOb25OdWxsIiwib3V0cHV0IiwidmFsIiwidW5kZWZpbmVkIiwicHVzaCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBOzs7Ozs7SUFFcUJBLHlCOzs7Ozs7OztzQ0FFbkJDLE8sb0JBQVFDLFcsRUFBYTtBQUNuQixTQUFLQyxLQUFMLENBQVdELFdBQVgsRUFBd0IsS0FBS0UsSUFBTCxDQUFVLENBQVYsQ0FBeEIsRUFBc0MsS0FBS0EsSUFBTCxDQUFVLENBQVYsQ0FBdEM7QUFDRCxHOztzQ0FFREQsSyxrQkFBTUQsVyxFQUFhRyxPLEVBQVNDLE0sRUFBUTtBQUNsQyxRQUFJQyxpQkFBaUJDLE1BQU1DLE9BQU4sQ0FBY0osT0FBZCxLQUEwQkEsUUFBUUssTUFBUixHQUFpQixDQUFoRTs7QUFFQSxRQUFJSCxjQUFKLEVBQW9CO0FBQ2xCLFdBQUtJLGNBQUwsQ0FBb0JULFdBQXBCLEVBQWlDRyxPQUFqQyxFQUEwQ0MsTUFBMUM7QUFDRCxLQUZELE1BRU87QUFDTCxXQUFLTSxpQkFBTCxDQUF1QlYsV0FBdkIsRUFBb0NHLE9BQXBDLEVBQTZDQyxNQUE3QztBQUNEO0FBQ0YsRzs7c0NBRURLLGMsMkJBQWVULFcsRUFBYUcsTyxFQUFTQyxNLEVBQVE7QUFDM0MsUUFBSUUsTUFBTUMsT0FBTixDQUFjSCxNQUFkLENBQUosRUFBMkI7QUFDekIsV0FBS08sbUJBQUwsQ0FBeUJYLFdBQXpCLEVBQXNDRyxPQUF0QyxFQUErQ0MsTUFBL0M7QUFDRCxLQUZELE1BRU87QUFDTCxXQUFLUSxzQkFBTCxDQUE0QlosV0FBNUIsRUFBeUNHLE9BQXpDLEVBQWtEQyxNQUFsRDtBQUNEO0FBQ0YsRzs7c0NBRURPLG1CLGdDQUFvQlgsVyxFQUFhRyxPLEVBQVNDLE0sRUFBUTtBQUNoREosZ0JBQVlhLE9BQVosQ0FBb0JWLE9BQXBCLEVBQTZCQyxNQUE3QjtBQUNELEc7O3NDQUVEUSxzQixtQ0FBdUJaLFcsRUFBYUcsTyxFQUFTVyxRLEVBQVU7QUFDckQsUUFBTUMsWUFBWWYsWUFBWWdCLE1BQVosQ0FBbUJELFNBQW5CLEVBQWxCOztBQUVBLFFBQUlFLE1BQU0sR0FBVjtBQUNBLFNBQUssSUFBSUMsSUFBSSxDQUFSLEVBQVdDLElBQUloQixRQUFRSyxNQUE1QixFQUFvQ1UsSUFBSUMsQ0FBeEMsRUFBMkMsRUFBRUQsQ0FBN0MsRUFBZ0Q7QUFDOUNELGFBQU9GLFVBQVVLLElBQVYsQ0FBZWpCLFFBQVFlLENBQVIsQ0FBZixDQUFQOztBQUVBLFVBQUlBLE1BQU1mLFFBQVFLLE1BQVIsR0FBaUIsQ0FBM0IsRUFBOEI7QUFDNUJTLGVBQU8sR0FBUDtBQUNEO0FBQ0Y7QUFDREEsV0FBTyxHQUFQOztBQUVBakIsZ0JBQVlhLE9BQVosQ0FBb0JiLFlBQVlnQixNQUFaLENBQW1CSyxHQUFuQixDQUF1QkosR0FBdkIsQ0FBcEIsRUFBaURILFFBQWpEO0FBQ0QsRzs7c0NBRURKLGlCLDhCQUFrQlYsVyxFQUFhRyxPLEVBQVNDLE0sRUFBUTtBQUM5QyxRQUFJa0IsTUFBTyxPQUFPbkIsT0FBUCxLQUFtQixRQUFwQixHQUFnQ0EsT0FBaEMsR0FBMENBLFFBQVEsQ0FBUixDQUFwRDs7QUFFQSxRQUFJRyxNQUFNQyxPQUFOLENBQWNILE1BQWQsQ0FBSixFQUEyQjtBQUN6QkEsZUFBU21CLFlBQVluQixNQUFaLEVBQW9CLEVBQXBCLENBQVQ7QUFDRCxLQUZELE1BRU87QUFDTEEsZUFBUyxDQUFDQSxNQUFELENBQVQ7QUFDRDs7QUFFREosZ0JBQVlhLE9BQVosQ0FBb0JTLEdBQXBCLEVBQXlCbEIsTUFBekI7QUFDRCxHOzs7OztrQkF0RGtCTix5Qjs7O0FBeURyQixTQUFTeUIsV0FBVCxDQUFxQm5CLE1BQXJCLEVBQTZCb0IsTUFBN0IsRUFBcUM7QUFDbkMsT0FBSyxJQUFJTixJQUFJLENBQVIsRUFBV0MsSUFBSWYsT0FBT0ksTUFBM0IsRUFBbUNVLElBQUlDLENBQXZDLEVBQTBDLEVBQUVELENBQTVDLEVBQStDO0FBQzdDLFFBQU1PLE1BQU1yQixPQUFPYyxDQUFQLENBQVo7O0FBRUEsUUFBSVosTUFBTUMsT0FBTixDQUFja0IsR0FBZCxDQUFKLEVBQXdCO0FBQ3RCRixrQkFBWUUsR0FBWixFQUFpQkQsTUFBakI7QUFDRCxLQUZELE1BRU8sSUFBSUMsUUFBUSxJQUFSLElBQWdCQSxRQUFRQyxTQUE1QixFQUF1QztBQUM1Q0YsYUFBT0csSUFBUCxDQUFZRixHQUFaO0FBQ0Q7QUFDRjs7QUFFRCxTQUFPRCxNQUFQO0FBQ0QiLCJmaWxlIjoiV2hlcmVJbkNvbXBvc2l0ZU9wZXJhdGlvbi5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBXcmFwcGluZ1F1ZXJ5QnVpbGRlck9wZXJhdGlvbiBmcm9tICcuLi9XcmFwcGluZ1F1ZXJ5QnVpbGRlck9wZXJhdGlvbic7XG5cbmV4cG9ydCBkZWZhdWx0IGNsYXNzIFdoZXJlSW5Db21wb3NpdGVPcGVyYXRpb24gZXh0ZW5kcyBXcmFwcGluZ1F1ZXJ5QnVpbGRlck9wZXJhdGlvbiB7XG5cbiAgb25CdWlsZChrbmV4QnVpbGRlcikge1xuICAgIHRoaXMuYnVpbGQoa25leEJ1aWxkZXIsIHRoaXMuYXJnc1swXSwgdGhpcy5hcmdzWzFdKTtcbiAgfVxuXG4gIGJ1aWxkKGtuZXhCdWlsZGVyLCBjb2x1bW5zLCB2YWx1ZXMpIHtcbiAgICBsZXQgaXNDb21wb3NpdGVLZXkgPSBBcnJheS5pc0FycmF5KGNvbHVtbnMpICYmIGNvbHVtbnMubGVuZ3RoID4gMTtcblxuICAgIGlmIChpc0NvbXBvc2l0ZUtleSkge1xuICAgICAgdGhpcy5idWlsZENvbXBvc2l0ZShrbmV4QnVpbGRlciwgY29sdW1ucywgdmFsdWVzKTtcbiAgICB9IGVsc2Uge1xuICAgICAgdGhpcy5idWlsZE5vbkNvbXBvc2l0ZShrbmV4QnVpbGRlciwgY29sdW1ucywgdmFsdWVzKTtcbiAgICB9XG4gIH1cblxuICBidWlsZENvbXBvc2l0ZShrbmV4QnVpbGRlciwgY29sdW1ucywgdmFsdWVzKSB7XG4gICAgaWYgKEFycmF5LmlzQXJyYXkodmFsdWVzKSkge1xuICAgICAgdGhpcy5idWlsZENvbXBvc2l0ZVZhbHVlKGtuZXhCdWlsZGVyLCBjb2x1bW5zLCB2YWx1ZXMpO1xuICAgIH0gZWxzZSB7XG4gICAgICB0aGlzLmJ1aWxkQ29tcG9zaXRlU3VicXVlcnkoa25leEJ1aWxkZXIsIGNvbHVtbnMsIHZhbHVlcyk7XG4gICAgfVxuICB9XG5cbiAgYnVpbGRDb21wb3NpdGVWYWx1ZShrbmV4QnVpbGRlciwgY29sdW1ucywgdmFsdWVzKSB7XG4gICAga25leEJ1aWxkZXIud2hlcmVJbihjb2x1bW5zLCB2YWx1ZXMpO1xuICB9XG5cbiAgYnVpbGRDb21wb3NpdGVTdWJxdWVyeShrbmV4QnVpbGRlciwgY29sdW1ucywgc3VicXVlcnkpIHtcbiAgICBjb25zdCBmb3JtYXR0ZXIgPSBrbmV4QnVpbGRlci5jbGllbnQuZm9ybWF0dGVyKCk7XG5cbiAgICBsZXQgc3FsID0gJygnO1xuICAgIGZvciAobGV0IGkgPSAwLCBsID0gY29sdW1ucy5sZW5ndGg7IGkgPCBsOyArK2kpIHtcbiAgICAgIHNxbCArPSBmb3JtYXR0ZXIud3JhcChjb2x1bW5zW2ldKTtcblxuICAgICAgaWYgKGkgIT09IGNvbHVtbnMubGVuZ3RoIC0gMSkge1xuICAgICAgICBzcWwgKz0gJywnO1xuICAgICAgfVxuICAgIH1cbiAgICBzcWwgKz0gJyknO1xuXG4gICAga25leEJ1aWxkZXIud2hlcmVJbihrbmV4QnVpbGRlci5jbGllbnQucmF3KHNxbCksIHN1YnF1ZXJ5KTtcbiAgfVxuXG4gIGJ1aWxkTm9uQ29tcG9zaXRlKGtuZXhCdWlsZGVyLCBjb2x1bW5zLCB2YWx1ZXMpIHtcbiAgICBsZXQgY29sID0gKHR5cGVvZiBjb2x1bW5zID09PSAnc3RyaW5nJykgPyBjb2x1bW5zIDogY29sdW1uc1swXTtcblxuICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlcykpIHtcbiAgICAgIHZhbHVlcyA9IHBpY2tOb25OdWxsKHZhbHVlcywgW10pO1xuICAgIH0gZWxzZSB7XG4gICAgICB2YWx1ZXMgPSBbdmFsdWVzXTtcbiAgICB9XG5cbiAgICBrbmV4QnVpbGRlci53aGVyZUluKGNvbCwgdmFsdWVzKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBwaWNrTm9uTnVsbCh2YWx1ZXMsIG91dHB1dCkge1xuICBmb3IgKGxldCBpID0gMCwgbCA9IHZhbHVlcy5sZW5ndGg7IGkgPCBsOyArK2kpIHtcbiAgICBjb25zdCB2YWwgPSB2YWx1ZXNbaV07XG5cbiAgICBpZiAoQXJyYXkuaXNBcnJheSh2YWwpKSB7XG4gICAgICBwaWNrTm9uTnVsbCh2YWwsIG91dHB1dCk7XG4gICAgfSBlbHNlIGlmICh2YWwgIT09IG51bGwgJiYgdmFsICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIG91dHB1dC5wdXNoKHZhbCk7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIG91dHB1dDtcbn1cblxuIl19