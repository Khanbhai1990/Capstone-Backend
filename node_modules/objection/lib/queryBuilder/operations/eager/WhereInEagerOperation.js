'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = undefined;

var _keys = require('babel-runtime/core-js/object/keys');

var _keys2 = _interopRequireDefault(_keys);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _possibleConstructorReturn2 = require('babel-runtime/helpers/possibleConstructorReturn');

var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);

var _inherits2 = require('babel-runtime/helpers/inherits');

var _inherits3 = _interopRequireDefault(_inherits2);

var _chunk = require('lodash/chunk');

var _chunk2 = _interopRequireDefault(_chunk);

var _flatten = require('lodash/flatten');

var _flatten2 = _interopRequireDefault(_flatten);

var _bluebird = require('bluebird');

var _bluebird2 = _interopRequireDefault(_bluebird);

var _ValidationError = require('../../../model/ValidationError');

var _ValidationError2 = _interopRequireDefault(_ValidationError);

var _EagerOperation2 = require('./EagerOperation');

var _EagerOperation3 = _interopRequireDefault(_EagerOperation2);

var _knexUtils = require('../../../utils/knexUtils');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var WhereInEagerOperation = function (_EagerOperation) {
  (0, _inherits3.default)(WhereInEagerOperation, _EagerOperation);

  function WhereInEagerOperation(name, opt) {
    (0, _classCallCheck3.default)(this, WhereInEagerOperation);

    var _this = (0, _possibleConstructorReturn3.default)(this, _EagerOperation.call(this, name, opt));

    _this.relationsToFetch = [];
    _this.omitProps = [];
    return _this;
  }

  WhereInEagerOperation.prototype.batchSize = function batchSize(knex) {
    if ((0, _knexUtils.isMsSql)(knex)) {
      // On MSSQL the parameter limit is actually 2100, but since I couldn't figure out
      // if the limit is for all parameters in a query or for individual clauses, we set
      // the limit to 2000 to leave 100 parameters for where clauses etc.
      return 2000;
    } else {
      // I'm sure there is some kind of limit for other databases too, but let's lower
      // this if someone ever hits those limits.
      return 10000;
    }
  };

  WhereInEagerOperation.prototype.clone = function clone(props) {
    var copy = _EagerOperation.prototype.clone.call(this);

    copy.relationsToFetch = this.relationsToFetch.slice();
    copy.omitProps = this.omitProps.slice();

    return copy;
  };

  WhereInEagerOperation.prototype.call = function call(builder, args) {
    var ret = _EagerOperation.prototype.call.call(this, builder, args);

    var modelClass = builder.modelClass();
    var relations = modelClass.getRelationArray();

    for (var i = 0, l = relations.length; i < l; ++i) {
      var relation = relations[i];
      var childExpression = this.expression.childExpression(relation.name);

      if (childExpression) {
        this.relationsToFetch.push({
          relation: relation,
          childExpression: childExpression
        });
      }
    }

    return ret;
  };

  WhereInEagerOperation.prototype.onBeforeBuild = function onBeforeBuild(builder) {
    var addedSelects = {};

    for (var i = 0, l = this.relationsToFetch.length; i < l; ++i) {
      var relation = this.relationsToFetch[i].relation;
      var _cols = relation.fullOwnerCol();

      for (var c = 0, lc = _cols.length; c < lc; ++c) {
        var col = _cols[c];

        if (!builder.hasSelection(col) && !addedSelects[col]) {
          this.omitProps.push(relation.ownerProp[c]);
          addedSelects[col] = true;
        }
      }
    }

    var cols = (0, _keys2.default)(addedSelects);

    if (cols.length) {
      builder.select(cols);
    }
  };

  WhereInEagerOperation.prototype.onAfterInternal = function onAfterInternal(builder, result) {
    var _this2 = this;

    var modelClass = builder.modelClass();

    if (!result) {
      return result;
    }

    var models = Array.isArray(result) ? result : [result];

    if (!models.length || !(models[0] instanceof modelClass)) {
      return result;
    }

    var promises = [];

    this.expression.forEachChild(function (child) {
      var relation = modelClass.getRelations()[child.name];

      if (!relation) {
        throw new _ValidationError2.default({ eager: 'unknown relation "' + child.name + '" in an eager expression' });
      }
    });

    for (var i = 0, l = this.relationsToFetch.length; i < l; ++i) {
      var relation = this.relationsToFetch[i].relation;
      var childExpression = this.relationsToFetch[i].childExpression;

      promises.push(this.fetchRelation(builder, models, relation, childExpression));
    }

    return _bluebird2.default.all(promises).then(function () {
      if (!_this2.omitProps.length) {
        return result;
      }

      for (var _i = 0, _l = result.length; _i < _l; ++_i) {
        var model = result[_i];

        for (var c = 0, lc = _this2.omitProps.length; c < lc; ++c) {
          modelClass.omitImpl(model, _this2.omitProps[c]);
        }
      }

      return result;
    });
  };

  WhereInEagerOperation.prototype.fetchRelation = function fetchRelation(builder, models, relation, childExpression) {
    var _this3 = this;

    var batchSize = this.batchSize(builder.knex());
    var modelBatches = (0, _chunk2.default)(models, batchSize);

    return _bluebird2.default.map(modelBatches, function (batch) {
      return _this3.fetchRelationBatch(builder, batch, relation, childExpression);
    }).then(_flatten2.default);
  };

  WhereInEagerOperation.prototype.fetchRelationBatch = function fetchRelationBatch(builder, models, relation, childExpression) {
    var queryBuilder = relation.ownerModelClass.RelatedQueryBuilder.forClass(relation.relatedModelClass).childQueryOf(builder).eager(childExpression);

    var findOperation = relation.find(queryBuilder, models);
    findOperation.alwaysReturnArray = true;

    queryBuilder.callQueryBuilderOperation(findOperation, []);

    for (var i = 0, l = childExpression.args.length; i < l; ++i) {
      var filterName = childExpression.args[i];
      var filter = childExpression.filters[filterName];

      if (typeof filter !== 'function') {
        throw new _ValidationError2.default({ eager: 'could not find filter "' + filterName + '" for relation "' + relation.name + '"' });
      }

      filter(queryBuilder);
    }

    return queryBuilder;
  };

  return WhereInEagerOperation;
}(_EagerOperation3.default);

exports.default = WhereInEagerOperation;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIldoZXJlSW5FYWdlck9wZXJhdGlvbi5qcyJdLCJuYW1lcyI6WyJXaGVyZUluRWFnZXJPcGVyYXRpb24iLCJuYW1lIiwib3B0IiwicmVsYXRpb25zVG9GZXRjaCIsIm9taXRQcm9wcyIsImJhdGNoU2l6ZSIsImtuZXgiLCJjbG9uZSIsInByb3BzIiwiY29weSIsInNsaWNlIiwiY2FsbCIsImJ1aWxkZXIiLCJhcmdzIiwicmV0IiwibW9kZWxDbGFzcyIsInJlbGF0aW9ucyIsImdldFJlbGF0aW9uQXJyYXkiLCJpIiwibCIsImxlbmd0aCIsInJlbGF0aW9uIiwiY2hpbGRFeHByZXNzaW9uIiwiZXhwcmVzc2lvbiIsInB1c2giLCJvbkJlZm9yZUJ1aWxkIiwiYWRkZWRTZWxlY3RzIiwiY29scyIsImZ1bGxPd25lckNvbCIsImMiLCJsYyIsImNvbCIsImhhc1NlbGVjdGlvbiIsIm93bmVyUHJvcCIsInNlbGVjdCIsIm9uQWZ0ZXJJbnRlcm5hbCIsInJlc3VsdCIsIm1vZGVscyIsIkFycmF5IiwiaXNBcnJheSIsInByb21pc2VzIiwiZm9yRWFjaENoaWxkIiwiZ2V0UmVsYXRpb25zIiwiY2hpbGQiLCJlYWdlciIsImZldGNoUmVsYXRpb24iLCJhbGwiLCJ0aGVuIiwibW9kZWwiLCJvbWl0SW1wbCIsIm1vZGVsQmF0Y2hlcyIsIm1hcCIsImZldGNoUmVsYXRpb25CYXRjaCIsImJhdGNoIiwicXVlcnlCdWlsZGVyIiwib3duZXJNb2RlbENsYXNzIiwiUmVsYXRlZFF1ZXJ5QnVpbGRlciIsImZvckNsYXNzIiwicmVsYXRlZE1vZGVsQ2xhc3MiLCJjaGlsZFF1ZXJ5T2YiLCJmaW5kT3BlcmF0aW9uIiwiZmluZCIsImFsd2F5c1JldHVybkFycmF5IiwiY2FsbFF1ZXJ5QnVpbGRlck9wZXJhdGlvbiIsImZpbHRlck5hbWUiLCJmaWx0ZXIiLCJmaWx0ZXJzIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNB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RSxpQkFBZCxHQUFrQyxJQUFsQzs7QUFFQVIsaUJBQWFTLHlCQUFiLENBQXVDSCxhQUF2QyxFQUFzRCxFQUF0RDs7QUFFQSxTQUFLLElBQUkxQyxJQUFJLENBQVIsRUFBV0MsSUFBSUcsZ0JBQWdCVCxJQUFoQixDQUFxQk8sTUFBekMsRUFBaURGLElBQUlDLENBQXJELEVBQXdELEVBQUVELENBQTFELEVBQTZEO0FBQzNELFVBQU04QyxhQUFhMUMsZ0JBQWdCVCxJQUFoQixDQUFxQkssQ0FBckIsQ0FBbkI7QUFDQSxVQUFNK0MsU0FBUzNDLGdCQUFnQjRDLE9BQWhCLENBQXdCRixVQUF4QixDQUFmOztBQUVBLFVBQUksT0FBT0MsTUFBUCxLQUFrQixVQUF0QixFQUFrQztBQUNoQyxjQUFNLDhCQUFvQixFQUFDckIsbUNBQWlDb0IsVUFBakMsd0JBQThEM0MsU0FBU3BCLElBQXZFLE1BQUQsRUFBcEIsQ0FBTjtBQUNEOztBQUVEZ0UsYUFBT1gsWUFBUDtBQUNEOztBQUVELFdBQU9BLFlBQVA7QUFDRCxHOzs7OztrQkEzSmtCdEQscUIiLCJmaWxlIjoiV2hlcmVJbkVhZ2VyT3BlcmF0aW9uLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IGNodW5rIGZyb20gJ2xvZGFzaC9jaHVuayc7XG5pbXBvcnQgZmxhdHRlbiBmcm9tICdsb2Rhc2gvZmxhdHRlbic7XG5pbXBvcnQgUHJvbWlzZSBmcm9tICdibHVlYmlyZCc7XG5pbXBvcnQgVmFsaWRhdGlvbkVycm9yIGZyb20gJy4uLy4uLy4uL21vZGVsL1ZhbGlkYXRpb25FcnJvcidcbmltcG9ydCBFYWdlck9wZXJhdGlvbiBmcm9tICcuL0VhZ2VyT3BlcmF0aW9uJztcbmltcG9ydCB7aXNNc1NxbH0gZnJvbSAnLi4vLi4vLi4vdXRpbHMva25leFV0aWxzJztcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgV2hlcmVJbkVhZ2VyT3BlcmF0aW9uIGV4dGVuZHMgRWFnZXJPcGVyYXRpb24ge1xuXG4gIGNvbnN0cnVjdG9yKG5hbWUsIG9wdCkge1xuICAgIHN1cGVyKG5hbWUsIG9wdCk7XG5cbiAgICB0aGlzLnJlbGF0aW9uc1RvRmV0Y2ggPSBbXTtcbiAgICB0aGlzLm9taXRQcm9wcyA9IFtdO1xuICB9XG5cbiAgYmF0Y2hTaXplKGtuZXgpIHtcbiAgICBpZiAoaXNNc1NxbChrbmV4KSkge1xuICAgICAgLy8gT24gTVNTUUwgdGhlIHBhcmFtZXRlciBsaW1pdCBpcyBhY3R1YWxseSAyMTAwLCBidXQgc2luY2UgSSBjb3VsZG4ndCBmaWd1cmUgb3V0XG4gICAgICAvLyBpZiB0aGUgbGltaXQgaXMgZm9yIGFsbCBwYXJhbWV0ZXJzIGluIGEgcXVlcnkgb3IgZm9yIGluZGl2aWR1YWwgY2xhdXNlcywgd2Ugc2V0XG4gICAgICAvLyB0aGUgbGltaXQgdG8gMjAwMCB0byBsZWF2ZSAxMDAgcGFyYW1ldGVycyBmb3Igd2hlcmUgY2xhdXNlcyBldGMuXG4gICAgICByZXR1cm4gMjAwMDtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gSSdtIHN1cmUgdGhlcmUgaXMgc29tZSBraW5kIG9mIGxpbWl0IGZvciBvdGhlciBkYXRhYmFzZXMgdG9vLCBidXQgbGV0J3MgbG93ZXJcbiAgICAgIC8vIHRoaXMgaWYgc29tZW9uZSBldmVyIGhpdHMgdGhvc2UgbGltaXRzLlxuICAgICAgcmV0dXJuIDEwMDAwO1xuICAgIH1cbiAgfVxuXG4gIGNsb25lKHByb3BzKSB7XG4gICAgY29uc3QgY29weSA9IHN1cGVyLmNsb25lKCk7XG5cbiAgICBjb3B5LnJlbGF0aW9uc1RvRmV0Y2ggPSB0aGlzLnJlbGF0aW9uc1RvRmV0Y2guc2xpY2UoKTtcbiAgICBjb3B5Lm9taXRQcm9wcyA9IHRoaXMub21pdFByb3BzLnNsaWNlKCk7XG5cbiAgICByZXR1cm4gY29weTtcbiAgfVxuXG4gIGNhbGwoYnVpbGRlciwgYXJncykge1xuICAgIGNvbnN0IHJldCA9IHN1cGVyLmNhbGwoYnVpbGRlciwgYXJncyk7XG5cbiAgICBjb25zdCBtb2RlbENsYXNzID0gYnVpbGRlci5tb2RlbENsYXNzKCk7XG4gICAgY29uc3QgcmVsYXRpb25zID0gbW9kZWxDbGFzcy5nZXRSZWxhdGlvbkFycmF5KCk7XG5cbiAgICBmb3IgKGxldCBpID0gMCwgbCA9IHJlbGF0aW9ucy5sZW5ndGg7IGkgPCBsOyArK2kpIHtcbiAgICAgIGNvbnN0IHJlbGF0aW9uID0gcmVsYXRpb25zW2ldO1xuICAgICAgY29uc3QgY2hpbGRFeHByZXNzaW9uID0gdGhpcy5leHByZXNzaW9uLmNoaWxkRXhwcmVzc2lvbihyZWxhdGlvbi5uYW1lKTtcblxuICAgICAgaWYgKGNoaWxkRXhwcmVzc2lvbikge1xuICAgICAgICB0aGlzLnJlbGF0aW9uc1RvRmV0Y2gucHVzaCh7XG4gICAgICAgICAgcmVsYXRpb24sXG4gICAgICAgICAgY2hpbGRFeHByZXNzaW9uXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiByZXQ7XG4gIH1cblxuICBvbkJlZm9yZUJ1aWxkKGJ1aWxkZXIpIHtcbiAgICBjb25zdCBhZGRlZFNlbGVjdHMgPSB7fTtcblxuICAgIGZvciAobGV0IGkgPSAwLCBsID0gdGhpcy5yZWxhdGlvbnNUb0ZldGNoLmxlbmd0aDsgaSA8IGw7ICsraSkge1xuICAgICAgY29uc3QgcmVsYXRpb24gPSB0aGlzLnJlbGF0aW9uc1RvRmV0Y2hbaV0ucmVsYXRpb247XG4gICAgICBjb25zdCBjb2xzID0gcmVsYXRpb24uZnVsbE93bmVyQ29sKCk7XG5cbiAgICAgIGZvciAobGV0IGMgPSAwLCBsYyA9IGNvbHMubGVuZ3RoOyBjIDwgbGM7ICsrYykge1xuICAgICAgICBjb25zdCBjb2wgPSBjb2xzW2NdO1xuXG4gICAgICAgIGlmICghYnVpbGRlci5oYXNTZWxlY3Rpb24oY29sKSAmJiAhYWRkZWRTZWxlY3RzW2NvbF0pIHtcbiAgICAgICAgICB0aGlzLm9taXRQcm9wcy5wdXNoKHJlbGF0aW9uLm93bmVyUHJvcFtjXSk7XG4gICAgICAgICAgYWRkZWRTZWxlY3RzW2NvbF0gPSB0cnVlO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgY29uc3QgY29scyA9IE9iamVjdC5rZXlzKGFkZGVkU2VsZWN0cyk7XG5cbiAgICBpZiAoY29scy5sZW5ndGgpIHtcbiAgICAgIGJ1aWxkZXIuc2VsZWN0KGNvbHMpO1xuICAgIH1cbiAgfVxuXG4gIG9uQWZ0ZXJJbnRlcm5hbChidWlsZGVyLCByZXN1bHQpIHtcbiAgICBjb25zdCBtb2RlbENsYXNzID0gYnVpbGRlci5tb2RlbENsYXNzKCk7XG5cbiAgICBpZiAoIXJlc3VsdCkge1xuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9XG5cbiAgICBjb25zdCBtb2RlbHMgPSBBcnJheS5pc0FycmF5KHJlc3VsdCkgPyByZXN1bHQgOiBbcmVzdWx0XTtcblxuICAgIGlmICghbW9kZWxzLmxlbmd0aCB8fCAhKG1vZGVsc1swXSBpbnN0YW5jZW9mIG1vZGVsQ2xhc3MpKSB7XG4gICAgICByZXR1cm4gcmVzdWx0O1xuICAgIH1cblxuICAgIGNvbnN0IHByb21pc2VzID0gW107XG5cbiAgICB0aGlzLmV4cHJlc3Npb24uZm9yRWFjaENoaWxkKGNoaWxkID0+IHtcbiAgICAgIGxldCByZWxhdGlvbiA9IG1vZGVsQ2xhc3MuZ2V0UmVsYXRpb25zKClbY2hpbGQubmFtZV07XG5cbiAgICAgIGlmICghcmVsYXRpb24pIHtcbiAgICAgICAgdGhyb3cgbmV3IFZhbGlkYXRpb25FcnJvcih7ZWFnZXI6IGB1bmtub3duIHJlbGF0aW9uIFwiJHtjaGlsZC5uYW1lfVwiIGluIGFuIGVhZ2VyIGV4cHJlc3Npb25gfSk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICBmb3IgKGxldCBpID0gMCwgbCA9IHRoaXMucmVsYXRpb25zVG9GZXRjaC5sZW5ndGg7IGkgPCBsOyArK2kpIHtcbiAgICAgIGNvbnN0IHJlbGF0aW9uID0gdGhpcy5yZWxhdGlvbnNUb0ZldGNoW2ldLnJlbGF0aW9uO1xuICAgICAgY29uc3QgY2hpbGRFeHByZXNzaW9uID0gdGhpcy5yZWxhdGlvbnNUb0ZldGNoW2ldLmNoaWxkRXhwcmVzc2lvbjtcblxuICAgICAgcHJvbWlzZXMucHVzaCh0aGlzLmZldGNoUmVsYXRpb24oYnVpbGRlciwgbW9kZWxzLCByZWxhdGlvbiwgY2hpbGRFeHByZXNzaW9uKSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIFByb21pc2UuYWxsKHByb21pc2VzKS50aGVuKCgpID0+IHtcbiAgICAgIGlmICghdGhpcy5vbWl0UHJvcHMubGVuZ3RoKSB7XG4gICAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgICB9XG5cbiAgICAgIGZvciAobGV0IGkgPSAwLCBsID0gcmVzdWx0Lmxlbmd0aDsgaSA8IGw7ICsraSkge1xuICAgICAgICBjb25zdCBtb2RlbCA9IHJlc3VsdFtpXTtcblxuICAgICAgICBmb3IgKGxldCBjID0gMCwgbGMgPSB0aGlzLm9taXRQcm9wcy5sZW5ndGg7IGMgPCBsYzsgKytjKSB7XG4gICAgICAgICAgbW9kZWxDbGFzcy5vbWl0SW1wbChtb2RlbCwgdGhpcy5vbWl0UHJvcHNbY10pO1xuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfSlcbiAgfVxuXG4gIGZldGNoUmVsYXRpb24oYnVpbGRlciwgbW9kZWxzLCByZWxhdGlvbiwgY2hpbGRFeHByZXNzaW9uKSB7XG4gICAgY29uc3QgYmF0Y2hTaXplID0gdGhpcy5iYXRjaFNpemUoYnVpbGRlci5rbmV4KCkpO1xuICAgIGNvbnN0IG1vZGVsQmF0Y2hlcyA9IGNodW5rKG1vZGVscywgYmF0Y2hTaXplKTtcblxuICAgIHJldHVybiBQcm9taXNlXG4gICAgICAubWFwKG1vZGVsQmF0Y2hlcywgYmF0Y2ggPT4gdGhpcy5mZXRjaFJlbGF0aW9uQmF0Y2goYnVpbGRlciwgYmF0Y2gsIHJlbGF0aW9uLCBjaGlsZEV4cHJlc3Npb24pKVxuICAgICAgLnRoZW4oZmxhdHRlbik7XG4gIH1cblxuICBmZXRjaFJlbGF0aW9uQmF0Y2goYnVpbGRlciwgbW9kZWxzLCByZWxhdGlvbiwgY2hpbGRFeHByZXNzaW9uKSB7XG4gICAgY29uc3QgcXVlcnlCdWlsZGVyID0gcmVsYXRpb24ub3duZXJNb2RlbENsYXNzLlJlbGF0ZWRRdWVyeUJ1aWxkZXJcbiAgICAgIC5mb3JDbGFzcyhyZWxhdGlvbi5yZWxhdGVkTW9kZWxDbGFzcylcbiAgICAgIC5jaGlsZFF1ZXJ5T2YoYnVpbGRlcilcbiAgICAgIC5lYWdlcihjaGlsZEV4cHJlc3Npb24pO1xuXG4gICAgY29uc3QgZmluZE9wZXJhdGlvbiA9IHJlbGF0aW9uLmZpbmQocXVlcnlCdWlsZGVyLCBtb2RlbHMpO1xuICAgIGZpbmRPcGVyYXRpb24uYWx3YXlzUmV0dXJuQXJyYXkgPSB0cnVlO1xuXG4gICAgcXVlcnlCdWlsZGVyLmNhbGxRdWVyeUJ1aWxkZXJPcGVyYXRpb24oZmluZE9wZXJhdGlvbiwgW10pO1xuXG4gICAgZm9yIChsZXQgaSA9IDAsIGwgPSBjaGlsZEV4cHJlc3Npb24uYXJncy5sZW5ndGg7IGkgPCBsOyArK2kpIHtcbiAgICAgIGNvbnN0IGZpbHRlck5hbWUgPSBjaGlsZEV4cHJlc3Npb24uYXJnc1tpXTtcbiAgICAgIGNvbnN0IGZpbHRlciA9IGNoaWxkRXhwcmVzc2lvbi5maWx0ZXJzW2ZpbHRlck5hbWVdO1xuXG4gICAgICBpZiAodHlwZW9mIGZpbHRlciAhPT0gJ2Z1bmN0aW9uJykge1xuICAgICAgICB0aHJvdyBuZXcgVmFsaWRhdGlvbkVycm9yKHtlYWdlcjogYGNvdWxkIG5vdCBmaW5kIGZpbHRlciBcIiR7ZmlsdGVyTmFtZX1cIiBmb3IgcmVsYXRpb24gXCIke3JlbGF0aW9uLm5hbWV9XCJgfSk7XG4gICAgICB9XG5cbiAgICAgIGZpbHRlcihxdWVyeUJ1aWxkZXIpO1xuICAgIH1cblxuICAgIHJldHVybiBxdWVyeUJ1aWxkZXI7XG4gIH1cbn0iXX0=