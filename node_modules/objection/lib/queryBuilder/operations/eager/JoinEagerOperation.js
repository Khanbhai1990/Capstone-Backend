'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = undefined;

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _possibleConstructorReturn2 = require('babel-runtime/helpers/possibleConstructorReturn');

var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);

var _inherits2 = require('babel-runtime/helpers/inherits');

var _inherits3 = _interopRequireDefault(_inherits2);

var _EagerOperation2 = require('./EagerOperation');

var _EagerOperation3 = _interopRequireDefault(_EagerOperation2);

var _RelationJoinBuilder = require('./RelationJoinBuilder');

var _RelationJoinBuilder2 = _interopRequireDefault(_RelationJoinBuilder);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var JoinEagerOperation = function (_EagerOperation) {
  (0, _inherits3.default)(JoinEagerOperation, _EagerOperation);

  function JoinEagerOperation(name, opt) {
    (0, _classCallCheck3.default)(this, JoinEagerOperation);

    var _this = (0, _possibleConstructorReturn3.default)(this, _EagerOperation.call(this, name, opt));

    _this.joinBuilder = null;
    return _this;
  }

  JoinEagerOperation.prototype.clone = function clone() {
    var _EagerOperation$proto;

    for (var _len = arguments.length, args = Array(_len), _key = 0; _key < _len; _key++) {
      args[_key] = arguments[_key];
    }

    var copy = (_EagerOperation$proto = _EagerOperation.prototype.clone).call.apply(_EagerOperation$proto, [this].concat(args));

    if (this.joinBuilder) {
      copy.joinBuilder = this.joinBuilder.clone({
        opt: copy.opt,
        expression: copy.expression
      });
    }

    return copy;
  };

  JoinEagerOperation.prototype.call = function call(builder, args) {
    var ret = _EagerOperation.prototype.call.call(this, builder, args);
    var modelClass = builder.modelClass();

    if (ret) {
      this.joinBuilder = new _RelationJoinBuilder2.default({
        modelClass: modelClass,
        expression: this.expression,
        opt: this.opt
      });
    }

    return ret;
  };

  JoinEagerOperation.prototype.onBeforeInternal = function onBeforeInternal(builder) {
    return this.joinBuilder.fetchColumnInfo(builder.knex());
  };

  JoinEagerOperation.prototype.onBeforeBuild = function onBeforeBuild(builder) {
    this.joinBuilder.build(builder);
  };

  JoinEagerOperation.prototype.onRawResult = function onRawResult(builder, rows) {
    return this.joinBuilder.rowsToTree(rows);
  };

  return JoinEagerOperation;
}(_EagerOperation3.default);

exports.default = JoinEagerOperation;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkpvaW5FYWdlck9wZXJhdGlvbi5qcyJdLCJuYW1lcyI6WyJKb2luRWFnZXJPcGVyYXRpb24iLCJuYW1lIiwib3B0Iiwiam9pbkJ1aWxkZXIiLCJjbG9uZSIsImFyZ3MiLCJjb3B5IiwiZXhwcmVzc2lvbiIsImNhbGwiLCJidWlsZGVyIiwicmV0IiwibW9kZWxDbGFzcyIsIm9uQmVmb3JlSW50ZXJuYWwiLCJmZXRjaENvbHVtbkluZm8iLCJrbmV4Iiwib25CZWZvcmVCdWlsZCIsImJ1aWxkIiwib25SYXdSZXN1bHQiLCJyb3dzIiwicm93c1RvVHJlZSJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQUFBOzs7O0FBQ0E7Ozs7OztJQUVxQkEsa0I7OztBQUVuQiw4QkFBWUMsSUFBWixFQUFrQkMsR0FBbEIsRUFBdUI7QUFBQTs7QUFBQSwrREFDckIsMkJBQU1ELElBQU4sRUFBWUMsR0FBWixDQURxQjs7QUFFckIsVUFBS0MsV0FBTCxHQUFtQixJQUFuQjtBQUZxQjtBQUd0Qjs7K0JBRURDLEssb0JBQWU7QUFBQTs7QUFBQSxzQ0FBTkMsSUFBTTtBQUFOQSxVQUFNO0FBQUE7O0FBQ2IsUUFBTUMsT0FBTyxtREFBTUYsS0FBTixrREFBZUMsSUFBZixFQUFiOztBQUVBLFFBQUksS0FBS0YsV0FBVCxFQUFzQjtBQUNwQkcsV0FBS0gsV0FBTCxHQUFtQixLQUFLQSxXQUFMLENBQWlCQyxLQUFqQixDQUF1QjtBQUN4Q0YsYUFBS0ksS0FBS0osR0FEOEI7QUFFeENLLG9CQUFZRCxLQUFLQztBQUZ1QixPQUF2QixDQUFuQjtBQUlEOztBQUVELFdBQU9ELElBQVA7QUFDRCxHOzsrQkFFREUsSSxpQkFBS0MsTyxFQUFTSixJLEVBQU07QUFDbEIsUUFBTUssTUFBTSwwQkFBTUYsSUFBTixZQUFXQyxPQUFYLEVBQW9CSixJQUFwQixDQUFaO0FBQ0EsUUFBTU0sYUFBYUYsUUFBUUUsVUFBUixFQUFuQjs7QUFFQSxRQUFJRCxHQUFKLEVBQVM7QUFDUCxXQUFLUCxXQUFMLEdBQW1CLGtDQUF3QjtBQUN6Q1Esb0JBQVlBLFVBRDZCO0FBRXpDSixvQkFBWSxLQUFLQSxVQUZ3QjtBQUd6Q0wsYUFBSyxLQUFLQTtBQUgrQixPQUF4QixDQUFuQjtBQUtEOztBQUVELFdBQU9RLEdBQVA7QUFDRCxHOzsrQkFFREUsZ0IsNkJBQWlCSCxPLEVBQVM7QUFDeEIsV0FBTyxLQUFLTixXQUFMLENBQWlCVSxlQUFqQixDQUFpQ0osUUFBUUssSUFBUixFQUFqQyxDQUFQO0FBQ0QsRzs7K0JBRURDLGEsMEJBQWNOLE8sRUFBUztBQUNyQixTQUFLTixXQUFMLENBQWlCYSxLQUFqQixDQUF1QlAsT0FBdkI7QUFDRCxHOzsrQkFFRFEsVyx3QkFBWVIsTyxFQUFTUyxJLEVBQU07QUFDekIsV0FBTyxLQUFLZixXQUFMLENBQWlCZ0IsVUFBakIsQ0FBNEJELElBQTVCLENBQVA7QUFDRCxHOzs7OztrQkE3Q2tCbEIsa0IiLCJmaWxlIjoiSm9pbkVhZ2VyT3BlcmF0aW9uLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IEVhZ2VyT3BlcmF0aW9uIGZyb20gJy4vRWFnZXJPcGVyYXRpb24nO1xuaW1wb3J0IFJlbGF0aW9uSm9pbkJ1aWxkZXIgZnJvbSAnLi9SZWxhdGlvbkpvaW5CdWlsZGVyJztcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgSm9pbkVhZ2VyT3BlcmF0aW9uIGV4dGVuZHMgRWFnZXJPcGVyYXRpb24ge1xuXG4gIGNvbnN0cnVjdG9yKG5hbWUsIG9wdCkge1xuICAgIHN1cGVyKG5hbWUsIG9wdCk7XG4gICAgdGhpcy5qb2luQnVpbGRlciA9IG51bGw7XG4gIH1cblxuICBjbG9uZSguLi5hcmdzKSB7XG4gICAgY29uc3QgY29weSA9IHN1cGVyLmNsb25lKC4uLmFyZ3MpO1xuXG4gICAgaWYgKHRoaXMuam9pbkJ1aWxkZXIpIHtcbiAgICAgIGNvcHkuam9pbkJ1aWxkZXIgPSB0aGlzLmpvaW5CdWlsZGVyLmNsb25lKHtcbiAgICAgICAgb3B0OiBjb3B5Lm9wdCxcbiAgICAgICAgZXhwcmVzc2lvbjogY29weS5leHByZXNzaW9uXG4gICAgICB9KTtcbiAgICB9XG5cbiAgICByZXR1cm4gY29weTtcbiAgfVxuXG4gIGNhbGwoYnVpbGRlciwgYXJncykge1xuICAgIGNvbnN0IHJldCA9IHN1cGVyLmNhbGwoYnVpbGRlciwgYXJncyk7XG4gICAgY29uc3QgbW9kZWxDbGFzcyA9IGJ1aWxkZXIubW9kZWxDbGFzcygpO1xuXG4gICAgaWYgKHJldCkge1xuICAgICAgdGhpcy5qb2luQnVpbGRlciA9IG5ldyBSZWxhdGlvbkpvaW5CdWlsZGVyKHtcbiAgICAgICAgbW9kZWxDbGFzczogbW9kZWxDbGFzcyxcbiAgICAgICAgZXhwcmVzc2lvbjogdGhpcy5leHByZXNzaW9uLFxuICAgICAgICBvcHQ6IHRoaXMub3B0XG4gICAgICB9KVxuICAgIH1cblxuICAgIHJldHVybiByZXQ7XG4gIH1cblxuICBvbkJlZm9yZUludGVybmFsKGJ1aWxkZXIpIHtcbiAgICByZXR1cm4gdGhpcy5qb2luQnVpbGRlci5mZXRjaENvbHVtbkluZm8oYnVpbGRlci5rbmV4KCkpO1xuICB9XG5cbiAgb25CZWZvcmVCdWlsZChidWlsZGVyKSB7XG4gICAgdGhpcy5qb2luQnVpbGRlci5idWlsZChidWlsZGVyKTtcbiAgfVxuXG4gIG9uUmF3UmVzdWx0KGJ1aWxkZXIsIHJvd3MpIHtcbiAgICByZXR1cm4gdGhpcy5qb2luQnVpbGRlci5yb3dzVG9UcmVlKHJvd3MpO1xuICB9XG59Il19