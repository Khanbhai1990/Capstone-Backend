'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = undefined;

var _typeof2 = require('babel-runtime/helpers/typeof');

var _typeof3 = _interopRequireDefault(_typeof2);

var _assign = require('babel-runtime/core-js/object/assign');

var _assign2 = _interopRequireDefault(_assign);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _possibleConstructorReturn2 = require('babel-runtime/helpers/possibleConstructorReturn');

var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);

var _inherits2 = require('babel-runtime/helpers/inherits');

var _inherits3 = _interopRequireDefault(_inherits2);

var _QueryBuilderOperation = require('./QueryBuilderOperation');

var _QueryBuilderOperation2 = _interopRequireDefault(_QueryBuilderOperation);

var _modelFactory = require('../../model/modelFactory');

var _promiseUtils = require('../../utils/promiseUtils');

var _knexUtils = require('../../utils/knexUtils');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var InsertOperation = function (_QueryBuilderOperatio) {
  (0, _inherits3.default)(InsertOperation, _QueryBuilderOperatio);

  function InsertOperation(name, opt) {
    (0, _classCallCheck3.default)(this, InsertOperation);

    /**
     * The models we are inserting.
     *
     * @type {Array.<Model>}
     */
    var _this = (0, _possibleConstructorReturn3.default)(this, _QueryBuilderOperatio.call(this, name, opt));

    _this.models = null;

    /**
     * this.models is always an array, this is true if the
     * original input was an array.
     *
     * @type {boolean}
     */
    _this.isArray = false;

    /**
     * Options for the Model.fromJson call.
     *
     * @type {ModelOptions}
     */
    _this.modelOptions = (0, _assign2.default)({}, _this.opt.modelOptions || {});

    /**
     * Set this to true if the the input should be split into models
     * and query properties deeply (with relations).
     *
     * @type {boolean}
     */
    _this.splitQueryPropsDeep = false;

    /**
     * Maps models in this.models into query properties that were
     * separated from them.
     *
     * @type {Map}
     */
    _this.queryProps = null;

    /**
     * @type {boolean}
     */
    _this.isWriteOperation = true;
    return _this;
  }

  InsertOperation.prototype.call = function call(builder, args) {
    // The objects to insert.
    var json = args[0];
    var modelClass = builder.modelClass();

    this.isArray = Array.isArray(json);

    if (!this.isArray) {
      json = [json];
    }

    if (json.every(function (it) {
      return it instanceof modelClass;
    })) {
      // No need to convert, already model instances.
      this.models = json;
    } else {
      // Convert into model instances and separate query properties like
      // query builders, knex raw calls etc.
      var split = (0, _modelFactory.fromJson)({
        modelOptions: this.modelOptions,
        modelClass: modelClass,
        deep: this.splitQueryPropsDeep,
        json: json
      });

      this.models = split.model;
      this.queryProps = split.queryProps;
    }

    return true;
  };

  InsertOperation.prototype.onBeforeInternal = function onBeforeInternal(builder, result) {
    if (this.models.length > 1 && !(0, _knexUtils.isPostgres)(builder.knex())) {
      throw new Error('batch insert only works with Postgresql');
    } else {
      return (0, _promiseUtils.mapAfterAllReturn)(this.models, function (model) {
        return model.$beforeInsert(builder.context());
      }, result);
    }
  };

  InsertOperation.prototype.onBuild = function onBuild(knexBuilder, builder) {
    if (!builder.has(/returning/)) {
      // If the user hasn't specified a `returning` clause, we make sure
      // that at least the identifier is returned.
      knexBuilder.returning(builder.modelClass().idColumn);
    }

    var json = new Array(this.models.length);
    // Builder options can contain a queryProps map. Use it
    // if there isn't a local one.
    var queryProps = this.queryProps || builder.internalOptions().queryProps;

    // Convert the models into database json and merge the query
    // properties back.
    for (var i = 0, l = this.models.length; i < l; ++i) {
      json[i] = (0, _modelFactory.toDatabaseJson)({
        model: this.models[i],
        queryProps: queryProps
      });
    }

    knexBuilder.insert(json);
  };

  InsertOperation.prototype.onAfterQuery = function onAfterQuery(builder, ret) {
    if (!Array.isArray(ret) || !ret.length || ret === this.models) {
      // Early exit if there is nothing to do.
      return this.models;
    }

    if (ret[0] && (0, _typeof3.default)(ret[0]) === 'object') {
      // If the user specified a `returning` clause the result may be an array of objects.
      // Merge all values of the objects to our models.
      for (var i = 0, l = this.models.length; i < l; ++i) {
        this.models[i].$set(ret[i]);
      }
    } else {
      // If the return value is not an array of objects, we assume it is an array of identifiers.
      for (var _i = 0, _l = this.models.length; _i < _l; ++_i) {
        var model = this.models[_i];

        // Don't set the id if the model already has one. MySQL and Sqlite don't return the correct
        // primary key value if the id is not generated in db, but given explicitly.
        if (!model.$id()) {
          model.$id(ret[_i]);
        }
      }
    }

    return this.models;
  };

  InsertOperation.prototype.onAfterInternal = function onAfterInternal(builder, models) {
    var result = this.isArray ? models : models[0] || null;
    return (0, _promiseUtils.mapAfterAllReturn)(models, function (model) {
      return model.$afterInsert(builder.context());
    }, result);
  };

  return InsertOperation;
}(_QueryBuilderOperation2.default);

exports.default = InsertOperation;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkluc2VydE9wZXJhdGlvbi5qcyJdLCJuYW1lcyI6WyJJbnNlcnRPcGVyYXRpb24iLCJuYW1lIiwib3B0IiwibW9kZWxzIiwiaXNBcnJheSIsIm1vZGVsT3B0aW9ucyIsInNwbGl0UXVlcnlQcm9wc0RlZXAiLCJxdWVyeVByb3BzIiwiaXNXcml0ZU9wZXJhdGlvbiIsImNhbGwiLCJidWlsZGVyIiwiYXJncyIsImpzb24iLCJtb2RlbENsYXNzIiwiQXJyYXkiLCJldmVyeSIsIml0Iiwic3BsaXQiLCJkZWVwIiwibW9kZWwiLCJvbkJlZm9yZUludGVybmFsIiwicmVzdWx0IiwibGVuZ3RoIiwia25leCIsIkVycm9yIiwiJGJlZm9yZUluc2VydCIsImNvbnRleHQiLCJvbkJ1aWxkIiwia25leEJ1aWxkZXIiLCJoYXMiLCJyZXR1cm5pbmciLCJpZENvbHVtbiIsImludGVybmFsT3B0aW9ucyIsImkiLCJsIiwiaW5zZXJ0Iiwib25BZnRlclF1ZXJ5IiwicmV0IiwiJHNldCIsIiRpZCIsIm9uQWZ0ZXJJbnRlcm5hbCIsIiRhZnRlckluc2VydCJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7Ozs7QUFDQTs7QUFDQTs7QUFDQTs7OztJQUVxQkEsZTs7O0FBRW5CLDJCQUFZQyxJQUFaLEVBQWtCQyxHQUFsQixFQUF1QjtBQUFBOztBQUdyQjs7Ozs7QUFIcUIsK0RBQ3JCLGlDQUFNRCxJQUFOLEVBQVlDLEdBQVosQ0FEcUI7O0FBUXJCLFVBQUtDLE1BQUwsR0FBYyxJQUFkOztBQUVBOzs7Ozs7QUFNQSxVQUFLQyxPQUFMLEdBQWUsS0FBZjs7QUFFQTs7Ozs7QUFLQSxVQUFLQyxZQUFMLEdBQW9CLHNCQUFjLEVBQWQsRUFBa0IsTUFBS0gsR0FBTCxDQUFTRyxZQUFULElBQXlCLEVBQTNDLENBQXBCOztBQUVBOzs7Ozs7QUFNQSxVQUFLQyxtQkFBTCxHQUEyQixLQUEzQjs7QUFFQTs7Ozs7O0FBTUEsVUFBS0MsVUFBTCxHQUFrQixJQUFs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RUFBRUQsQ0FBakQsRUFBb0Q7QUFDbEQsYUFBSzlCLE1BQUwsQ0FBWThCLENBQVosRUFBZUssSUFBZixDQUFvQkQsSUFBSUosQ0FBSixDQUFwQjtBQUNEO0FBQ0YsS0FORCxNQU1PO0FBQ0w7QUFDQSxXQUFLLElBQUlBLEtBQUksQ0FBUixFQUFXQyxLQUFJLEtBQUsvQixNQUFMLENBQVltQixNQUFoQyxFQUF3Q1csS0FBSUMsRUFBNUMsRUFBK0MsRUFBRUQsRUFBakQsRUFBb0Q7QUFDbEQsWUFBTWQsUUFBUSxLQUFLaEIsTUFBTCxDQUFZOEIsRUFBWixDQUFkOztBQUVBO0FBQ0E7QUFDQSxZQUFJLENBQUNkLE1BQU1vQixHQUFOLEVBQUwsRUFBa0I7QUFDaEJwQixnQkFBTW9CLEdBQU4sQ0FBVUYsSUFBSUosRUFBSixDQUFWO0FBQ0Q7QUFDRjtBQUNGOztBQUVELFdBQU8sS0FBSzlCLE1BQVo7QUFDRCxHOzs0QkFFRHFDLGUsNEJBQWdCOUIsTyxFQUFTUCxNLEVBQVE7QUFDL0IsUUFBTWtCLFNBQVMsS0FBS2pCLE9BQUwsR0FBZUQsTUFBZixHQUF5QkEsT0FBTyxDQUFQLEtBQWEsSUFBckQ7QUFDQSxXQUFPLHFDQUFrQkEsTUFBbEIsRUFBMEI7QUFBQSxhQUFTZ0IsTUFBTXNCLFlBQU4sQ0FBbUIvQixRQUFRZ0IsT0FBUixFQUFuQixDQUFUO0FBQUEsS0FBMUIsRUFBMEVMLE1BQTFFLENBQVA7QUFDRCxHOzs7OztrQkEvSWtCckIsZSIsImZpbGUiOiJJbnNlcnRPcGVyYXRpb24uanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgUXVlcnlCdWlsZGVyT3BlcmF0aW9uIGZyb20gJy4vUXVlcnlCdWlsZGVyT3BlcmF0aW9uJztcbmltcG9ydCB7ZnJvbUpzb24sIHRvRGF0YWJhc2VKc29ufSBmcm9tICcuLi8uLi9tb2RlbC9tb2RlbEZhY3RvcnknO1xuaW1wb3J0IHttYXBBZnRlckFsbFJldHVybn0gZnJvbSAnLi4vLi4vdXRpbHMvcHJvbWlzZVV0aWxzJztcbmltcG9ydCB7aXNQb3N0Z3Jlc30gZnJvbSAnLi4vLi4vdXRpbHMva25leFV0aWxzJztcblxuZXhwb3J0IGRlZmF1bHQgY2xhc3MgSW5zZXJ0T3BlcmF0aW9uIGV4dGVuZHMgUXVlcnlCdWlsZGVyT3BlcmF0aW9uIHtcblxuICBjb25zdHJ1Y3RvcihuYW1lLCBvcHQpIHtcbiAgICBzdXBlcihuYW1lLCBvcHQpO1xuXG4gICAgLyoqXG4gICAgICogVGhlIG1vZGVscyB3ZSBhcmUgaW5zZXJ0aW5nLlxuICAgICAqXG4gICAgICogQHR5cGUge0FycmF5LjxNb2RlbD59XG4gICAgICovXG4gICAgdGhpcy5tb2RlbHMgPSBudWxsO1xuXG4gICAgLyoqXG4gICAgICogdGhpcy5tb2RlbHMgaXMgYWx3YXlzIGFuIGFycmF5LCB0aGlzIGlzIHRydWUgaWYgdGhlXG4gICAgICogb3JpZ2luYWwgaW5wdXQgd2FzIGFuIGFycmF5LlxuICAgICAqXG4gICAgICogQHR5cGUge2Jvb2xlYW59XG4gICAgICovXG4gICAgdGhpcy5pc0FycmF5ID0gZmFsc2U7XG5cbiAgICAvKipcbiAgICAgKiBPcHRpb25zIGZvciB0aGUgTW9kZWwuZnJvbUpzb24gY2FsbC5cbiAgICAgKlxuICAgICAqIEB0eXBlIHtNb2RlbE9wdGlvbnN9XG4gICAgICovXG4gICAgdGhpcy5tb2RlbE9wdGlvbnMgPSBPYmplY3QuYXNzaWduKHt9LCB0aGlzLm9wdC5tb2RlbE9wdGlvbnMgfHwge30pO1xuXG4gICAgLyoqXG4gICAgICogU2V0IHRoaXMgdG8gdHJ1ZSBpZiB0aGUgdGhlIGlucHV0IHNob3VsZCBiZSBzcGxpdCBpbnRvIG1vZGVsc1xuICAgICAqIGFuZCBxdWVyeSBwcm9wZXJ0aWVzIGRlZXBseSAod2l0aCByZWxhdGlvbnMpLlxuICAgICAqXG4gICAgICogQHR5cGUge2Jvb2xlYW59XG4gICAgICovXG4gICAgdGhpcy5zcGxpdFF1ZXJ5UHJvcHNEZWVwID0gZmFsc2U7XG5cbiAgICAvKipcbiAgICAgKiBNYXBzIG1vZGVscyBpbiB0aGlzLm1vZGVscyBpbnRvIHF1ZXJ5IHByb3BlcnRpZXMgdGhhdCB3ZXJlXG4gICAgICogc2VwYXJhdGVkIGZyb20gdGhlbS5cbiAgICAgKlxuICAgICAqIEB0eXBlIHtNYXB9XG4gICAgICovXG4gICAgdGhpcy5xdWVyeVByb3BzID0gbnVsbDtcblxuICAgIC8qKlxuICAgICAqIEB0eXBlIHtib29sZWFufVxuICAgICAqL1xuICAgIHRoaXMuaXNXcml0ZU9wZXJhdGlvbiA9IHRydWU7XG4gIH1cblxuICBjYWxsKGJ1aWxkZXIsIGFyZ3MpIHtcbiAgICAvLyBUaGUgb2JqZWN0cyB0byBpbnNlcnQuXG4gICAgbGV0IGpzb24gPSBhcmdzWzBdO1xuICAgIGxldCBtb2RlbENsYXNzID0gYnVpbGRlci5tb2RlbENsYXNzKCk7XG5cbiAgICB0aGlzLmlzQXJyYXkgPSBBcnJheS5pc0FycmF5KGpzb24pO1xuXG4gICAgaWYgKCF0aGlzLmlzQXJyYXkpIHtcbiAgICAgIGpzb24gPSBbanNvbl07XG4gICAgfVxuXG4gICAgaWYgKGpzb24uZXZlcnkoaXQgPT4gaXQgaW5zdGFuY2VvZiBtb2RlbENsYXNzKSkge1xuICAgICAgLy8gTm8gbmVlZCB0byBjb252ZXJ0LCBhbHJlYWR5IG1vZGVsIGluc3RhbmNlcy5cbiAgICAgIHRoaXMubW9kZWxzID0ganNvbjtcbiAgICB9IGVsc2Uge1xuICAgICAgLy8gQ29udmVydCBpbnRvIG1vZGVsIGluc3RhbmNlcyBhbmQgc2VwYXJhdGUgcXVlcnkgcHJvcGVydGllcyBsaWtlXG4gICAgICAvLyBxdWVyeSBidWlsZGVycywga25leCByYXcgY2FsbHMgZXRjLlxuICAgICAgY29uc3Qgc3BsaXQgPSBmcm9tSnNvbih7XG4gICAgICAgIG1vZGVsT3B0aW9uczogdGhpcy5tb2RlbE9wdGlvbnMsXG4gICAgICAgIG1vZGVsQ2xhc3M6IG1vZGVsQ2xhc3MsXG4gICAgICAgIGRlZXA6IHRoaXMuc3BsaXRRdWVyeVByb3BzRGVlcCxcbiAgICAgICAganNvblxuICAgICAgfSk7XG5cbiAgICAgIHRoaXMubW9kZWxzID0gc3BsaXQubW9kZWw7XG4gICAgICB0aGlzLnF1ZXJ5UHJvcHMgPSBzcGxpdC5xdWVyeVByb3BzO1xuICAgIH1cblxuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgb25CZWZvcmVJbnRlcm5hbChidWlsZGVyLCByZXN1bHQpIHtcbiAgICBpZiAodGhpcy5tb2RlbHMubGVuZ3RoID4gMSAmJiAhaXNQb3N0Z3JlcyhidWlsZGVyLmtuZXgoKSkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignYmF0Y2ggaW5zZXJ0IG9ubHkgd29ya3Mgd2l0aCBQb3N0Z3Jlc3FsJyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBtYXBBZnRlckFsbFJldHVybih0aGlzLm1vZGVscywgbW9kZWwgPT4gbW9kZWwuJGJlZm9yZUluc2VydChidWlsZGVyLmNvbnRleHQoKSksIHJlc3VsdCk7XG4gICAgfVxuICB9XG5cbiAgb25CdWlsZChrbmV4QnVpbGRlciwgYnVpbGRlcikge1xuICAgIGlmICghYnVpbGRlci5oYXMoL3JldHVybmluZy8pKSB7XG4gICAgICAvLyBJZiB0aGUgdXNlciBoYXNuJ3Qgc3BlY2lmaWVkIGEgYHJldHVybmluZ2AgY2xhdXNlLCB3ZSBtYWtlIHN1cmVcbiAgICAgIC8vIHRoYXQgYXQgbGVhc3QgdGhlIGlkZW50aWZpZXIgaXMgcmV0dXJuZWQuXG4gICAgICBrbmV4QnVpbGRlci5yZXR1cm5pbmcoYnVpbGRlci5tb2RlbENsYXNzKCkuaWRDb2x1bW4pO1xuICAgIH1cblxuICAgIGNvbnN0IGpzb24gPSBuZXcgQXJyYXkodGhpcy5tb2RlbHMubGVuZ3RoKTtcbiAgICAvLyBCdWlsZGVyIG9wdGlvbnMgY2FuIGNvbnRhaW4gYSBxdWVyeVByb3BzIG1hcC4gVXNlIGl0XG4gICAgLy8gaWYgdGhlcmUgaXNuJ3QgYSBsb2NhbCBvbmUuXG4gICAgY29uc3QgcXVlcnlQcm9wcyA9IHRoaXMucXVlcnlQcm9wcyB8fCBidWlsZGVyLmludGVybmFsT3B0aW9ucygpLnF1ZXJ5UHJvcHM7XG5cbiAgICAvLyBDb252ZXJ0IHRoZSBtb2RlbHMgaW50byBkYXRhYmFzZSBqc29uIGFuZCBtZXJnZSB0aGUgcXVlcnlcbiAgICAvLyBwcm9wZXJ0aWVzIGJhY2suXG4gICAgZm9yIChsZXQgaSA9IDAsIGwgPSB0aGlzLm1vZGVscy5sZW5ndGg7IGkgPCBsOyArK2kpIHtcbiAgICAgIGpzb25baV0gPSB0b0RhdGFiYXNlSnNvbih7XG4gICAgICAgIG1vZGVsOiB0aGlzLm1vZGVsc1tpXSxcbiAgICAgICAgcXVlcnlQcm9wc1xuICAgICAgfSk7XG4gICAgfVxuXG4gICAga25leEJ1aWxkZXIuaW5zZXJ0KGpzb24pO1xuICB9XG5cbiAgb25BZnRlclF1ZXJ5KGJ1aWxkZXIsIHJldCkge1xuICAgIGlmICghQXJyYXkuaXNBcnJheShyZXQpIHx8ICFyZXQubGVuZ3RoIHx8IHJldCA9PT0gdGhpcy5tb2RlbHMpIHtcbiAgICAgIC8vIEVhcmx5IGV4aXQgaWYgdGhlcmUgaXMgbm90aGluZyB0byBkby5cbiAgICAgIHJldHVybiB0aGlzLm1vZGVscztcbiAgICB9XG5cbiAgICBpZiAocmV0WzBdICYmIHR5cGVvZiByZXRbMF0gPT09ICdvYmplY3QnKSB7XG4gICAgICAvLyBJZiB0aGUgdXNlciBzcGVjaWZpZWQgYSBgcmV0dXJuaW5nYCBjbGF1c2UgdGhlIHJlc3VsdCBtYXkgYmUgYW4gYXJyYXkgb2Ygb2JqZWN0cy5cbiAgICAgIC8vIE1lcmdlIGFsbCB2YWx1ZXMgb2YgdGhlIG9iamVjdHMgdG8gb3VyIG1vZGVscy5cbiAgICAgIGZvciAobGV0IGkgPSAwLCBsID0gdGhpcy5tb2RlbHMubGVuZ3RoOyBpIDwgbDsgKytpKSB7XG4gICAgICAgIHRoaXMubW9kZWxzW2ldLiRzZXQocmV0W2ldKTtcbiAgICAgIH1cbiAgICB9IGVsc2Uge1xuICAgICAgLy8gSWYgdGhlIHJldHVybiB2YWx1ZSBpcyBub3QgYW4gYXJyYXkgb2Ygb2JqZWN0cywgd2UgYXNzdW1lIGl0IGlzIGFuIGFycmF5IG9mIGlkZW50aWZpZXJzLlxuICAgICAgZm9yIChsZXQgaSA9IDAsIGwgPSB0aGlzLm1vZGVscy5sZW5ndGg7IGkgPCBsOyArK2kpIHtcbiAgICAgICAgY29uc3QgbW9kZWwgPSB0aGlzLm1vZGVsc1tpXTtcblxuICAgICAgICAvLyBEb24ndCBzZXQgdGhlIGlkIGlmIHRoZSBtb2RlbCBhbHJlYWR5IGhhcyBvbmUuIE15U1FMIGFuZCBTcWxpdGUgZG9uJ3QgcmV0dXJuIHRoZSBjb3JyZWN0XG4gICAgICAgIC8vIHByaW1hcnkga2V5IHZhbHVlIGlmIHRoZSBpZCBpcyBub3QgZ2VuZXJhdGVkIGluIGRiLCBidXQgZ2l2ZW4gZXhwbGljaXRseS5cbiAgICAgICAgaWYgKCFtb2RlbC4kaWQoKSkge1xuICAgICAgICAgIG1vZGVsLiRpZChyZXRbaV0pO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHRoaXMubW9kZWxzO1xuICB9XG5cbiAgb25BZnRlckludGVybmFsKGJ1aWxkZXIsIG1vZGVscykge1xuICAgIGNvbnN0IHJlc3VsdCA9IHRoaXMuaXNBcnJheSA/IG1vZGVscyA6IChtb2RlbHNbMF0gfHwgbnVsbCk7XG4gICAgcmV0dXJuIG1hcEFmdGVyQWxsUmV0dXJuKG1vZGVscywgbW9kZWwgPT4gbW9kZWwuJGFmdGVySW5zZXJ0KGJ1aWxkZXIuY29udGV4dCgpKSwgcmVzdWx0KTtcbiAgfVxufVxuIl19