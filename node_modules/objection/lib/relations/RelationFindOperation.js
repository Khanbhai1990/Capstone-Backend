'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = undefined;

var _keys = require('babel-runtime/core-js/object/keys');

var _keys2 = _interopRequireDefault(_keys);

var _create = require('babel-runtime/core-js/object/create');

var _create2 = _interopRequireDefault(_create);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _possibleConstructorReturn2 = require('babel-runtime/helpers/possibleConstructorReturn');

var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);

var _inherits2 = require('babel-runtime/helpers/inherits');

var _inherits3 = _interopRequireDefault(_inherits2);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _FindOperation2 = require('../queryBuilder/operations/FindOperation');

var _FindOperation3 = _interopRequireDefault(_FindOperation2);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var RelationFindOperation = function (_FindOperation) {
  (0, _inherits3.default)(RelationFindOperation, _FindOperation);

  function RelationFindOperation(name, opt) {
    (0, _classCallCheck3.default)(this, RelationFindOperation);

    var _this = (0, _possibleConstructorReturn3.default)(this, _FindOperation.call(this, name, opt));

    _this.relation = opt.relation;
    _this.owners = opt.owners;
    _this.alwaysReturnArray = false;
    _this.omitProps = [];
    return _this;
  }

  RelationFindOperation.prototype.clone = function clone() {
    var _FindOperation$protot;

    for (var _len = arguments.length, args = Array(_len), _key = 0; _key < _len; _key++) {
      args[_key] = arguments[_key];
    }

    var copy = (_FindOperation$protot = _FindOperation.prototype.clone).call.apply(_FindOperation$protot, [this].concat(args));

    copy.relation = this.relation;
    copy.owners = this.owners;
    copy.alwaysReturnArray = this.alwaysReturnArray;
    copy.omitProps = this.omitProps;

    return copy;
  };

  RelationFindOperation.prototype.onBeforeBuild = function onBeforeBuild(builder) {
    var ids = new Array(this.owners.length);

    for (var i = 0, l = this.owners.length; i < l; ++i) {
      ids[i] = this.owners[i].$values(this.relation.ownerProp);
    }

    this.relation.findQuery(builder, {
      ownerIds: _lodash2.default.uniqBy(ids, join)
    });

    this.selectMissingJoinColumns(builder);
  };

  RelationFindOperation.prototype.onAfter = function onAfter(builder, related) {
    this.omitImplicitJoinProps(related);
    return _FindOperation.prototype.onAfter.call(this, builder, related);
  };

  RelationFindOperation.prototype.onAfterInternal = function onAfterInternal(builder, related) {
    var owners = this.owners;
    var isOneToOne = this.relation.isOneToOne();
    var relatedByOwnerId = (0, _create2.default)(null);

    for (var i = 0, l = related.length; i < l; ++i) {
      var rel = related[i];
      var key = rel.$propKey(this.relation.relatedProp);
      var arr = relatedByOwnerId[key];

      if (!arr) {
        arr = [];
        relatedByOwnerId[key] = arr;
      }

      arr.push(rel);
    }

    for (var _i = 0, _l = owners.length; _i < _l; ++_i) {
      var own = owners[_i];
      var _key2 = own.$propKey(this.relation.ownerProp);
      var _related = relatedByOwnerId[_key2];

      if (isOneToOne) {
        own[this.relation.name] = _related && _related[0] || null;
      } else {
        own[this.relation.name] = _related || [];
      }
    }

    if (!this.alwaysReturnArray && this.relation.isOneToOne() && related.length <= 1) {
      return related[0] || undefined;
    } else {
      return related;
    }
  };

  RelationFindOperation.prototype.selectMissingJoinColumns = function selectMissingJoinColumns(builder) {
    var addedSelects = {};
    var cols = this.relation.fullRelatedCol();

    for (var c = 0, lc = cols.length; c < lc; ++c) {
      var col = cols[c];

      if (!builder.hasSelection(col) && !addedSelects[col]) {
        this.omitProps.push(this.relation.relatedProp[c]);
        addedSelects[col] = true;
      }
    }

    var selects = (0, _keys2.default)(addedSelects);

    if (selects.length) {
      builder.select(selects);
    }
  };

  RelationFindOperation.prototype.omitImplicitJoinProps = function omitImplicitJoinProps(related) {
    var relatedModelClass = this.relation.relatedModelClass;

    if (!this.omitProps.length || !related) {
      return related;
    }

    if (!Array.isArray(related)) {
      return this.omitImplicitJoinPropsFromOne(relatedModelClass, related);
    }

    if (!related.length) {
      return related;
    }

    for (var i = 0, l = related.length; i < l; ++i) {
      this.omitImplicitJoinPropsFromOne(relatedModelClass, related[i]);
    }

    return related;
  };

  RelationFindOperation.prototype.omitImplicitJoinPropsFromOne = function omitImplicitJoinPropsFromOne(relatedModelClass, model) {
    for (var c = 0, lc = this.omitProps.length; c < lc; ++c) {
      relatedModelClass.omitImpl(model, this.omitProps[c]);
    }

    return model;
  };

  return RelationFindOperation;
}(_FindOperation3.default);

exports.default = RelationFindOperation;


function join(arr) {
  return arr.join();
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIlJlbGF0aW9uRmluZE9wZXJhdGlvbi5qcyJdLCJuYW1lcyI6WyJSZWxhdGlvbkZpbmRPcGVyYXRpb24iLCJuYW1lIiwib3B0IiwicmVsYXRpb24iLCJvd25lcnMiLCJhbHdheXNSZXR1cm5BcnJheSIsIm9taXRQcm9wcyIsImNsb25lIiwiYXJncyIsImNvcHkiLCJvbkJlZm9yZUJ1aWxkIiwiYnVpbGRlciIsImlkcyIsIkFycmF5IiwibGVuZ3RoIiwiaSIsImwiLCIkdmFsdWVzIiwib3duZXJQcm9wIiwiZmluZFF1ZXJ5Iiwib3duZXJJZHMiLCJ1bmlxQnkiLCJqb2luIiwic2VsZWN0TWlzc2luZ0pvaW5Db2x1bW5zIiwib25BZnRlciIsInJlbGF0ZWQiLCJvbWl0SW1wbGljaXRKb2luUHJvcHMiLCJvbkFmdGVySW50ZXJuYWwiLCJpc09uZVRvT25lIiwicmVsYXRlZEJ5T3duZXJJZCIsInJlbCIsImtleSIsIiRwcm9wS2V5IiwicmVsYXRlZFByb3AiLCJhcnIiLCJwdXNoIiwib3duIiwidW5kZWZpbmVkIiwiYWRkZWRTZWxlY3RzIiwiY29scyIsImZ1bGxSZWxhdGVkQ29sIiwiYyIsImxjIiwiY29sIiwiaGFzU2VsZWN0aW9uIiwic2VsZWN0cyIsInNlbGVjdCIsInJlbGF0ZWRNb2RlbENsYXNzIiwiaXNBcnJheSIsIm9taXRJbXBsaWNpdEpvaW5Qcm9wc0Zyb21PbmUiLCJtb2RlbCIsIm9taXRJbXBsIl0sIm1hcHBpbmdzIjoiOzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQTs7OztBQUNBOzs7Ozs7SUFFcUJBLHFCOzs7QUFFbkIsaUNBQVlDLElBQVosRUFBa0JDLEdBQWxCLEVBQXVCO0FBQUE7O0FBQUEsK0RBQ3JCLDBCQUFNRCxJQUFOLEVBQVlDLEdBQVosQ0FEcUI7O0FBR3JCLFVBQUtDLFFBQUwsR0FBZ0JELElBQUlDLFFBQXBCO0FBQ0EsVUFBS0MsTUFBTCxHQUFjRixJQUFJRSxNQUFsQjtBQUNBLFVBQUtDLGlCQUFMLEdBQXlCLEtBQXpC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LENBQWtDRixpQkFBbEMsRUFBcUR0QixPQUFyRCxDQUFQO0FBQ0Q7O0FBRUQsUUFBSSxDQUFDQSxRQUFRWCxNQUFiLEVBQXFCO0FBQ25CLGFBQU9XLE9BQVA7QUFDRDs7QUFFRCxTQUFLLElBQUlWLElBQUksQ0FBUixFQUFXQyxJQUFJUyxRQUFRWCxNQUE1QixFQUFvQ0MsSUFBSUMsQ0FBeEMsRUFBMkMsRUFBRUQsQ0FBN0MsRUFBZ0Q7QUFDOUMsV0FBS2tDLDRCQUFMLENBQWtDRixpQkFBbEMsRUFBcUR0QixRQUFRVixDQUFSLENBQXJEO0FBQ0Q7O0FBRUQsV0FBT1UsT0FBUDtBQUNELEc7O2tDQUVEd0IsNEIseUNBQTZCRixpQixFQUFtQkcsSyxFQUFPO0FBQ3JELFNBQUssSUFBSVQsSUFBSSxDQUFSLEVBQVdDLEtBQUssS0FBS3BDLFNBQUwsQ0FBZVEsTUFBcEMsRUFBNEMyQixJQUFJQyxFQUFoRCxFQUFvRCxFQUFFRCxDQUF0RCxFQUF5RDtBQUN2RE0sd0JBQWtCSSxRQUFsQixDQUEyQkQsS0FBM0IsRUFBa0MsS0FBSzVDLFNBQUwsQ0FBZW1DLENBQWYsQ0FBbEM7QUFDRDs7QUFFRCxXQUFPUyxLQUFQO0FBQ0QsRzs7Ozs7a0JBOUhrQmxELHFCOzs7QUFpSXJCLFNBQVNzQixJQUFULENBQWNZLEdBQWQsRUFBbUI7QUFDakIsU0FBT0EsSUFBSVosSUFBSixFQUFQO0FBQ0QiLCJmaWxlIjoiUmVsYXRpb25GaW5kT3BlcmF0aW9uLmpzIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IF8gZnJvbSAnbG9kYXNoJztcbmltcG9ydCBGaW5kT3BlcmF0aW9uIGZyb20gJy4uL3F1ZXJ5QnVpbGRlci9vcGVyYXRpb25zL0ZpbmRPcGVyYXRpb24nO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBSZWxhdGlvbkZpbmRPcGVyYXRpb24gZXh0ZW5kcyBGaW5kT3BlcmF0aW9uIHtcblxuICBjb25zdHJ1Y3RvcihuYW1lLCBvcHQpIHtcbiAgICBzdXBlcihuYW1lLCBvcHQpO1xuXG4gICAgdGhpcy5yZWxhdGlvbiA9IG9wdC5yZWxhdGlvbjtcbiAgICB0aGlzLm93bmVycyA9IG9wdC5vd25lcnM7XG4gICAgdGhpcy5hbHdheXNSZXR1cm5BcnJheSA9IGZhbHNlO1xuICAgIHRoaXMub21pdFByb3BzID0gW107XG4gIH1cblxuICBjbG9uZSguLi5hcmdzKSB7XG4gICAgY29uc3QgY29weSA9IHN1cGVyLmNsb25lKC4uLmFyZ3MpO1xuXG4gICAgY29weS5yZWxhdGlvbiA9IHRoaXMucmVsYXRpb247XG4gICAgY29weS5vd25lcnMgPSB0aGlzLm93bmVycztcbiAgICBjb3B5LmFsd2F5c1JldHVybkFycmF5ID0gdGhpcy5hbHdheXNSZXR1cm5BcnJheTtcbiAgICBjb3B5Lm9taXRQcm9wcyA9IHRoaXMub21pdFByb3BzO1xuXG4gICAgcmV0dXJuIGNvcHk7XG4gIH1cblxuICBvbkJlZm9yZUJ1aWxkKGJ1aWxkZXIpIHtcbiAgICBsZXQgaWRzID0gbmV3IEFycmF5KHRoaXMub3duZXJzLmxlbmd0aCk7XG5cbiAgICBmb3IgKGxldCBpID0gMCwgbCA9IHRoaXMub3duZXJzLmxlbmd0aDsgaSA8IGw7ICsraSkge1xuICAgICAgaWRzW2ldID0gdGhpcy5vd25lcnNbaV0uJHZhbHVlcyh0aGlzLnJlbGF0aW9uLm93bmVyUHJvcCk7XG4gICAgfVxuXG4gICAgdGhpcy5yZWxhdGlvbi5maW5kUXVlcnkoYnVpbGRlciwge1xuICAgICAgb3duZXJJZHM6IF8udW5pcUJ5KGlkcywgam9pbilcbiAgICB9KTtcblxuICAgIHRoaXMuc2VsZWN0TWlzc2luZ0pvaW5Db2x1bW5zKGJ1aWxkZXIpO1xuICB9XG5cbiAgb25BZnRlcihidWlsZGVyLCByZWxhdGVkKSB7XG4gICAgdGhpcy5vbWl0SW1wbGljaXRKb2luUHJvcHMocmVsYXRlZCk7XG4gICAgcmV0dXJuIHN1cGVyLm9uQWZ0ZXIoYnVpbGRlciwgcmVsYXRlZCk7XG4gIH1cblxuICBvbkFmdGVySW50ZXJuYWwoYnVpbGRlciwgcmVsYXRlZCkge1xuICAgIGNvbnN0IG93bmVycyA9IHRoaXMub3duZXJzO1xuICAgIGNvbnN0IGlzT25lVG9PbmUgPSB0aGlzLnJlbGF0aW9uLmlzT25lVG9PbmUoKTtcbiAgICBjb25zdCByZWxhdGVkQnlPd25lcklkID0gT2JqZWN0LmNyZWF0ZShudWxsKTtcblxuICAgIGZvciAobGV0IGkgPSAwLCBsID0gcmVsYXRlZC5sZW5ndGg7IGkgPCBsOyArK2kpIHtcbiAgICAgIGNvbnN0IHJlbCA9IHJlbGF0ZWRbaV07XG4gICAgICBjb25zdCBrZXkgPSByZWwuJHByb3BLZXkodGhpcy5yZWxhdGlvbi5yZWxhdGVkUHJvcCk7XG4gICAgICBsZXQgYXJyID0gcmVsYXRlZEJ5T3duZXJJZFtrZXldO1xuXG4gICAgICBpZiAoIWFycikge1xuICAgICAgICBhcnIgPSBbXTtcbiAgICAgICAgcmVsYXRlZEJ5T3duZXJJZFtrZXldID0gYXJyO1xuICAgICAgfVxuXG4gICAgICBhcnIucHVzaChyZWwpO1xuICAgIH1cblxuICAgIGZvciAobGV0IGkgPSAwLCBsID0gb3duZXJzLmxlbmd0aDsgaSA8IGw7ICsraSkge1xuICAgICAgY29uc3Qgb3duID0gb3duZXJzW2ldO1xuICAgICAgY29uc3Qga2V5ID0gb3duLiRwcm9wS2V5KHRoaXMucmVsYXRpb24ub3duZXJQcm9wKTtcbiAgICAgIGNvbnN0IHJlbGF0ZWQgPSByZWxhdGVkQnlPd25lcklkW2tleV07XG5cbiAgICAgIGlmIChpc09uZVRvT25lKSB7XG4gICAgICAgIG93blt0aGlzLnJlbGF0aW9uLm5hbWVdID0gKHJlbGF0ZWQgJiYgcmVsYXRlZFswXSkgfHwgbnVsbDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG93blt0aGlzLnJlbGF0aW9uLm5hbWVdID0gcmVsYXRlZCB8fCBbXTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAoIXRoaXMuYWx3YXlzUmV0dXJuQXJyYXkgJiYgdGhpcy5yZWxhdGlvbi5pc09uZVRvT25lKCkgJiYgcmVsYXRlZC5sZW5ndGggPD0gMSkge1xuICAgICAgcmV0dXJuIHJlbGF0ZWRbMF0gfHwgdW5kZWZpbmVkO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gcmVsYXRlZDtcbiAgICB9XG4gIH1cblxuICBzZWxlY3RNaXNzaW5nSm9pbkNvbHVtbnMoYnVpbGRlcikge1xuICAgIGNvbnN0IGFkZGVkU2VsZWN0cyA9IHt9O1xuICAgIGNvbnN0IGNvbHMgPSB0aGlzLnJlbGF0aW9uLmZ1bGxSZWxhdGVkQ29sKCk7XG5cbiAgICBmb3IgKGxldCBjID0gMCwgbGMgPSBjb2xzLmxlbmd0aDsgYyA8IGxjOyArK2MpIHtcbiAgICAgIGNvbnN0IGNvbCA9IGNvbHNbY107XG5cbiAgICAgIGlmICghYnVpbGRlci5oYXNTZWxlY3Rpb24oY29sKSAmJiAhYWRkZWRTZWxlY3RzW2NvbF0pIHtcbiAgICAgICAgdGhpcy5vbWl0UHJvcHMucHVzaCh0aGlzLnJlbGF0aW9uLnJlbGF0ZWRQcm9wW2NdKTtcbiAgICAgICAgYWRkZWRTZWxlY3RzW2NvbF0gPSB0cnVlO1xuICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IHNlbGVjdHMgPSBPYmplY3Qua2V5cyhhZGRlZFNlbGVjdHMpO1xuXG4gICAgaWYgKHNlbGVjdHMubGVuZ3RoKSB7XG4gICAgICBidWlsZGVyLnNlbGVjdChzZWxlY3RzKTtcbiAgICB9XG4gIH1cblxuICBvbWl0SW1wbGljaXRKb2luUHJvcHMocmVsYXRlZCkge1xuICAgIGNvbnN0IHJlbGF0ZWRNb2RlbENsYXNzID0gdGhpcy5yZWxhdGlvbi5yZWxhdGVkTW9kZWxDbGFzcztcblxuICAgIGlmICghdGhpcy5vbWl0UHJvcHMubGVuZ3RoIHx8ICFyZWxhdGVkKSB7XG4gICAgICByZXR1cm4gcmVsYXRlZDtcbiAgICB9XG5cbiAgICBpZiAoIUFycmF5LmlzQXJyYXkocmVsYXRlZCkpIHtcbiAgICAgIHJldHVybiB0aGlzLm9taXRJbXBsaWNpdEpvaW5Qcm9wc0Zyb21PbmUocmVsYXRlZE1vZGVsQ2xhc3MsIHJlbGF0ZWQpO1xuICAgIH1cblxuICAgIGlmICghcmVsYXRlZC5sZW5ndGgpIHtcbiAgICAgIHJldHVybiByZWxhdGVkO1xuICAgIH1cblxuICAgIGZvciAobGV0IGkgPSAwLCBsID0gcmVsYXRlZC5sZW5ndGg7IGkgPCBsOyArK2kpIHtcbiAgICAgIHRoaXMub21pdEltcGxpY2l0Sm9pblByb3BzRnJvbU9uZShyZWxhdGVkTW9kZWxDbGFzcywgcmVsYXRlZFtpXSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlbGF0ZWQ7XG4gIH1cblxuICBvbWl0SW1wbGljaXRKb2luUHJvcHNGcm9tT25lKHJlbGF0ZWRNb2RlbENsYXNzLCBtb2RlbCkge1xuICAgIGZvciAobGV0IGMgPSAwLCBsYyA9IHRoaXMub21pdFByb3BzLmxlbmd0aDsgYyA8IGxjOyArK2MpIHtcbiAgICAgIHJlbGF0ZWRNb2RlbENsYXNzLm9taXRJbXBsKG1vZGVsLCB0aGlzLm9taXRQcm9wc1tjXSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIG1vZGVsO1xuICB9XG59XG5cbmZ1bmN0aW9uIGpvaW4oYXJyKSB7XG4gIHJldHVybiBhcnIuam9pbigpO1xufSJdfQ==