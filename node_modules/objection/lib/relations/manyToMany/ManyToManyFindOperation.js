'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = undefined;

var _create = require('babel-runtime/core-js/object/create');

var _create2 = _interopRequireDefault(_create);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _possibleConstructorReturn2 = require('babel-runtime/helpers/possibleConstructorReturn');

var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);

var _inherits2 = require('babel-runtime/helpers/inherits');

var _inherits3 = _interopRequireDefault(_inherits2);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _RelationFindOperation = require('../RelationFindOperation');

var _RelationFindOperation2 = _interopRequireDefault(_RelationFindOperation);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var ownerJoinColumnAliasPrefix = 'objectiontmpjoin';

var ManyToManyFindOperation = function (_RelationFindOperatio) {
  (0, _inherits3.default)(ManyToManyFindOperation, _RelationFindOperatio);

  function ManyToManyFindOperation(name, opt) {
    (0, _classCallCheck3.default)(this, ManyToManyFindOperation);

    var _this = (0, _possibleConstructorReturn3.default)(this, _RelationFindOperatio.call(this, name, opt));

    _this.ownerJoinColumnAlias = new Array(_this.relation.joinTableOwnerCol.length);

    for (var i = 0, l = _this.relation.joinTableOwnerCol.length; i < l; ++i) {
      _this.ownerJoinColumnAlias[i] = ownerJoinColumnAliasPrefix + i;
    }
    return _this;
  }

  ManyToManyFindOperation.prototype.clone = function clone() {
    var _RelationFindOperatio2;

    for (var _len = arguments.length, args = Array(_len), _key = 0; _key < _len; _key++) {
      args[_key] = arguments[_key];
    }

    var copy = (_RelationFindOperatio2 = _RelationFindOperatio.prototype.clone).call.apply(_RelationFindOperatio2, [this].concat(args));

    copy.ownerJoinColumnAlias = this.ownerJoinColumnAlias;

    return copy;
  };

  ManyToManyFindOperation.prototype.onBeforeBuild = function onBeforeBuild(builder) {
    var relatedModelClass = this.relation.relatedModelClass;
    var ids = new Array(this.owners.length);

    for (var i = 0, l = this.owners.length; i < l; ++i) {
      ids[i] = this.owners[i].$values(this.relation.ownerProp);
    }

    if (!builder.has(builder.constructor.SelectSelector)) {
      // If the user hasn't specified a select clause, select the related model's columns.
      // If we don't do this we also get the join table's columns.
      builder.select(relatedModelClass.tableName + '.*');

      // Also select all extra columns.
      for (var _i = 0, _l = this.relation.joinTableExtras.length; _i < _l; ++_i) {
        var extra = this.relation.joinTableExtras[_i];
        var joinTable = this.relation.joinTable;

        builder.select(joinTable + '.' + extra.joinTableCol + ' as ' + extra.aliasCol);
      }
    }

    this.relation.findQuery(builder, {
      ownerIds: _lodash2.default.uniqBy(ids, join)
    });

    var fullJoinTableOwnerCol = this.relation.fullJoinTableOwnerCol();
    // We must select the owner join columns so that we know for which owner model the related
    // models belong to after the requests.
    for (var _i2 = 0, _l2 = fullJoinTableOwnerCol.length; _i2 < _l2; ++_i2) {
      builder.select(fullJoinTableOwnerCol[_i2] + ' as ' + this.ownerJoinColumnAlias[_i2]);

      // Mark them to be omitted later.
      this.omitProps.push(relatedModelClass.columnNameToPropertyName(this.ownerJoinColumnAlias[_i2]));
    }

    this.selectMissingJoinColumns(builder);
  };

  ManyToManyFindOperation.prototype.onAfterInternal = function onAfterInternal(builder, related) {
    var isOneToOne = this.relation.isOneToOne();
    var relatedByOwnerId = (0, _create2.default)(null);

    for (var i = 0, l = related.length; i < l; ++i) {
      var rel = related[i];
      var key = rel.$propKey(this.ownerJoinColumnAlias);
      var arr = relatedByOwnerId[key];

      if (!arr) {
        arr = [];
        relatedByOwnerId[key] = arr;
      }

      arr.push(rel);
    }

    for (var _i3 = 0, _l3 = this.owners.length; _i3 < _l3; ++_i3) {
      var own = this.owners[_i3];
      var _key2 = own.$propKey(this.relation.ownerProp);
      var _related = relatedByOwnerId[_key2];

      if (isOneToOne) {
        own[this.relation.name] = _related && _related[0] || null;
      } else {
        own[this.relation.name] = _related || [];
      }
    }

    if (this.alwaysReturnArray) {
      return related;
    } else {
      return isOneToOne ? related[0] || undefined : related;
    }
  };

  return ManyToManyFindOperation;
}(_RelationFindOperation2.default);

exports.default = ManyToManyFindOperation;


function join(arr) {
  return arr.join();
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIk1hbnlUb01hbnlGaW5kT3BlcmF0aW9uLmpzIl0sIm5hbWVzIjpbIm93bmVySm9pbkNvbHVtbkFsaWFzUHJlZml4IiwiTWFueVRvTWFueUZpbmRPcGVyYXRpb24iLCJuYW1lIiwib3B0Iiwib3duZXJKb2luQ29sdW1uQWxpYXMiLCJBcnJheSIsInJlbGF0aW9uIiwiam9pblRhYmxlT3duZXJDb2wiLCJsZW5ndGgiLCJpIiwibCIsImNsb25lIiwiYXJncyIsImNvcHkiLCJvbkJlZm9yZUJ1aWxkIiwiYnVpbGRlciIsInJlbGF0ZWRNb2RlbENsYXNzIiwiaWRzIiwib3duZXJzIiwiJHZhbHVlcyIsIm93bmVyUHJvcCIsImhhcyIsImNvbnN0cnVjdG9yIiwiU2VsZWN0U2VsZWN0b3IiLCJzZWxlY3QiLCJ0YWJsZU5hbWUiLCJqb2luVGFibGVFeHRyYXMiLCJleHRyYSIsImpvaW5UYWJsZSIsImpvaW5UYWJsZUNvbCIsImFsaWFzQ29sIiwiZmluZFF1ZXJ5Iiwib3duZXJJZHMiLCJ1bmlxQnkiLCJqb2luIiwiZnVsbEpvaW5UYWJsZU93bmVyQ29sIiwib21pdFByb3BzIiwicHVzaCIsImNvbHVtbk5hbWVUb1Byb3BlcnR5TmFtZSIsInNlbGVjdE1pc3NpbmdKb2luQ29sdW1ucyIsIm9uQWZ0ZXJJbnRlcm5hbCIsInJlbGF0ZWQiLCJpc09uZVRvT25lIiwicmVsYXRlZEJ5T3duZXJJZCIsInJlbCIsImtleSIsIiRwcm9wS2V5IiwiYXJyIiwib3duIiwiYWx3YXlzUmV0dXJuQXJyYXkiLCJ1bmRlZmluZWQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBQUE7Ozs7QUFDQTs7Ozs7O0FBRUEsSUFBTUEsNkJBQTZCLGtCQUFuQzs7SUFFcUJDLHVCOzs7QUFFbkIsbUNBQVlDLElBQVosRUFBa0JDLEdBQWxCLEVBQXVCO0FBQUE7O0FBQUEsK0RBQ3JCLGlDQUFNRCxJQUFOLEVBQVlDLEdBQVosQ0FEcUI7O0FBR3JCLFVBQUtDLG9CQUFMLEdBQTRC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dUI7OztBQWdHckIsU0FBU2lDLElBQVQsQ0FBY2EsR0FBZCxFQUFtQjtBQUNqQixTQUFPQSxJQUFJYixJQUFKLEVBQVA7QUFDRCIsImZpbGUiOiJNYW55VG9NYW55RmluZE9wZXJhdGlvbi5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgUmVsYXRpb25GaW5kT3BlcmF0aW9uIGZyb20gJy4uL1JlbGF0aW9uRmluZE9wZXJhdGlvbic7XG5cbmNvbnN0IG93bmVySm9pbkNvbHVtbkFsaWFzUHJlZml4ID0gJ29iamVjdGlvbnRtcGpvaW4nO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBNYW55VG9NYW55RmluZE9wZXJhdGlvbiBleHRlbmRzIFJlbGF0aW9uRmluZE9wZXJhdGlvbiB7XG5cbiAgY29uc3RydWN0b3IobmFtZSwgb3B0KSB7XG4gICAgc3VwZXIobmFtZSwgb3B0KTtcblxuICAgIHRoaXMub3duZXJKb2luQ29sdW1uQWxpYXMgPSBuZXcgQXJyYXkodGhpcy5yZWxhdGlvbi5qb2luVGFibGVPd25lckNvbC5sZW5ndGgpO1xuXG4gICAgZm9yIChsZXQgaSA9IDAsIGwgPSB0aGlzLnJlbGF0aW9uLmpvaW5UYWJsZU93bmVyQ29sLmxlbmd0aDsgaSA8IGw7ICsraSkge1xuICAgICAgdGhpcy5vd25lckpvaW5Db2x1bW5BbGlhc1tpXSA9IG93bmVySm9pbkNvbHVtbkFsaWFzUHJlZml4ICsgaTtcbiAgICB9XG4gIH1cblxuICBjbG9uZSguLi5hcmdzKSB7XG4gICAgY29uc3QgY29weSA9IHN1cGVyLmNsb25lKC4uLmFyZ3MpO1xuXG4gICAgY29weS5vd25lckpvaW5Db2x1bW5BbGlhcyA9IHRoaXMub3duZXJKb2luQ29sdW1uQWxpYXM7XG5cbiAgICByZXR1cm4gY29weTtcbiAgfVxuXG4gIG9uQmVmb3JlQnVpbGQoYnVpbGRlcikge1xuICAgIGNvbnN0IHJlbGF0ZWRNb2RlbENsYXNzID0gdGhpcy5yZWxhdGlvbi5yZWxhdGVkTW9kZWxDbGFzcztcbiAgICBjb25zdCBpZHMgPSBuZXcgQXJyYXkodGhpcy5vd25lcnMubGVuZ3RoKTtcblxuICAgIGZvciAobGV0IGkgPSAwLCBsID0gdGhpcy5vd25lcnMubGVuZ3RoOyBpIDwgbDsgKytpKSB7XG4gICAgICBpZHNbaV0gPSB0aGlzLm93bmVyc1tpXS4kdmFsdWVzKHRoaXMucmVsYXRpb24ub3duZXJQcm9wKTtcbiAgICB9XG5cbiAgICBpZiAoIWJ1aWxkZXIuaGFzKGJ1aWxkZXIuY29uc3RydWN0b3IuU2VsZWN0U2VsZWN0b3IpKSB7XG4gICAgICAvLyBJZiB0aGUgdXNlciBoYXNuJ3Qgc3BlY2lmaWVkIGEgc2VsZWN0IGNsYXVzZSwgc2VsZWN0IHRoZSByZWxhdGVkIG1vZGVsJ3MgY29sdW1ucy5cbiAgICAgIC8vIElmIHdlIGRvbid0IGRvIHRoaXMgd2UgYWxzbyBnZXQgdGhlIGpvaW4gdGFibGUncyBjb2x1bW5zLlxuICAgICAgYnVpbGRlci5zZWxlY3QocmVsYXRlZE1vZGVsQ2xhc3MudGFibGVOYW1lICsgJy4qJyk7XG5cbiAgICAgIC8vIEFsc28gc2VsZWN0IGFsbCBleHRyYSBjb2x1bW5zLlxuICAgICAgZm9yIChsZXQgaSA9IDAsIGwgPSB0aGlzLnJlbGF0aW9uLmpvaW5UYWJsZUV4dHJhcy5sZW5ndGg7IGkgPCBsOyArK2kpIHtcbiAgICAgICAgY29uc3QgZXh0cmEgPSB0aGlzLnJlbGF0aW9uLmpvaW5UYWJsZUV4dHJhc1tpXTtcbiAgICAgICAgY29uc3Qgam9pblRhYmxlID0gdGhpcy5yZWxhdGlvbi5qb2luVGFibGU7XG5cbiAgICAgICAgYnVpbGRlci5zZWxlY3QoYCR7am9pblRhYmxlfS4ke2V4dHJhLmpvaW5UYWJsZUNvbH0gYXMgJHtleHRyYS5hbGlhc0NvbH1gKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICB0aGlzLnJlbGF0aW9uLmZpbmRRdWVyeShidWlsZGVyLCB7XG4gICAgICBvd25lcklkczogXy51bmlxQnkoaWRzLCBqb2luKVxuICAgIH0pO1xuXG4gICAgY29uc3QgZnVsbEpvaW5UYWJsZU93bmVyQ29sID0gdGhpcy5yZWxhdGlvbi5mdWxsSm9pblRhYmxlT3duZXJDb2woKTtcbiAgICAvLyBXZSBtdXN0IHNlbGVjdCB0aGUgb3duZXIgam9pbiBjb2x1bW5zIHNvIHRoYXQgd2Uga25vdyBmb3Igd2hpY2ggb3duZXIgbW9kZWwgdGhlIHJlbGF0ZWRcbiAgICAvLyBtb2RlbHMgYmVsb25nIHRvIGFmdGVyIHRoZSByZXF1ZXN0cy5cbiAgICBmb3IgKGxldCBpID0gMCwgbCA9IGZ1bGxKb2luVGFibGVPd25lckNvbC5sZW5ndGg7IGkgPCBsOyArK2kpIHtcbiAgICAgIGJ1aWxkZXIuc2VsZWN0KGZ1bGxKb2luVGFibGVPd25lckNvbFtpXSArICcgYXMgJyArIHRoaXMub3duZXJKb2luQ29sdW1uQWxpYXNbaV0pO1xuXG4gICAgICAvLyBNYXJrIHRoZW0gdG8gYmUgb21pdHRlZCBsYXRlci5cbiAgICAgIHRoaXMub21pdFByb3BzLnB1c2gocmVsYXRlZE1vZGVsQ2xhc3MuY29sdW1uTmFtZVRvUHJvcGVydHlOYW1lKHRoaXMub3duZXJKb2luQ29sdW1uQWxpYXNbaV0pKTtcbiAgICB9XG5cbiAgICB0aGlzLnNlbGVjdE1pc3NpbmdKb2luQ29sdW1ucyhidWlsZGVyKTtcbiAgfVxuXG4gIG9uQWZ0ZXJJbnRlcm5hbChidWlsZGVyLCByZWxhdGVkKSB7XG4gICAgY29uc3QgaXNPbmVUb09uZSA9IHRoaXMucmVsYXRpb24uaXNPbmVUb09uZSgpO1xuICAgIGNvbnN0IHJlbGF0ZWRCeU93bmVySWQgPSBPYmplY3QuY3JlYXRlKG51bGwpO1xuXG4gICAgZm9yIChsZXQgaSA9IDAsIGwgPSByZWxhdGVkLmxlbmd0aDsgaSA8IGw7ICsraSkge1xuICAgICAgY29uc3QgcmVsID0gcmVsYXRlZFtpXTtcbiAgICAgIGNvbnN0IGtleSA9IHJlbC4kcHJvcEtleSh0aGlzLm93bmVySm9pbkNvbHVtbkFsaWFzKTtcbiAgICAgIGxldCBhcnIgPSByZWxhdGVkQnlPd25lcklkW2tleV07XG5cbiAgICAgIGlmICghYXJyKSB7XG4gICAgICAgIGFyciA9IFtdO1xuICAgICAgICByZWxhdGVkQnlPd25lcklkW2tleV0gPSBhcnI7XG4gICAgICB9XG5cbiAgICAgIGFyci5wdXNoKHJlbCk7XG4gICAgfVxuXG4gICAgZm9yIChsZXQgaSA9IDAsIGwgPSB0aGlzLm93bmVycy5sZW5ndGg7IGkgPCBsOyArK2kpIHtcbiAgICAgIGNvbnN0IG93biA9IHRoaXMub3duZXJzW2ldO1xuICAgICAgY29uc3Qga2V5ID0gb3duLiRwcm9wS2V5KHRoaXMucmVsYXRpb24ub3duZXJQcm9wKTtcbiAgICAgIGNvbnN0IHJlbGF0ZWQgPSByZWxhdGVkQnlPd25lcklkW2tleV07XG5cbiAgICAgIGlmIChpc09uZVRvT25lKSB7XG4gICAgICAgIG93blt0aGlzLnJlbGF0aW9uLm5hbWVdID0gKHJlbGF0ZWQgJiYgcmVsYXRlZFswXSkgfHwgbnVsbDtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIG93blt0aGlzLnJlbGF0aW9uLm5hbWVdID0gcmVsYXRlZCB8fCBbXTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAodGhpcy5hbHdheXNSZXR1cm5BcnJheSkge1xuICAgICAgcmV0dXJuIHJlbGF0ZWQ7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBpc09uZVRvT25lID8gcmVsYXRlZFswXSB8fCB1bmRlZmluZWQgOiByZWxhdGVkO1xuICAgIH1cbiAgfVxufVxuXG5mdW5jdGlvbiBqb2luKGFycikge1xuICByZXR1cm4gYXJyLmpvaW4oKTtcbn0iXX0=