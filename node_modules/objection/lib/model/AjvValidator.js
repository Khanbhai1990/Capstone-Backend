'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = undefined;

var _keys = require('babel-runtime/core-js/object/keys');

var _keys2 = _interopRequireDefault(_keys);

var _typeof2 = require('babel-runtime/helpers/typeof');

var _typeof3 = _interopRequireDefault(_typeof2);

var _stringify = require('babel-runtime/core-js/json/stringify');

var _stringify2 = _interopRequireDefault(_stringify);

var _create = require('babel-runtime/core-js/object/create');

var _create2 = _interopRequireDefault(_create);

var _classCallCheck2 = require('babel-runtime/helpers/classCallCheck');

var _classCallCheck3 = _interopRequireDefault(_classCallCheck2);

var _possibleConstructorReturn2 = require('babel-runtime/helpers/possibleConstructorReturn');

var _possibleConstructorReturn3 = _interopRequireDefault(_possibleConstructorReturn2);

var _inherits2 = require('babel-runtime/helpers/inherits');

var _inherits3 = _interopRequireDefault(_inherits2);

var _lodash = require('lodash');

var _lodash2 = _interopRequireDefault(_lodash);

var _ajv = require('ajv');

var _ajv2 = _interopRequireDefault(_ajv);

var _Model = require('./Model');

var _Model2 = _interopRequireDefault(_Model);

var _Validator2 = require('./Validator');

var _Validator3 = _interopRequireDefault(_Validator2);

var _ValidationError = require('./ValidationError');

var _ValidationError2 = _interopRequireDefault(_ValidationError);

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var AjvValidator = function (_Validator) {
  (0, _inherits3.default)(AjvValidator, _Validator);

  function AjvValidator(conf) {
    (0, _classCallCheck3.default)(this, AjvValidator);

    var _this = (0, _possibleConstructorReturn3.default)(this, _Validator.call(this));

    _this.ajv = new _ajv2.default(_lodash2.default.defaults({}, conf.options, {
      useDefaults: true
    }));

    _this.ajvNoDefaults = new _ajv2.default(_lodash2.default.assign({}, conf.options, {
      useDefaults: false
    }));

    _this.cache = (0, _create2.default)(null);

    conf.onCreateAjv(_this.ajv);
    conf.onCreateAjv(_this.ajvNoDefaults);
    return _this;
  }

  AjvValidator.prototype.beforeValidate = function beforeValidate(_ref) {
    var model = _ref.model,
        json = _ref.json,
        options = _ref.options,
        ctx = _ref.ctx;

    ctx.jsonSchema = model.constructor.getJsonSchema();

    if (model.$beforeValidate !== _Model2.default.prototype.$beforeValidate) {
      ctx.jsonSchema = _lodash2.default.cloneDeep(ctx.jsonSchema);
      ctx.jsonSchema = model.$beforeValidate(ctx.jsonSchema, json, options);
    }
  };

  AjvValidator.prototype.validate = function validate(_ref2) {
    var model = _ref2.model,
        json = _ref2.json,
        options = _ref2.options,
        ctx = _ref2.ctx;

    if (!ctx.jsonSchema) {
      return json;
    }

    var validator = this.getJsonSchemaValidator(model.constructor, ctx.jsonSchema, !!options.patch);

    if (!options.mutable && !options.patch && this.setsDefaultValues(ctx.jsonSchema)) {
      json = _lodash2.default.cloneDeep(json);
    }

    validator(json);

    if (validator.errors) {
      throw parseValidationError(validator.errors);
    }

    return json;
  };

  AjvValidator.prototype.getJsonSchemaValidator = function getJsonSchemaValidator(ModelClass, jsonSchema, skipRequired) {
    var key = jsonSchema === ModelClass.getJsonSchema() ? 'default' : (0, _stringify2.default)(jsonSchema);

    var validators = this.cache[key];

    if (!validators) {
      validators = {};
      this.cache[key] = validators;
    }

    var validator = validators[skipRequired];

    if (!validator) {
      validator = this.compileJsonSchemaValidator(jsonSchema, skipRequired);
      validators[skipRequired] = validator;
    }

    return validator;
  };

  AjvValidator.prototype.compileJsonSchemaValidator = function compileJsonSchemaValidator(jsonSchema, skipRequired) {
    var origRequired = void 0;

    try {
      if (skipRequired) {
        origRequired = jsonSchema.required;
        jsonSchema.required = [];
        return this.ajvNoDefaults.compile(jsonSchema);
      } else {
        return this.ajv.compile(jsonSchema);
      }
    } finally {
      if (skipRequired) {
        jsonSchema.required = origRequired;
      }
    }
  };

  AjvValidator.prototype.setsDefaultValues = function setsDefaultValues(jsonSchema) {
    return jsonSchema && jsonSchema.properties && hasDefaults(jsonSchema.properties);
  };

  return AjvValidator;
}(_Validator3.default);

exports.default = AjvValidator;


function parseValidationError(errors) {
  var errorHash = {};
  var index = 0;

  for (var i = 0; i < errors.length; ++i) {
    var error = errors[i];
    var key = error.dataPath.substring(1);

    if (!key) {
      var match = /should have required property '(.+)'/.exec(error.message);
      if (match && match.length > 1) {
        key = match[1];
      }
    }

    if (!key && error.params && error.params.additionalProperty) {
      key = error.params.additionalProperty;
    }

    if (!key) {
      key = (index++).toString();
    }

    errorHash[key] = [{
      message: error.message,
      keyword: error.keyword,
      params: error.params
    }];
  }

  return new _ValidationError2.default(errorHash);
}

function hasDefaults(obj) {
  if (Array.isArray(obj)) {
    return arrayHasDefaults(obj);
  } else {
    return objectHasDefaults(obj);
  }
}

function arrayHasDefaults(arr) {
  for (var i = 0, l = arr.length; i < l; ++i) {
    var val = arr[i];

    if (val && (typeof val === 'undefined' ? 'undefined' : (0, _typeof3.default)(val)) === 'object' && hasDefaults(val)) {
      return true;
    }
  }

  return false;
}

function objectHasDefaults(obj) {
  var keys = (0, _keys2.default)(obj);

  for (var i = 0, l = keys.length; i < l; ++i) {
    var key = keys[i];

    if (key === 'default') {
      return true;
    } else {
      var val = obj[key];

      if (val && (typeof val === 'undefined' ? 'undefined' : (0, _typeof3.default)(val)) === 'object' && hasDefaults(val)) {
        return true;
      }
    }
  }

  return false;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIkFqdlZhbGlkYXRvci5qcyJdLCJuYW1lcyI6WyJBanZWYWxpZGF0b3IiLCJjb25mIiwiYWp2IiwiZGVmYXVsdHMiLCJvcHRpb25zIiwidXNlRGVmYXVsdHMiLCJhanZOb0RlZmF1bHRzIiwiYXNzaWduIiwiY2FjaGUiLCJvbkNyZWF0ZUFqdiIsImJlZm9yZVZhbGlkYXRlIiwibW9kZWwiLCJqc29uIiwiY3R4IiwianNvblNjaGVtYSIsImNvbnN0cnVjdG9yIiwiZ2V0SnNvblNjaGVtYSIsIiRiZWZvcmVWYWxpZGF0ZSIsInByb3RvdHlwZSIsImNsb25lRGVlcCIsInZhbGlkYXRlIiwidmFsaWRhdG9yIiwiZ2V0SnNvblNjaGVtYVZhbGlkYXRvciIsInBhdGNoIiwibXV0YWJsZSIsInNldHNEZWZhdWx0VmFsdWVzIiwiZXJyb3JzIiwicGFyc2VWYWxpZGF0aW9uRXJyb3IiLCJNb2RlbENsYXNzIiwic2tpcFJlcXVpcmVkIiwia2V5IiwidmFsaWRhdG9ycyIsImNvbXBpbGVKc29uU2NoZW1hVmFsaWRhdG9yIiwib3JpZ1JlcXVpcmVkIiwicmVxdWlyZWQiLCJjb21waWxlIiwicHJvcGVydGllcyIsImhhc0RlZmF1bHRzIiwiZXJyb3JIYXNoIiwiaW5kZXgiLCJpIiwibGVuZ3RoIiwiZXJyb3IiLCJkYXRhUGF0aCIsInN1YnN0cmluZyIsIm1hdGNoIiwiZXhlYyIsIm1lc3NhZ2UiLCJwYXJhbXMiLCJhZGRpdGlvbmFsUHJvcGVydHkiLCJ0b1N0cmluZyIsImtleXdvcmQiLCJvYmoiLCJBcnJheSIsImlzQXJyYXkiLCJhcnJheUhhc0RlZmF1bHRzIiwib2JqZWN0SGFzRGVmYXVsdHMiLCJhcnIiLCJsIiwidmFsIiwia2V5cyJdLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7QUFBQTs7OztBQUNBOzs7O0FBQ0E7Ozs7QUFDQTs7OztBQUNBOzs7Ozs7SUFFcUJBLFk7OztBQUVuQix3QkFBWUMsSUFBWixFQUFrQjtBQUFBOztB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QXJDLEVBQXdDLEVBQUVsQixDQUExQyxFQUE2QztBQUMzQyxRQUFNVixNQUFNOEIsS0FBS3BCLENBQUwsQ0FBWjs7QUFFQSxRQUFJVixRQUFRLFNBQVosRUFBdUI7QUFDckIsYUFBTyxJQUFQO0FBQ0QsS0FGRCxNQUVPO0FBQ0wsVUFBTTZCLE1BQU1QLElBQUl0QixHQUFKLENBQVo7O0FBRUEsVUFBSTZCLE9BQU8sUUFBT0EsR0FBUCx1REFBT0EsR0FBUCxPQUFlLFFBQXRCLElBQWtDdEIsWUFBWXNCLEdBQVosQ0FBdEMsRUFBd0Q7QUFDdEQsZUFBTyxJQUFQO0FBQ0Q7QUFDRjtBQUNGOztBQUVELFNBQU8sS0FBUDtBQUNEIiwiZmlsZSI6IkFqdlZhbGlkYXRvci5qcyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBfIGZyb20gJ2xvZGFzaCc7XG5pbXBvcnQgQWp2IGZyb20gJ2Fqdic7XG5pbXBvcnQgTW9kZWwgZnJvbSAnLi9Nb2RlbCc7XG5pbXBvcnQgVmFsaWRhdG9yIGZyb20gJy4vVmFsaWRhdG9yJztcbmltcG9ydCBWYWxpZGF0aW9uRXJyb3IgZnJvbSAnLi9WYWxpZGF0aW9uRXJyb3InO1xuXG5leHBvcnQgZGVmYXVsdCBjbGFzcyBBanZWYWxpZGF0b3IgZXh0ZW5kcyBWYWxpZGF0b3Ige1xuXG4gIGNvbnN0cnVjdG9yKGNvbmYpIHtcbiAgICBzdXBlcigpO1xuXG4gICAgdGhpcy5hanYgPSBuZXcgQWp2KF8uZGVmYXVsdHMoe30sIGNvbmYub3B0aW9ucywge1xuICAgICAgdXNlRGVmYXVsdHM6IHRydWVcbiAgICB9KSk7XG5cbiAgICB0aGlzLmFqdk5vRGVmYXVsdHMgPSBuZXcgQWp2KF8uYXNzaWduKHt9LCBjb25mLm9wdGlvbnMsIHtcbiAgICAgIHVzZURlZmF1bHRzOiBmYWxzZVxuICAgIH0pKTtcblxuICAgIHRoaXMuY2FjaGUgPSBPYmplY3QuY3JlYXRlKG51bGwpO1xuXG4gICAgY29uZi5vbkNyZWF0ZUFqdih0aGlzLmFqdik7XG4gICAgY29uZi5vbkNyZWF0ZUFqdih0aGlzLmFqdk5vRGVmYXVsdHMpO1xuICB9XG5cbiAgYmVmb3JlVmFsaWRhdGUoe21vZGVsLCBqc29uLCBvcHRpb25zLCBjdHh9KSB7XG4gICAgY3R4Lmpzb25TY2hlbWEgPSBtb2RlbC5jb25zdHJ1Y3Rvci5nZXRKc29uU2NoZW1hKCk7XG5cbiAgICBpZiAobW9kZWwuJGJlZm9yZVZhbGlkYXRlICE9PSBNb2RlbC5wcm90b3R5cGUuJGJlZm9yZVZhbGlkYXRlKSB7XG4gICAgICBjdHguanNvblNjaGVtYSA9IF8uY2xvbmVEZWVwKGN0eC5qc29uU2NoZW1hKTtcbiAgICAgIGN0eC5qc29uU2NoZW1hID0gbW9kZWwuJGJlZm9yZVZhbGlkYXRlKGN0eC5qc29uU2NoZW1hLCBqc29uLCBvcHRpb25zKTtcbiAgICB9XG4gIH1cblxuICB2YWxpZGF0ZSh7bW9kZWwsIGpzb24sIG9wdGlvbnMsIGN0eH0pIHtcbiAgICBpZiAoIWN0eC5qc29uU2NoZW1hKSB7XG4gICAgICByZXR1cm4ganNvbjtcbiAgICB9XG5cbiAgICBjb25zdCB2YWxpZGF0b3IgPSB0aGlzLmdldEpzb25TY2hlbWFWYWxpZGF0b3IobW9kZWwuY29uc3RydWN0b3IsIGN0eC5qc29uU2NoZW1hLCAhIW9wdGlvbnMucGF0Y2gpO1xuXG4gICAgaWYgKCFvcHRpb25zLm11dGFibGUgJiYgIW9wdGlvbnMucGF0Y2ggJiYgdGhpcy5zZXRzRGVmYXVsdFZhbHVlcyhjdHguanNvblNjaGVtYSkpIHtcbiAgICAgIGpzb24gPSBfLmNsb25lRGVlcChqc29uKTtcbiAgICB9XG5cbiAgICB2YWxpZGF0b3IoanNvbik7XG5cbiAgICBpZiAodmFsaWRhdG9yLmVycm9ycykge1xuICAgICAgdGhyb3cgcGFyc2VWYWxpZGF0aW9uRXJyb3IodmFsaWRhdG9yLmVycm9ycyk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGpzb247XG4gIH1cblxuICBnZXRKc29uU2NoZW1hVmFsaWRhdG9yKE1vZGVsQ2xhc3MsIGpzb25TY2hlbWEsIHNraXBSZXF1aXJlZCkge1xuICAgIGNvbnN0IGtleSA9IGpzb25TY2hlbWEgPT09IE1vZGVsQ2xhc3MuZ2V0SnNvblNjaGVtYSgpXG4gICAgICA/ICdkZWZhdWx0J1xuICAgICAgOiBKU09OLnN0cmluZ2lmeShqc29uU2NoZW1hKTtcblxuICAgIGxldCB2YWxpZGF0b3JzID0gdGhpcy5jYWNoZVtrZXldO1xuXG4gICAgaWYgKCF2YWxpZGF0b3JzKSB7XG4gICAgICB2YWxpZGF0b3JzID0ge307XG4gICAgICB0aGlzLmNhY2hlW2tleV0gPSB2YWxpZGF0b3JzO1xuICAgIH1cblxuICAgIGxldCB2YWxpZGF0b3IgPSB2YWxpZGF0b3JzW3NraXBSZXF1aXJlZF07XG5cbiAgICBpZiAoIXZhbGlkYXRvcikge1xuICAgICAgdmFsaWRhdG9yID0gdGhpcy5jb21waWxlSnNvblNjaGVtYVZhbGlkYXRvcihqc29uU2NoZW1hLCBza2lwUmVxdWlyZWQpO1xuICAgICAgdmFsaWRhdG9yc1tza2lwUmVxdWlyZWRdID0gdmFsaWRhdG9yO1xuICAgIH1cblxuICAgIHJldHVybiB2YWxpZGF0b3I7XG4gIH1cblxuICBjb21waWxlSnNvblNjaGVtYVZhbGlkYXRvcihqc29uU2NoZW1hLCBza2lwUmVxdWlyZWQpIHtcbiAgICBsZXQgb3JpZ1JlcXVpcmVkO1xuXG4gICAgdHJ5IHtcbiAgICAgIGlmIChza2lwUmVxdWlyZWQpIHtcbiAgICAgICAgb3JpZ1JlcXVpcmVkID0ganNvblNjaGVtYS5yZXF1aXJlZDtcbiAgICAgICAganNvblNjaGVtYS5yZXF1aXJlZCA9IFtdO1xuICAgICAgICByZXR1cm4gdGhpcy5hanZOb0RlZmF1bHRzLmNvbXBpbGUoanNvblNjaGVtYSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICByZXR1cm4gdGhpcy5hanYuY29tcGlsZShqc29uU2NoZW1hKTtcbiAgICAgIH1cbiAgICB9IGZpbmFsbHkge1xuICAgICAgaWYgKHNraXBSZXF1aXJlZCkge1xuICAgICAgICBqc29uU2NoZW1hLnJlcXVpcmVkID0gb3JpZ1JlcXVpcmVkO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIHNldHNEZWZhdWx0VmFsdWVzKGpzb25TY2hlbWEpIHtcbiAgICByZXR1cm4ganNvblNjaGVtYSAmJiBqc29uU2NoZW1hLnByb3BlcnRpZXMgJiYgaGFzRGVmYXVsdHMoanNvblNjaGVtYS5wcm9wZXJ0aWVzKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBwYXJzZVZhbGlkYXRpb25FcnJvcihlcnJvcnMpIHtcbiAgY29uc3QgZXJyb3JIYXNoID0ge307XG4gIGxldCBpbmRleCA9IDA7XG5cbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBlcnJvcnMubGVuZ3RoOyArK2kpIHtcbiAgICBsZXQgZXJyb3IgPSBlcnJvcnNbaV07XG4gICAgbGV0IGtleSA9IGVycm9yLmRhdGFQYXRoLnN1YnN0cmluZygxKTtcblxuICAgIGlmICgha2V5KSB7XG4gICAgICBsZXQgbWF0Y2ggPSAvc2hvdWxkIGhhdmUgcmVxdWlyZWQgcHJvcGVydHkgJyguKyknLy5leGVjKGVycm9yLm1lc3NhZ2UpO1xuICAgICAgaWYgKG1hdGNoICYmIG1hdGNoLmxlbmd0aCA+IDEpIHtcbiAgICAgICAga2V5ID0gbWF0Y2hbMV07XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKCFrZXkgJiYgZXJyb3IucGFyYW1zICYmIGVycm9yLnBhcmFtcy5hZGRpdGlvbmFsUHJvcGVydHkpIHtcbiAgICAgIGtleSA9IGVycm9yLnBhcmFtcy5hZGRpdGlvbmFsUHJvcGVydHk7XG4gICAgfVxuXG4gICAgaWYgKCFrZXkpIHtcbiAgICAgIGtleSA9IChpbmRleCsrKS50b1N0cmluZygpO1xuICAgIH1cblxuICAgIGVycm9ySGFzaFtrZXldID0gW3tcbiAgICAgIG1lc3NhZ2U6IGVycm9yLm1lc3NhZ2UsXG4gICAgICBrZXl3b3JkOiBlcnJvci5rZXl3b3JkLFxuICAgICAgcGFyYW1zOiBlcnJvci5wYXJhbXNcbiAgICB9XTtcbiAgfVxuXG4gIHJldHVybiBuZXcgVmFsaWRhdGlvbkVycm9yKGVycm9ySGFzaCk7XG59XG5cbmZ1bmN0aW9uIGhhc0RlZmF1bHRzKG9iaikge1xuICBpZiAoQXJyYXkuaXNBcnJheShvYmopKSB7XG4gICAgcmV0dXJuIGFycmF5SGFzRGVmYXVsdHMob2JqKTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gb2JqZWN0SGFzRGVmYXVsdHMob2JqKTtcbiAgfVxufVxuXG5mdW5jdGlvbiBhcnJheUhhc0RlZmF1bHRzKGFycikge1xuICBmb3IgKGxldCBpID0gMCwgbCA9IGFyci5sZW5ndGg7IGkgPCBsOyArK2kpIHtcbiAgICBjb25zdCB2YWwgPSBhcnJbaV07XG5cbiAgICBpZiAodmFsICYmIHR5cGVvZiB2YWwgPT09ICdvYmplY3QnICYmIGhhc0RlZmF1bHRzKHZhbCkpIHtcbiAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBmYWxzZTtcbn1cblxuZnVuY3Rpb24gb2JqZWN0SGFzRGVmYXVsdHMob2JqKSB7XG4gIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyhvYmopO1xuXG4gIGZvciAobGV0IGkgPSAwLCBsID0ga2V5cy5sZW5ndGg7IGkgPCBsOyArK2kpIHtcbiAgICBjb25zdCBrZXkgPSBrZXlzW2ldO1xuXG4gICAgaWYgKGtleSA9PT0gJ2RlZmF1bHQnKSB7XG4gICAgICByZXR1cm4gdHJ1ZTtcbiAgICB9IGVsc2Uge1xuICAgICAgY29uc3QgdmFsID0gb2JqW2tleV07XG5cbiAgICAgIGlmICh2YWwgJiYgdHlwZW9mIHZhbCA9PT0gJ29iamVjdCcgJiYgaGFzRGVmYXVsdHModmFsKSkge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICByZXR1cm4gZmFsc2U7XG59XG4iXX0=