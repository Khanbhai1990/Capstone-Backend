'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});

var _map = require('babel-runtime/core-js/map');

var _map2 = _interopRequireDefault(_map);

var _keys = require('babel-runtime/core-js/object/keys');

var _keys2 = _interopRequireDefault(_keys);

exports.fromJson = fromJson;
exports.toDatabaseJson = toDatabaseJson;

var _knexUtils = require('../utils/knexUtils');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

var QueryBuilderBase = null;
var ReferenceBuilder = null;

function fromJson(_ref) {
  var modelClass = _ref.modelClass,
      json = _ref.json,
      deep = _ref.deep,
      modelOptions = _ref.modelOptions;

  lazyLoadDeps();

  if (deep) {
    return fromJsonDeep(json, modelClass, modelOptions);
  } else {
    return fromJsonShallow(json, modelClass, modelOptions);
  }
}

function toDatabaseJson(_ref2) {
  var model = _ref2.model,
      queryProps = _ref2.queryProps;

  var json = model.$toDatabaseJson();
  var modelClass = model.constructor;

  if (queryProps) {
    var query = queryProps.get(model);

    if (query) {
      var keys = (0, _keys2.default)(query);

      for (var i = 0, l = keys.length; i < l; ++i) {
        var key = keys[i];
        var queryProp = query[key];

        if (queryProp instanceof QueryBuilderBase) {
          queryProp = queryProp.build();
        }

        json[modelClass.propertyNameToColumnName(key)] = queryProp;
      }
    }
  }

  return json;
}

function fromJsonDeep(obj, modelClass, modelOptions) {
  var queryProps = new _map2.default();

  var ctx = {
    modelOptions: modelOptions,
    queryProps: queryProps
  };

  var model = splitDeep(obj, modelClass, ctx);

  return {
    model: model,
    queryProps: queryProps
  };
}

function fromJsonShallow(obj, modelClass, modelOptions) {
  var queryProps = new _map2.default();

  var model = void 0;

  if (Array.isArray(obj)) {
    model = obj.map(function (obj) {
      return doSplit(obj, modelClass, queryProps, modelOptions);
    });
  } else {
    model = doSplit(obj, modelClass, queryProps, modelOptions);
  }

  return {
    model: model,
    queryProps: queryProps
  };
}

function splitDeep(objs, modelClass, ctx) {
  if (Array.isArray(objs)) {
    return splitDeepMany(objs, modelClass, ctx);
  } else if (objs) {
    return splitDeepOne(objs, modelClass, ctx);
  }
}

function splitDeepMany(objs, modelClass, ctx) {
  var models = new Array(objs.length);

  for (var i = 0, l = objs.length; i < l; ++i) {
    models[i] = splitDeepOne(objs[i], modelClass, ctx);
  }

  return models;
}

function splitDeepOne(obj, modelClass, ctx) {
  var relations = modelClass.getRelationArray();
  var model = doSplit(obj, modelClass, ctx.queryProps, ctx.modelOptions);

  for (var i = 0, l = relations.length; i < l; ++i) {
    var relation = relations[i];
    var relatedObjs = obj[relation.name];
    var relatedModelClass = relation.relatedModelClass;

    if (relatedObjs) {
      model[relation.name] = splitDeep(relatedObjs, relatedModelClass, ctx);
    } else if (relatedObjs !== undefined) {
      model[relation.name] = relatedObjs;
    }
  }

  return model;
}

function doSplit(obj, modelClass, queryProps, modelOpt) {
  var query = {};
  var model = {};

  var keys = (0, _keys2.default)(obj);
  var relations = modelClass.getRelations();
  var hasQueries = false;

  for (var i = 0, l = keys.length; i < l; ++i) {
    var key = keys[i];
    var value = obj[key];

    if (relations[key]) {
      continue;
    }

    if (isQueryProp(value)) {
      hasQueries = true;
      query[key] = value;
    } else {
      model[key] = value;
    }
  }

  model = modelClass.fromJson(model, modelOpt);

  if (hasQueries) {
    queryProps.set(model, query);
  }

  return model;
}

function isQueryProp(value) {
  return (0, _knexUtils.isKnexQueryBuilder)(value) || (0, _knexUtils.isKnexRaw)(value) || value instanceof QueryBuilderBase || value instanceof ReferenceBuilder;
}

function lazyLoadDeps() {
  QueryBuilderBase = QueryBuilderBase || requireQueryBuilderBase();
  ReferenceBuilder = ReferenceBuilder || requireReferenceBuilder();
}

function requireQueryBuilderBase() {
  return require('../queryBuilder/QueryBuilderBase').default;
}

function requireReferenceBuilder() {
  return require('../queryBuilder/ReferenceBuilder').default;
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIm1vZGVsRmFjdG9yeS5qcyJdLCJuYW1lcyI6WyJmcm9tSnNvbiIsInRvRGF0YWJhc2VKc29uIiwiUXVlcnlCdWlsZGVyQmFzZSIsIlJlZmVyZW5jZUJ1aWxkZXIiLCJtb2RlbENsYXNzIiwianNvbiIsImRlZXAiLCJtb2RlbE9wdGlvbnMiLCJsYXp5TG9hZERlcHMiLCJmcm9tSnNvbkRlZXAiLCJmcm9tSnNvblNoYWxsb3ciLCJtb2RlbCIsInF1ZXJ5UHJvcHMiLCIkdG9EYXRhYmFzZUpzb24iLCJjb25zdHJ1Y3RvciIsInF1ZXJ5IiwiZ2V0Iiwia2V5cyIsImkiLCJsIiwibGVuZ3RoIiwia2V5IiwicXVlcnlQcm9wIiwiYnVpbGQiLCJwcm9wZXJ0eU5hbWVUb0NvbHVtbk5hbWUiLCJvYmoiLCJjdHgiLCJzcGxpdERlZXAiLCJBcnJheSIsImlzQXJyYXkiLCJtYXAiLCJkb1NwbGl0Iiwib2JqcyIsInNwbGl0RGVlcE1hbnkiLCJzcGxpdERlZXBPbmUiLCJtb2RlbHMiLCJyZWxhdGlvbnMiLCJnZXRSZWxhdGlvbkFycmF5IiwicmVsYXRpb24iLCJyZWxhdGVkT2JqcyIsIm5hbWUiLCJyZWxhdGVkTW9kZWxDbGFzcyIsInVuZGVmaW5lZCIsIm1vZGVsT3B0IiwiZ2V0UmVsYXRpb25zIiwiaGFzUXVlcmllcyIsInZhbHVlIiwiaXNRdWVyeVByb3AiLCJzZXQiLCJyZXF1aXJlUXVlcnlCdWlsZGVyQmFzZSIsInJlcXVpcmVSZWZlcmVuY2VCdWlsZGVyIiwicmVxdWlyZSIsImRlZmF1bHQiXSwibWFwcGluZ3MiOiI7Ozs7Ozs7Ozs7Ozs7O1FBS2dCQSxRLEdBQUFBLFE7UUFVQUMsYyxHQUFBQSxjOztBQWZoQjs7OztBQUVBLElBQUlDLG1CQUFtQixJQUF2QjtBQUNBLElBQUlDLG1CQUFtQixJQUF2Qjs7QUFFTyxTQUFTSCxRQUFULE9BQTBEO0FBQUEsTUFBdkNJLFVBQXVDLFFBQXZDQSxVQUF1QztBQUFBLE1BQTNCQyxJQUEyQixRQUEzQkEsSUFBMkI7QUFBQSxN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a0NBQVIsRUFBNENDLE9BQW5EO0FBQ0Q7O0FBRUQsU0FBU0YsdUJBQVQsR0FBbUM7QUFDakMsU0FBT0MsUUFBUSxrQ0FBUixFQUE0Q0MsT0FBbkQ7QUFDRCIsImZpbGUiOiJtb2RlbEZhY3RvcnkuanMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge2lzS25leFF1ZXJ5QnVpbGRlciwgaXNLbmV4UmF3fSBmcm9tICcuLi91dGlscy9rbmV4VXRpbHMnO1xuXG5sZXQgUXVlcnlCdWlsZGVyQmFzZSA9IG51bGw7XG5sZXQgUmVmZXJlbmNlQnVpbGRlciA9IG51bGw7XG5cbmV4cG9ydCBmdW5jdGlvbiBmcm9tSnNvbih7bW9kZWxDbGFzcywganNvbiwgZGVlcCwgbW9kZWxPcHRpb25zfSkge1xuICBsYXp5TG9hZERlcHMoKTtcblxuICBpZiAoZGVlcCkge1xuICAgIHJldHVybiBmcm9tSnNvbkRlZXAoanNvbiwgbW9kZWxDbGFzcywgbW9kZWxPcHRpb25zKTtcbiAgfSBlbHNlIHtcbiAgICByZXR1cm4gZnJvbUpzb25TaGFsbG93KGpzb24sIG1vZGVsQ2xhc3MsIG1vZGVsT3B0aW9ucyk7XG4gIH1cbn1cblxuZXhwb3J0IGZ1bmN0aW9uIHRvRGF0YWJhc2VKc29uKHttb2RlbCwgcXVlcnlQcm9wc30pIHtcbiAgY29uc3QganNvbiA9IG1vZGVsLiR0b0RhdGFiYXNlSnNvbigpO1xuICBjb25zdCBtb2RlbENsYXNzID0gbW9kZWwuY29uc3RydWN0b3I7XG5cbiAgaWYgKHF1ZXJ5UHJvcHMpIHtcbiAgICBjb25zdCBxdWVyeSA9IHF1ZXJ5UHJvcHMuZ2V0KG1vZGVsKTtcblxuICAgIGlmIChxdWVyeSkge1xuICAgICAgY29uc3Qga2V5cyA9IE9iamVjdC5rZXlzKHF1ZXJ5KTtcblxuICAgICAgZm9yIChsZXQgaSA9IDAsIGwgPSBrZXlzLmxlbmd0aDsgaSA8IGw7ICsraSkge1xuICAgICAgICBjb25zdCBrZXkgPSBrZXlzW2ldO1xuICAgICAgICBsZXQgcXVlcnlQcm9wID0gcXVlcnlba2V5XTtcblxuICAgICAgICBpZiAocXVlcnlQcm9wIGluc3RhbmNlb2YgUXVlcnlCdWlsZGVyQmFzZSkge1xuICAgICAgICAgIHF1ZXJ5UHJvcCA9IHF1ZXJ5UHJvcC5idWlsZCgpO1xuICAgICAgICB9XG5cbiAgICAgICAganNvblttb2RlbENsYXNzLnByb3BlcnR5TmFtZVRvQ29sdW1uTmFtZShrZXkpXSA9IHF1ZXJ5UHJvcDtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICByZXR1cm4ganNvbjtcbn1cblxuZnVuY3Rpb24gZnJvbUpzb25EZWVwKG9iaiwgbW9kZWxDbGFzcywgbW9kZWxPcHRpb25zKSB7XG4gIGNvbnN0IHF1ZXJ5UHJvcHMgPSBuZXcgTWFwKCk7XG5cbiAgY29uc3QgY3R4ID0ge1xuICAgIG1vZGVsT3B0aW9ucyxcbiAgICBxdWVyeVByb3BzXG4gIH07XG5cbiAgY29uc3QgbW9kZWwgPSBzcGxpdERlZXAob2JqLCBtb2RlbENsYXNzLCBjdHgpO1xuXG4gIHJldHVybiB7XG4gICAgbW9kZWwsXG4gICAgcXVlcnlQcm9wc1xuICB9O1xufVxuXG5mdW5jdGlvbiBmcm9tSnNvblNoYWxsb3cob2JqLCBtb2RlbENsYXNzLCBtb2RlbE9wdGlvbnMpIHtcbiAgY29uc3QgcXVlcnlQcm9wcyA9IG5ldyBNYXAoKTtcblxuICBsZXQgbW9kZWw7XG5cbiAgaWYgKEFycmF5LmlzQXJyYXkob2JqKSkge1xuICAgIG1vZGVsID0gb2JqLm1hcChvYmogPT4gZG9TcGxpdChvYmosIG1vZGVsQ2xhc3MsIHF1ZXJ5UHJvcHMsIG1vZGVsT3B0aW9ucykpO1xuICB9IGVsc2Uge1xuICAgIG1vZGVsID0gZG9TcGxpdChvYmosIG1vZGVsQ2xhc3MsIHF1ZXJ5UHJvcHMsIG1vZGVsT3B0aW9ucyk7XG4gIH1cblxuICByZXR1cm4ge1xuICAgIG1vZGVsLFxuICAgIHF1ZXJ5UHJvcHNcbiAgfTtcbn1cblxuZnVuY3Rpb24gc3BsaXREZWVwKG9ianMsIG1vZGVsQ2xhc3MsIGN0eCkge1xuICBpZiAoQXJyYXkuaXNBcnJheShvYmpzKSkge1xuICAgIHJldHVybiBzcGxpdERlZXBNYW55KG9ianMsIG1vZGVsQ2xhc3MsIGN0eCk7XG4gIH0gZWxzZSBpZiAob2Jqcykge1xuICAgIHJldHVybiBzcGxpdERlZXBPbmUob2JqcywgbW9kZWxDbGFzcywgY3R4KTtcbiAgfVxufVxuXG5mdW5jdGlvbiBzcGxpdERlZXBNYW55KG9ianMsIG1vZGVsQ2xhc3MsIGN0eCkge1xuICBjb25zdCBtb2RlbHMgPSBuZXcgQXJyYXkob2Jqcy5sZW5ndGgpO1xuXG4gIGZvciAobGV0IGkgPSAwLCBsID0gb2Jqcy5sZW5ndGg7IGkgPCBsOyArK2kpIHtcbiAgICBtb2RlbHNbaV0gPSBzcGxpdERlZXBPbmUob2Jqc1tpXSwgbW9kZWxDbGFzcywgY3R4KTtcbiAgfVxuXG4gIHJldHVybiBtb2RlbHM7XG59XG5cbmZ1bmN0aW9uIHNwbGl0RGVlcE9uZShvYmosIG1vZGVsQ2xhc3MsIGN0eCkge1xuICBjb25zdCByZWxhdGlvbnMgPSBtb2RlbENsYXNzLmdldFJlbGF0aW9uQXJyYXkoKTtcbiAgY29uc3QgbW9kZWwgPSBkb1NwbGl0KG9iaiwgbW9kZWxDbGFzcywgY3R4LnF1ZXJ5UHJvcHMsIGN0eC5tb2RlbE9wdGlvbnMpO1xuXG4gIGZvciAobGV0IGkgPSAwLCBsID0gcmVsYXRpb25zLmxlbmd0aDsgaSA8IGw7ICsraSkge1xuICAgIGNvbnN0IHJlbGF0aW9uID0gcmVsYXRpb25zW2ldO1xuICAgIGNvbnN0IHJlbGF0ZWRPYmpzID0gb2JqW3JlbGF0aW9uLm5hbWVdO1xuICAgIGNvbnN0IHJlbGF0ZWRNb2RlbENsYXNzID0gcmVsYXRpb24ucmVsYXRlZE1vZGVsQ2xhc3M7XG5cbiAgICBpZiAocmVsYXRlZE9ianMpIHtcbiAgICAgIG1vZGVsW3JlbGF0aW9uLm5hbWVdID0gc3BsaXREZWVwKHJlbGF0ZWRPYmpzLCByZWxhdGVkTW9kZWxDbGFzcywgY3R4KTtcbiAgICB9IGVsc2UgaWYgKHJlbGF0ZWRPYmpzICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIG1vZGVsW3JlbGF0aW9uLm5hbWVdID0gcmVsYXRlZE9ianM7XG4gICAgfVxuICB9XG5cbiAgcmV0dXJuIG1vZGVsO1xufVxuXG5mdW5jdGlvbiBkb1NwbGl0KG9iaiwgbW9kZWxDbGFzcywgcXVlcnlQcm9wcywgbW9kZWxPcHQpIHtcbiAgbGV0IHF1ZXJ5ID0ge307XG4gIGxldCBtb2RlbCA9IHt9O1xuXG4gIGNvbnN0IGtleXMgPSBPYmplY3Qua2V5cyhvYmopO1xuICBjb25zdCByZWxhdGlvbnMgPSBtb2RlbENsYXNzLmdldFJlbGF0aW9ucygpO1xuICBsZXQgaGFzUXVlcmllcyA9IGZhbHNlO1xuXG4gIGZvciAobGV0IGkgPSAwLCBsID0ga2V5cy5sZW5ndGg7IGkgPCBsOyArK2kpIHtcbiAgICBjb25zdCBrZXkgPSBrZXlzW2ldO1xuICAgIGNvbnN0IHZhbHVlID0gb2JqW2tleV07XG5cbiAgICBpZiAocmVsYXRpb25zW2tleV0pIHtcbiAgICAgIGNvbnRpbnVlO1xuICAgIH1cblxuICAgIGlmIChpc1F1ZXJ5UHJvcCh2YWx1ZSkpIHtcbiAgICAgIGhhc1F1ZXJpZXMgPSB0cnVlO1xuICAgICAgcXVlcnlba2V5XSA9IHZhbHVlO1xuICAgIH0gZWxzZSB7XG4gICAgICBtb2RlbFtrZXldID0gdmFsdWU7XG4gICAgfVxuICB9XG5cbiAgbW9kZWwgPSBtb2RlbENsYXNzLmZyb21Kc29uKG1vZGVsLCBtb2RlbE9wdCk7XG5cbiAgaWYgKGhhc1F1ZXJpZXMpIHtcbiAgICBxdWVyeVByb3BzLnNldChtb2RlbCwgcXVlcnkpO1xuICB9XG5cbiAgcmV0dXJuIG1vZGVsO1xufVxuXG5mdW5jdGlvbiBpc1F1ZXJ5UHJvcCh2YWx1ZSkge1xuICByZXR1cm4gaXNLbmV4UXVlcnlCdWlsZGVyKHZhbHVlKVxuICAgIHx8IGlzS25leFJhdyh2YWx1ZSlcbiAgICB8fCB2YWx1ZSBpbnN0YW5jZW9mIFF1ZXJ5QnVpbGRlckJhc2VcbiAgICB8fCB2YWx1ZSBpbnN0YW5jZW9mIFJlZmVyZW5jZUJ1aWxkZXI7XG59XG5cbmZ1bmN0aW9uIGxhenlMb2FkRGVwcygpIHtcbiAgUXVlcnlCdWlsZGVyQmFzZSA9IFF1ZXJ5QnVpbGRlckJhc2UgfHwgcmVxdWlyZVF1ZXJ5QnVpbGRlckJhc2UoKTtcbiAgUmVmZXJlbmNlQnVpbGRlciA9IFJlZmVyZW5jZUJ1aWxkZXIgfHwgcmVxdWlyZVJlZmVyZW5jZUJ1aWxkZXIoKTtcbn1cblxuZnVuY3Rpb24gcmVxdWlyZVF1ZXJ5QnVpbGRlckJhc2UoKSB7XG4gIHJldHVybiByZXF1aXJlKCcuLi9xdWVyeUJ1aWxkZXIvUXVlcnlCdWlsZGVyQmFzZScpLmRlZmF1bHQ7XG59XG5cbmZ1bmN0aW9uIHJlcXVpcmVSZWZlcmVuY2VCdWlsZGVyKCkge1xuICByZXR1cm4gcmVxdWlyZSgnLi4vcXVlcnlCdWlsZGVyL1JlZmVyZW5jZUJ1aWxkZXInKS5kZWZhdWx0O1xufSJdfQ==